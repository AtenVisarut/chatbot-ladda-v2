import logging
import re
from typing import List, Dict, Optional, Tuple
from app.services.services import openai_client, supabase_client
from app.services.memory import add_to_memory, get_conversation_context, get_recommended_products
from app.services.knowledge_base import answer_question_with_knowledge
from app.utils.text_processing import extract_keywords_from_question, post_process_answer
from app.services.product_recommendation import recommend_products_by_intent, hybrid_search_products
from app.services.disease_search import search_diseases_by_text, build_context_from_diseases

logger = logging.getLogger(__name__)

# =============================================================================
# ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏∑‡∏ä/‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä/‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£
# =============================================================================
AGRICULTURE_KEYWORDS = [
    # ‡∏û‡∏∑‡∏ä
    "‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏≠‡πâ‡∏≠‡∏¢", "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", "‡∏°‡∏±‡∏ô‡∏™‡∏±‡∏°‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", "‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤", "‡∏õ‡∏≤‡∏•‡πå‡∏°",
    "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á", "‡∏•‡∏≥‡πÑ‡∏¢", "‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà", "‡πÄ‡∏á‡∏≤‡∏∞", "‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î", "‡∏û‡∏£‡∏¥‡∏Å", "‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®", "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î",
    "‡∏ñ‡∏±‡πà‡∏ß", "‡∏ú‡∏±‡∏Å", "‡∏ú‡∏•‡πÑ‡∏°‡πâ", "‡∏Å‡∏•‡πâ‡∏ß‡∏¢", "‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß", "‡∏™‡πâ‡∏°", "‡∏°‡∏∞‡∏ô‡∏≤‡∏ß", "‡∏ù‡∏£‡∏±‡πà‡∏á", "‡∏ä‡∏°‡∏û‡∏π‡πà",
    # ‡πÇ‡∏£‡∏Ñ/‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    "‡πÇ‡∏£‡∏Ñ", "‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä", "‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ", "‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", "‡πÉ‡∏ö‡∏à‡∏∏‡∏î", "‡∏£‡∏≤‡∏Å‡πÄ‡∏ô‡πà‡∏≤", "‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏ô‡πà‡∏≤", "‡∏ú‡∏•‡πÄ‡∏ô‡πà‡∏≤",
    "‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤", "‡πÅ‡∏ö‡∏Ñ‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢", "‡πÑ‡∏ß‡∏£‡∏±‡∏™", "‡πÅ‡∏°‡∏•‡∏á", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢", "‡∏´‡∏ô‡∏≠‡∏ô", "‡∏î‡πâ‡∏ß‡∏á", "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä",
    "‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏£‡∏≤‡πÅ‡∏õ‡πâ‡∏á", "‡∏£‡∏≤‡∏™‡∏ô‡∏¥‡∏°", "‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™", "‡∏Å‡∏¥‡πà‡∏á‡πÅ‡∏´‡πâ‡∏á", "‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡πÄ‡∏ô‡πà‡∏≤",
    # ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "‡∏£‡∏∞‡∏¢‡∏∞", "‡∏ä‡πà‡∏ß‡∏á", "‡∏õ‡∏•‡∏π‡∏Å", "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß", "‡∏î‡∏π‡πÅ‡∏•", "‡∏ö‡∏≥‡∏£‡∏∏‡∏á", "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á", "‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
    "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏", "‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤", "‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô"
]


def is_agriculture_question(message: str) -> bool:
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡∏û‡∏∑‡∏ä/‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    message_lower = message.lower()
    for keyword in AGRICULTURE_KEYWORDS:
        if keyword in message_lower:
            return True
    return False


# =============================================================================
# Keywords ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå
# =============================================================================
PRODUCT_KEYWORDS = [
    "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡∏¢‡∏≤", "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤", "‡∏¢‡∏≤‡∏Å‡∏≥‡∏à‡∏±‡∏î", "‡∏¢‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
    "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÅ‡∏°‡∏•‡∏á", "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡∏´‡∏ç‡πâ‡∏≤", "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤", "‡∏õ‡∏∏‡πã‡∏¢", "‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô",
    "‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ", "‡∏™‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î", "‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô", "‡∏¢‡∏≤‡∏û‡πà‡∏ô", "‡∏¢‡∏≤‡∏â‡∏µ‡∏î",
    "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≤", "‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£", "‡∏¢‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô", "‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ",
    "icp", "ladda", "‡πÑ‡∏≠‡∏ã‡∏µ‡∏û‡∏µ", "‡∏•‡∏±‡∏î‡∏î‡∏≤"
]

# =============================================================================
# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ICP Ladda (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)
# =============================================================================
ICP_PRODUCT_NAMES = {
    # ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏° -> ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î/‡∏¢‡πà‡∏≠)
    "‡∏Å‡∏∞‡∏£‡∏±‡∏ï": ["‡∏Å‡∏∞‡∏£‡∏±‡∏ï", "‡∏Å‡∏∞‡∏£‡∏±‡∏ï 35"],
    "‡∏Å‡πá‡∏≠‡∏õ‡∏Å‡∏±‡∏ô": ["‡∏Å‡πá‡∏≠‡∏õ‡∏Å‡∏±‡∏ô", "‡∏Å‡∏≠‡∏õ‡∏Å‡∏±‡∏ô", "‡∏ó‡πá‡∏≠‡∏õ‡∏Å‡∏±‡∏ô", "‡∏ó‡∏≠‡∏õ‡∏Å‡∏±‡∏ô"],
    "‡∏Ñ‡∏≤‡∏£‡∏¥‡∏™‡∏°‡∏≤": ["‡∏Ñ‡∏≤‡∏£‡∏¥‡∏™‡∏°‡∏≤", "‡∏Ñ‡∏≤‡∏£‡∏¥‡∏™‡∏°‡πà‡∏≤"],
    "‡∏ã‡∏¥‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå": ["‡∏ã‡∏¥‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå", "‡∏ã‡∏¥‡∏°‡πÄ‡∏°‡∏≠"],
    "‡∏ã‡∏µ‡πÄ‡∏≠‡πá‡∏°‡∏à‡∏µ": ["‡∏ã‡∏µ‡πÄ‡∏≠‡πá‡∏°‡∏à‡∏µ", "cmg", "‡∏ã‡∏µ‡πÄ‡∏≠‡∏°‡∏à‡∏µ"],
    "‡∏ó‡∏π‡πÇ‡∏ü‡∏ü‡∏≠‡∏™": ["‡∏ó‡∏π‡πÇ‡∏ü‡∏ü‡∏≠‡∏™", "‡∏ó‡∏π‡πÇ‡∏ü"],
    "‡∏ô‡∏≤‡πÅ‡∏î‡∏ô": ["‡∏ô‡∏≤‡πÅ‡∏î‡∏ô", "‡∏ô‡∏≤‡πÅ‡∏î‡∏ô 6 ‡∏à‡∏µ", "‡∏ô‡∏≤‡πÅ‡∏î‡∏ô-‡∏à‡∏µ"],
    "‡∏ö‡∏•‡∏π‡πÑ‡∏ß‡∏ó‡πå": ["‡∏ö‡∏•‡∏π‡πÑ‡∏ß‡∏ó‡πå", "‡∏ö‡∏•‡∏π‡πÑ‡∏ß‡∏ï‡πå"],
    "‡∏û‡∏£‡∏µ‡∏î‡∏¥‡∏Ñ‡∏ó‡πå": ["‡∏û‡∏£‡∏µ‡∏î‡∏¥‡∏Ñ‡∏ó‡πå", "‡∏û‡∏£‡∏µ‡∏î‡∏¥‡∏Ñ", "predict"],
    "‡∏û‡∏≤‡∏™‡∏ô‡∏≤‡∏ß": ["‡∏û‡∏≤‡∏™‡∏ô‡∏≤‡∏ß", "‡∏û‡∏≤‡∏™‡∏ô‡∏≤‡∏ß‡πå"],
    "‡∏û‡∏≤‡∏ô‡∏≤‡∏™": ["‡∏û‡∏≤‡∏ô‡∏≤‡∏™", "‡πÄ‡∏•‡∏Å‡∏≤‡∏ã‡∏µ 20 + ‡∏û‡∏≤‡∏ô‡∏≤‡∏™"],
    "‡∏£‡∏≤‡πÄ‡∏ã‡∏≠‡∏£‡πå": ["‡∏£‡∏≤‡πÄ‡∏ã‡∏≠‡∏£‡πå", "‡πÄ‡∏£‡πÄ‡∏ã‡∏≠‡∏£‡πå"],
    "‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó": ["‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó", "‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ï", "renovate"],
    "‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏£‡∏ô‡∏ï‡πå": ["‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏£‡∏ô‡∏ï‡πå", "‡∏ß‡∏≠‡πÅ‡∏£‡∏ô‡∏ï‡πå", "warrant"],
    "‡∏≠‡∏∞‡∏ô‡∏¥‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î": ["‡∏≠‡∏∞‡∏ô‡∏¥‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î", "‡∏≠‡∏ô‡∏¥‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î"],
    "‡∏≠‡∏±‡∏û‡∏î‡∏≤‡∏ß": ["‡∏≠‡∏±‡∏û‡∏î‡∏≤‡∏ß", "‡∏≠‡∏±‡∏õ‡∏î‡∏≤‡∏ß"],
    "‡∏≠‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏ô": ["‡∏≠‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏ô", "‡∏≠‡∏≤‡∏î‡∏≠‡∏ô"],
    "‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏°‡∏µ‡∏™": ["‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏°‡∏µ‡∏™", "‡∏≠‡∏≤‡πÄ‡∏ó‡∏°‡∏¥‡∏™", "‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏°‡∏¥‡∏™", "artemis"],
    "‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•‡∏î‡πå": ["‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•‡∏î‡πå", "‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤", "‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•", "imidagold"],
    "‡πÄ‡∏Å‡∏£‡∏Ñ": ["‡πÄ‡∏Å‡∏£‡∏Ñ", "‡πÄ‡∏Å‡∏£‡∏Ñ 5 ‡πÄ‡∏≠‡∏™‡∏ã‡∏µ"],
    "‡πÄ‡∏Ñ‡πÄ‡∏ã‡∏µ‡∏¢": ["‡πÄ‡∏Ñ‡πÄ‡∏ã‡∏µ‡∏¢", "‡πÄ‡∏Ñ‡πÄ‡∏ã‡∏µ‡∏¢‡πå"],
    "‡πÄ‡∏ó‡∏≠‡∏£‡∏≤‡πÇ‡∏ô‡πà": ["‡πÄ‡∏ó‡∏≠‡∏£‡∏≤‡πÇ‡∏ô‡πà", "‡πÄ‡∏ó‡∏≠‡∏£‡∏≤‡πÇ‡∏ô", "terano"],
    "‡πÄ‡∏ö‡∏ô‡∏ã‡∏≤‡∏ô‡πà‡∏≤": ["‡πÄ‡∏ö‡∏ô‡∏ã‡∏≤‡∏ô‡πà‡∏≤", "‡πÄ‡∏ö‡∏ô‡∏ã‡∏≤‡∏ô‡πà‡∏≤ ‡πÄ‡∏≠‡∏ü"],
    "‡πÄ‡∏°‡∏•‡∏™‡∏±‡∏ô": ["‡πÄ‡∏°‡∏•‡∏™‡∏±‡∏ô", "‡πÄ‡∏°‡∏•‡∏ã‡∏±‡∏ô"],
    "‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå": ["‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠"],
    "‡πÅ‡∏à‡πä‡∏™": ["‡πÅ‡∏à‡πä‡∏™", "‡πÅ‡∏à‡∏™", "jazz"],
    "‡πÅ‡∏°‡∏™‡∏ü‡∏≠‡∏£‡πå‡∏î": ["‡πÅ‡∏°‡∏™‡∏ü‡∏≠‡∏£‡πå‡∏î", "‡πÅ‡∏°‡∏™‡∏ü‡∏≠‡∏î"],
    "‡πÅ‡∏≠‡∏ô‡∏î‡∏≤‡πÅ‡∏°‡πá‡∏Å‡∏ã‡πå": ["‡πÅ‡∏≠‡∏ô‡∏î‡∏≤‡πÅ‡∏°‡πá‡∏Å‡∏ã‡πå", "‡πÅ‡∏≠‡∏ô‡∏î‡∏≤‡πÅ‡∏°‡∏Å‡∏ã‡πå", "‡πÅ‡∏≠‡∏ô‡∏î‡∏≤‡πÅ‡∏°‡πá‡∏Å", "andamax"],
    "‡πÅ‡∏≠‡∏™‡πÑ‡∏õ‡∏£‡πå": ["‡πÅ‡∏≠‡∏™‡πÑ‡∏õ‡∏£‡πå", "‡πÅ‡∏≠‡∏™‡πÑ‡∏õ‡∏£", "aspire"],
    "‡πÇ‡∏Ñ-‡∏£‡∏≤‡∏ã": ["‡πÇ‡∏Ñ-‡∏£‡∏≤‡∏ã", "‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ã"],
    "‡πÇ‡∏Ñ‡πÄ‡∏ö‡∏¥‡∏•": ["‡πÇ‡∏Ñ‡πÄ‡∏ö‡∏¥‡∏•", "‡πÇ‡∏Ñ‡πÄ‡∏ö‡∏¥‡πâ‡∏•"],
    "‡πÇ‡∏ã‡∏ô‡∏¥‡∏Å": ["‡πÇ‡∏ã‡∏ô‡∏¥‡∏Å", "sonic"],
    "‡πÇ‡∏ó‡∏°‡∏≤‡∏Æ‡∏≠‡∏Ñ": ["‡πÇ‡∏ó‡∏°‡∏≤‡∏Æ‡∏≠‡∏Ñ", "‡πÇ‡∏ó‡∏°‡∏≤‡∏Æ‡∏≠‡∏Å", "tomahawk"],
    "‡πÇ‡∏°-‡πÄ‡∏ã‡πà": ["‡πÇ‡∏°-‡πÄ‡∏ã‡πà", "‡πÇ‡∏°‡πÄ‡∏ã‡πà", "‡πÇ‡∏°‡πÄ‡∏ã"],
    "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô": ["‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô", "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50"],
    "‡πÇ‡∏Æ‡∏õ": ["‡πÇ‡∏Æ‡∏õ", "hope"],
    "‡πÑ‡∏ã‡∏°‡πä‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏°‡∏ó": ["‡πÑ‡∏ã‡∏°‡πä‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏°‡∏ó", "‡πÑ‡∏ã‡∏°‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏°‡∏ó", "cymoximate"],
    "‡πÑ‡∏î‡πÅ‡∏û‡πä‡∏Å‡∏ã‡πå": ["‡πÑ‡∏î‡πÅ‡∏û‡πä‡∏Å‡∏ã‡πå", "‡πÑ‡∏î‡πÅ‡∏û‡∏Å‡∏ã‡πå"],
    "‡πÑ‡∏û‡∏£‡∏ã‡∏µ‡∏ô": ["‡πÑ‡∏û‡∏£‡∏ã‡∏µ‡∏ô", "‡πÑ‡∏û‡∏£‡∏ã‡∏¥‡∏ô"],
    "‡πÑ‡∏Æ‡∏ã‡∏µ‡∏™": ["‡πÑ‡∏Æ‡∏ã‡∏µ‡∏™", "‡πÑ‡∏Æ‡∏ã‡∏¥‡∏™", "hysis"],
    "‡∏ä‡∏∏‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á": ["‡∏ä‡∏∏‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á", "‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á"],
    "‡πÄ‡∏•‡∏Å‡∏≤‡∏ã‡∏µ": ["‡πÄ‡∏•‡∏Å‡∏≤‡∏ã‡∏µ", "legacy"],
}


def extract_product_name_from_question(question: str) -> Optional[str]:
    """
    ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    Returns: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    """
    question_lower = question.lower()

    for product_name, aliases in ICP_PRODUCT_NAMES.items():
        for alias in aliases:
            if alias.lower() in question_lower:
                return product_name

    return None


def extract_plant_type_from_question(question: str) -> Optional[str]:
    """
    ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    Returns: ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    """
    # ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
    plants = [
        "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î", "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", "‡∏≠‡πâ‡∏≠‡∏¢", "‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤", "‡∏õ‡∏≤‡∏•‡πå‡∏°",
        "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á", "‡∏•‡∏≥‡πÑ‡∏¢", "‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà", "‡πÄ‡∏á‡∏≤‡∏∞", "‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î", "‡∏û‡∏£‡∏¥‡∏Å", "‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®",
        "‡∏ñ‡∏±‡πà‡∏ß", "‡∏Å‡∏•‡πâ‡∏ß‡∏¢", "‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß", "‡∏™‡πâ‡∏°", "‡∏°‡∏∞‡∏ô‡∏≤‡∏ß", "‡∏ù‡∏£‡∏±‡πà‡∏á", "‡∏ä‡∏°‡∏û‡∏π‡πà",
        "‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î", "‡∏´‡∏≠‡∏°‡πÅ‡∏î‡∏á", "‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", "‡∏ú‡∏±‡∏Å", "‡πÑ‡∏°‡πâ‡∏ú‡∏•"
    ]

    question_lower = question.lower()
    for plant in plants:
        if plant in question_lower:
            return plant
    return None


def validate_knowledge_results(results: List[Dict], product_name: str, plant_type: str = None) -> List[Dict]:
    """
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ prioritize ‡∏ï‡∏≤‡∏° plant type
    """
    if not product_name or not results:
        return results

    product_lower = product_name.lower()
    aliases = ICP_PRODUCT_NAMES.get(product_name, [product_name])

    # ‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á
    matched = []
    for r in results:
        title = (r.get('title') or '').lower()
        content = (r.get('content') or '').lower()

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô title ‡∏´‡∏£‡∏∑‡∏≠ content
        for alias in aliases:
            if alias.lower() in title or alias.lower() in content:
                matched.append(r)
                break

    # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ plant_type ‚Üí ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á plant ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î
    if plant_type and matched:
        plant_lower = plant_type.lower()
        # ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Å‡∏•‡∏∏‡πà‡∏°: ‡∏ï‡∏£‡∏á plant vs ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
        with_plant = []
        without_plant = []
        for r in matched:
            title = (r.get('title') or '').lower()
            if plant_lower in title:
                with_plant.append(r)
            else:
                without_plant.append(r)

        # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á plant ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ô‡∏±‡πâ‡∏ô
        if with_plant:
            return with_plant
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà match product
        return without_plant if without_plant else matched

    return matched


def is_product_question(message: str) -> bool:
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    message_lower = message.lower()
    for keyword in PRODUCT_KEYWORDS:
        if keyword in message_lower:
            return True
    return False


# =============================================================================
# ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ‡πÇ‡∏£‡∏Ñ vs ‡πÅ‡∏°‡∏•‡∏á
# =============================================================================
DISEASE_KEYWORDS = [
    # ‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "‡πÇ‡∏£‡∏Ñ", "‡πÉ‡∏ö‡∏à‡∏∏‡∏î", "‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ", "‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏£‡∏≤‡πÅ‡∏õ‡πâ‡∏á", "‡∏£‡∏≤‡∏™‡∏ô‡∏¥‡∏°", "‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤",
    "‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™", "‡∏ú‡∏•‡πÄ‡∏ô‡πà‡∏≤", "‡∏£‡∏≤‡∏Å‡πÄ‡∏ô‡πà‡∏≤", "‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏ô‡πà‡∏≤", "‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡πÄ‡∏ô‡πà‡∏≤", "‡∏Å‡∏¥‡πà‡∏á‡πÅ‡∏´‡πâ‡∏á",
    "‡∏£‡∏≤‡∏î‡∏≥", "‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", "‡πÉ‡∏ö‡∏£‡πà‡∏ß‡∏á", "‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•", "‡πÉ‡∏ö‡πÅ‡∏´‡πâ‡∏á",
    # English
    "disease", "fungus", "fungal", "rot", "blight", "mildew", "rust", "anthracnose"
]

INSECT_KEYWORDS = [
    # ‡πÅ‡∏°‡∏•‡∏á
    "‡πÅ‡∏°‡∏•‡∏á", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢", "‡∏´‡∏ô‡∏≠‡∏ô", "‡∏î‡πâ‡∏ß‡∏á", "‡∏°‡∏î", "‡∏õ‡∏•‡∏ß‡∏Å", "‡πÑ‡∏£", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü",
    "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏≠‡πà‡∏≠‡∏ô", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÅ‡∏õ‡πâ‡∏á", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î", "‡∏´‡∏ô‡∏≠‡∏ô‡∏Å‡∏≠", "‡∏´‡∏ô‡∏≠‡∏ô‡πÄ‡∏à‡∏≤‡∏∞",
    "‡∏´‡∏ô‡∏≠‡∏ô‡πÉ‡∏¢", "‡πÅ‡∏°‡∏•‡∏á‡∏ß‡∏±‡∏ô", "‡∏à‡∏±‡∏Å‡∏à‡∏±‡πà‡∏ô", "‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡πå", "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä",
    # English
    "insect", "pest", "aphid", "thrips", "mite", "worm", "caterpillar", "beetle"
]


def detect_problem_type(message: str) -> str:
    """
    ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤: disease (‡πÇ‡∏£‡∏Ñ) ‡∏´‡∏£‡∏∑‡∏≠ insect (‡πÅ‡∏°‡∏•‡∏á)
    Returns: 'disease', 'insect', ‡∏´‡∏£‡∏∑‡∏≠ 'unknown'
    """
    message_lower = message.lower()

    disease_count = sum(1 for kw in DISEASE_KEYWORDS if kw in message_lower)
    insect_count = sum(1 for kw in INSECT_KEYWORDS if kw in message_lower)

    if disease_count > insect_count:
        return 'disease'
    elif insect_count > disease_count:
        return 'insect'
    else:
        return 'unknown'


# =============================================================================
# Vector Search Functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Q&A
# =============================================================================
async def generate_embedding(text: str) -> List[float]:
    """Generate embedding for search query using OpenAI"""
    if not openai_client:
        logger.error("OpenAI client not available")
        return []

    try:
        response = await openai_client.embeddings.create(
            model="text-embedding-3-small",
            input=text,
            encoding_format="float"
        )
        return response.data[0].embedding
    except Exception as e:
        logger.error(f"Failed to generate embedding: {e}")
        return []


async def vector_search_knowledge(query: str, top_k: int = 5, validate_product: bool = True, problem_type: str = None) -> Tuple[List[Dict], Optional[str]]:
    """
    Vector search ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á knowledge ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° category

    Args:
        query: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
        top_k: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
        validate_product: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        problem_type: 'disease', 'insect', ‡∏´‡∏£‡∏∑‡∏≠ None

    Returns:
        Tuple[results, product_not_found_message]
    """
    if not supabase_client or not openai_client:
        return [], None

    try:
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô ‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡∏ä‡∏≠‡∏∞‡πÑ‡∏£
        product_in_question = extract_product_name_from_question(query) if validate_product else None
        plant_in_question = extract_plant_type_from_question(query) if validate_product else None

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏
        if problem_type is None:
            problem_type = detect_problem_type(query)

        query_embedding = await generate_embedding(query)
        if not query_embedding:
            return [], None

        result = supabase_client.rpc(
            'match_knowledge',
            {
                'query_embedding': query_embedding,
                'match_threshold': 0.20,
                'match_count': top_k * 10  # ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° category
            }
        ).execute()

        if not result.data:
            if product_in_question:
                return [], f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö \"{product_in_question}\" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
            return [], None

        logger.info(f"‚úì Found {len(result.data)} knowledge docs via vector search (problem_type={problem_type})")

        # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° category (disease vs insect)
        filtered_results = result.data
        if problem_type == 'disease':
            # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ category ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà insecticide)
            disease_categories = ['fungicide', '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÇ‡∏£‡∏Ñ', '‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ', '‡∏¢‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ']
            insect_categories = ['insecticide', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á', '‡∏™‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á', '‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÅ‡∏°‡∏•‡∏á']

            filtered = []
            for doc in result.data:
                category = (doc.get('category') or '').lower()
                target_pest = (doc.get('target_pest') or '').lower()

                # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ category ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà insecticide
                is_insecticide = any(cat in category for cat in insect_categories)
                if not is_insecticide:
                    filtered.append(doc)

            if filtered:
                filtered_results = filtered
                logger.info(f"‚úì Filtered to {len(filtered_results)} disease-related docs")

        elif problem_type == 'insect':
            # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ category ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÅ‡∏°‡∏•‡∏á
            insect_categories = ['insecticide', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á', '‡∏™‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á', '‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÅ‡∏°‡∏•‡∏á']

            filtered = []
            for doc in result.data:
                category = (doc.get('category') or '').lower()

                is_insecticide = any(cat in category for cat in insect_categories)
                if is_insecticide:
                    filtered.append(doc)

            if filtered:
                filtered_results = filtered
                logger.info(f"‚úì Filtered to {len(filtered_results)} insect-related docs")

        # ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if product_in_question:
            validated_results = validate_knowledge_results(filtered_results, product_in_question, plant_in_question)

            if not validated_results:
                logger.warning(f"‚ö†Ô∏è ‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö '{product_in_question}' ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á")
                return [], f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö \"{product_in_question}\" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"

            logger.info(f"‚úì Validated: {len(validated_results)} results match product '{product_in_question}'")
            return validated_results[:top_k], None

        # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° plant_type ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if plant_in_question:
            plant_filtered = []
            for doc in filtered_results:
                plant_type = (doc.get('plant_type') or '').lower()
                title = (doc.get('title') or '').lower()
                if plant_in_question.lower() in plant_type or plant_in_question.lower() in title:
                    plant_filtered.append(doc)

            if plant_filtered:
                filtered_results = plant_filtered
                logger.info(f"‚úì Filtered to {len(filtered_results)} docs for plant '{plant_in_question}'")

        return filtered_results[:top_k], None

    except Exception as e:
        logger.error(f"Knowledge vector search failed: {e}")
        return [], None


async def vector_search_products(query: str, top_k: int = 5) -> List[Dict]:
    """Vector search ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á products"""
    try:
        # ‡πÉ‡∏ä‡πâ hybrid_search_products ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        products = await hybrid_search_products(
            query=query,
            match_count=top_k,
            vector_weight=0.6,
            keyword_weight=0.4
        )
        if products:
            logger.info(f"‚úì Found {len(products)} products via vector search")
        return products or []
    except Exception as e:
        logger.error(f"Product vector search failed: {e}")
        return []


async def answer_qa_with_vector_search(question: str, context: str = "") -> str:
    """
    ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Q&A ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Vector Search ‡∏à‡∏≤‡∏Å knowledge table ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° category (‡πÇ‡∏£‡∏Ñ vs ‡πÅ‡∏°‡∏•‡∏á)
    """
    try:
        logger.info(f"Q&A Vector Search: {question[:50]}...")

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô
        is_product_q = is_product_question(question)
        is_agri_q = is_agriculture_question(question)

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡πÇ‡∏£‡∏Ñ vs ‡πÅ‡∏°‡∏•‡∏á)
        problem_type = detect_problem_type(question)
        plant_in_question = extract_plant_type_from_question(question)
        product_in_question = extract_product_name_from_question(question)

        logger.info(f"Detected: problem_type={problem_type}, plant={plant_in_question}, product={product_in_question}")

        # ‡πÄ‡∏Å‡πá‡∏ö context ‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ source
        all_context_parts = []

        # 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å knowledge table ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° category)
        knowledge_docs, product_not_found_msg = await vector_search_knowledge(
            question,
            top_k=5,
            validate_product=True,
            problem_type=problem_type
        )

        if knowledge_docs:
            knowledge_context = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:\n"
            for idx, doc in enumerate(knowledge_docs[:5], 1):
                title = doc.get('title', '')
                content = doc.get('content', '')[:400]
                product_name = doc.get('product_name', '')
                usage_rate = doc.get('usage_rate', '')
                target_pest = doc.get('target_pest', '')
                category = doc.get('category', '')

                knowledge_context += f"\n[{idx}] {title}"
                if product_name:
                    knowledge_context += f"\n   ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {product_name}"
                if category:
                    knowledge_context += f"\n   ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {category}"
                if target_pest:
                    knowledge_context += f"\n   ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏à‡∏±‡∏î: {target_pest[:100]}"
                if usage_rate:
                    knowledge_context += f"\n   ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: {usage_rate}"
                knowledge_context += f"\n   ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {content}"

            all_context_parts.append(knowledge_context)
            logger.info(f"Added {len(knowledge_docs)} knowledge docs to context")

        elif product_not_found_msg:
            logger.warning(f"Product not found: {product_not_found_msg}")
            all_context_parts.append(f"‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: {product_not_found_msg}")

        # 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å diseases (‡πÄ‡∏™‡∏£‡∏¥‡∏° - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ)
        if is_agri_q and problem_type == 'disease':
            diseases = await search_diseases_by_text(question, top_k=2)
            if diseases:
                disease_context = build_context_from_diseases(diseases)
                all_context_parts.append(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ:\n{disease_context}")
                logger.info(f"Added {len(diseases)} diseases to context")

        # ‡∏£‡∏ß‡∏° context ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        combined_context = "\n\n".join(all_context_parts) if all_context_parts else "(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)"

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI
        prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}

‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:
{context if context else "(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà)"}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
{combined_context}

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):

‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢:

[‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/‡∏õ‡∏±‡∏ç‡∏´‡∏≤]
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ 1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ

[‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥]
1. ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: XX ‡∏ã‡∏µ‡∏ã‡∏µ/‡∏ô‡πâ‡∏≥ XX ‡∏•‡∏¥‡∏ï‡∏£
   - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô/‡∏£‡∏≤‡∏î...

2. ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: ...

[‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ]
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î

[‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°]
‡∏ö‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ

[‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°]
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:
- ‡πÉ‡∏ä‡πâ [‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠] ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡πÉ‡∏ä‡πâ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡πà‡∏≠‡∏¢
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ó‡∏∏‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ##

‡∏ï‡∏≠‡∏ö:"""

        if not openai_client:
            return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ"

        response = await openai_client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": """‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤ ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÅ‡∏¢‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏î‡πâ‡∏ß‡∏¢ [‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠]
- ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö 1. 2. 3. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
- ‡πÉ‡∏ä‡πâ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡πà‡∏≠‡∏¢ (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ, ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ)
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ## ‡∏´‡∏£‡∏∑‡∏≠ emoji
- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ"""},
                {"role": "user", "content": prompt}
            ],
            max_tokens=800,
            temperature=0.6
        )

        answer = post_process_answer(response.choices[0].message.content)
        return answer

    except Exception as e:
        logger.error(f"Error in Q&A vector search: {e}", exc_info=True)
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞"


async def answer_agriculture_question(question: str, context: str = "") -> str:
    """
    ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡∏û‡∏∑‡∏ä/‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä
    1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á diseases ‡∏Å‡πà‡∏≠‡∏ô (vector search)
    2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö ‚Üí ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ + ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏£‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£
    """
    try:
        logger.info(f"üåæ Agriculture question: {question[:50]}...")

        # 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á diseases
        diseases = await search_diseases_by_text(question, top_k=5)

        if diseases:
            # ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á context ‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏û‡∏ö
            disease_context = build_context_from_diseases(diseases)
            logger.info(f"‚úì Found {len(diseases)} related diseases in database")

            prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}

‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:
{context if context else "(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà)"}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
{disease_context}

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):

‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢:

[‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/‡∏õ‡∏±‡∏ç‡∏´‡∏≤]
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ

[‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö]
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö

[‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥]
1. ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: XX ‡∏ã‡∏µ‡∏ã‡∏µ/‡∏ô‡πâ‡∏≥ XX ‡∏•‡∏¥‡∏ï‡∏£
   - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô/‡∏£‡∏≤‡∏î...

2. ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: ...

[‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ]
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô

[‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°]
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡πÜ

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:
- ‡πÉ‡∏ä‡πâ [‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠] ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡πÉ‡∏ä‡πâ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡πà‡∏≠‡∏¢
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ó‡∏∏‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ## ‡∏´‡∏£‡∏∑‡∏≠ emoji

‡∏ï‡∏≠‡∏ö:"""
        else:
            # ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ + ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏£‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£
            logger.info("‚ö†Ô∏è No diseases found in database, using general knowledge")

            prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}

‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:
{context if context else "(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà)"}

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):

‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô:

[‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö]
‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å

[‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î]
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

[‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥]
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:
- ‡πÉ‡∏ä‡πâ [‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠] ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ## ‡∏´‡∏£‡∏∑‡∏≠ emoji

‡∏ï‡∏≠‡∏ö:"""

        if not openai_client:
            return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ"

        response = await openai_client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": """‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤ ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÅ‡∏¢‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏î‡πâ‡∏ß‡∏¢ [‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠]
- ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö 1. 2. 3. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
- ‡πÉ‡∏ä‡πâ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡πà‡∏≠‡∏¢ (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ, ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ)
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ## ‡∏´‡∏£‡∏∑‡∏≠ emoji
- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ"""},
                {"role": "user", "content": prompt}
            ],
            max_tokens=800,
            temperature=0.6
        )

        answer = post_process_answer(response.choices[0].message.content)
        return answer

    except Exception as e:
        logger.error(f"Error answering agriculture question: {e}", exc_info=True)
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞"


# =============================================================================
# ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏Å‡∏≤‡∏£‡∏û‡πà‡∏ô‡∏¢‡∏≤ / ‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î
# =============================================================================
USAGE_QUESTION_PATTERNS = [
    # ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    r"‡∏ß‡∏¥‡∏ò‡∏µ(?:‡πÉ‡∏ä‡πâ|‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡∏ú‡∏™‡∏°)",
    r"‡πÉ‡∏ä‡πâ(?:‡∏¢‡∏±‡∏á|‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)",
    r"‡∏û‡πà‡∏ô(?:‡∏¢‡∏±‡∏á|‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)",
    r"‡∏â‡∏µ‡∏î(?:‡∏¢‡∏±‡∏á|‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)",
    r"‡∏ú‡∏™‡∏°(?:‡∏¢‡∏±‡∏á|‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)",
    # ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô
    r"‡∏≠‡∏±‡∏ï‡∏£‡∏≤(?:‡πÉ‡∏ä‡πâ|‡∏ú‡∏™‡∏°|‡∏™‡πà‡∏ß‡∏ô)",
    r"‡∏ú‡∏™‡∏°(?:‡∏Å‡∏µ‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£)",
    r"‡πÉ‡∏ä‡πâ(?:‡∏Å‡∏µ‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£)",
    # ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    r"(?:‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡πÉ‡∏ä‡πâ)(?:‡∏ï‡∏≠‡∏ô|‡πÄ‡∏°‡∏∑‡πà‡∏≠|‡∏ä‡πà‡∏ß‡∏á)",
    r"(?:‡∏ï‡∏≠‡∏ô|‡πÄ‡∏°‡∏∑‡πà‡∏≠|‡∏ä‡πà‡∏ß‡∏á)(?:‡πÑ‡∏´‡∏ô|‡πÉ‡∏î).*(?:‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡πÉ‡∏ä‡πâ)",
    # ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞
    r"(?:‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)?(?:‡∏ß‡∏¥‡∏ò‡∏µ|‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô).*(?:‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡πÉ‡∏ä‡πâ|‡∏£‡∏±‡∏Å‡∏©‡∏≤)",
    r"(?:‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î).*(?:‡∏Å‡∏µ‡πà|‡∏ö‡πà‡∏≠‡∏¢|‡∏ñ‡∏µ‡πà)",
    r"(?:‡∏•‡∏∞‡∏•‡∏≤‡∏¢|‡πÄ‡∏à‡∏∑‡∏≠‡∏à‡∏≤‡∏á).*(?:‡∏ô‡πâ‡∏≥|‡∏¢‡∏±‡∏á)",
    # ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
    r"(?:‡∏ï‡∏±‡∏ß)?(?:‡∏ô‡∏µ‡πâ|‡∏ô‡∏±‡πâ‡∏ô|‡πÅ‡∏£‡∏Å|‡∏ó‡∏µ‡πà\d).*(?:‡πÉ‡∏ä‡πâ|‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î)",
    r"(?:‡πÉ‡∏ä‡πâ|‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î).*(?:‡∏ï‡∏±‡∏ß)?(?:‡∏ô‡∏µ‡πâ|‡∏ô‡∏±‡πâ‡∏ô|‡πÅ‡∏£‡∏Å|‡∏ó‡∏µ‡πà\d)",
]


def is_usage_question(message: str) -> bool:
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    message_lower = message.lower()
    for pattern in USAGE_QUESTION_PATTERNS:
        if re.search(pattern, message_lower):
            return True
    return False


async def answer_usage_question(user_id: str, message: str, context: str = "") -> str:
    """
    ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô memory
    """
    try:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        products = await get_recommended_products(user_id, limit=5)

        if not products:
            return None  # ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô memory ‚Üí ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ flow ‡∏õ‡∏Å‡∏ï‡∏¥

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI
        products_text = ""
        for idx, p in enumerate(products, 1):
            products_text += f"\n[{idx}] {p.get('product_name', 'N/A')}"
            if p.get('how_to_use'):
                products_text += f"\n   ‚Ä¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: {p.get('how_to_use')}"
            if p.get('usage_rate'):
                products_text += f"\n   ‚Ä¢ ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: {p.get('usage_rate')}"
            if p.get('usage_period'):
                products_text += f"\n   ‚Ä¢ ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ: {p.get('usage_period')}"
            if p.get('target_pest'):
                products_text += f"\n   ‚Ä¢ ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏à‡∏±‡∏î: {p.get('target_pest')[:100]}"
            if p.get('applicable_crops'):
                products_text += f"\n   ‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä: {p.get('applicable_crops')[:100]}"
            products_text += "\n"

        prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä‡∏à‡∏≤‡∏Å ICP Ladda

‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:
{products_text}

‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤:
{context if context else "(‡πÑ‡∏°‡πà‡∏°‡∏µ)"}

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {message}

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):

‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏ä‡πâ [‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠] ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á:

[‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå]
‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤

[‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ]
1. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1
2. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2
3. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3

[‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏™‡∏°]
- ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: XX ‡∏ã‡∏µ‡∏ã‡∏µ/‡∏ô‡πâ‡∏≥ XX ‡∏•‡∏¥‡∏ï‡∏£

[‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°]
‡∏ö‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏û‡πà‡∏ô/‡∏â‡∏µ‡∏î

[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á]
- ‡πÉ‡∏™‡πà‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠ ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
- ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:
- ‡πÉ‡∏ä‡πâ [‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠] ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡πÉ‡∏ä‡πâ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡πà‡∏≠‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ## ‡∏´‡∏£‡∏∑‡∏≠ emoji

‡∏ï‡∏≠‡∏ö:"""

        if not openai_client:
            # Fallback: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
            response = "[‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥]\n"
            for idx, p in enumerate(products[:3], 1):
                response += f"\n{idx}. {p.get('product_name', 'N/A')}"
                if p.get('how_to_use'):
                    response += f"\n   - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: {p.get('how_to_use')}"
                if p.get('usage_rate'):
                    response += f"\n   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: {p.get('usage_rate')}"
            response += "\n\n[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á]\n‡∏≠‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞"
            return response

        response = await openai_client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": """‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÅ‡∏¢‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏ß‡∏¢ [‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠]
- ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö 1. 2. 3. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
- ‡πÉ‡∏ä‡πâ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡πà‡∏≠‡∏¢
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ## ‡∏´‡∏£‡∏∑‡∏≠ emoji"""},
                {"role": "user", "content": prompt}
            ],
            max_tokens=600,
            temperature=0.3
        )

        answer = response.choices[0].message.content.strip()
        answer = answer.replace("**", "").replace("##", "").replace("```", "")

        # ‡πÄ‡∏û‡∏¥‡πà‡∏° footer
        answer += "\n\n‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞"

        logger.info(f"‚úì Answered usage question from memory products")
        return answer

    except Exception as e:
        logger.error(f"Error answering usage question: {e}", exc_info=True)
        return None

async def handle_natural_conversation(user_id: str, message: str) -> str:
    """Handle natural conversation with context and intent detection"""
    try:
        # 1. Add user message to memory
        await add_to_memory(user_id, "user", message)

        # 2. Get conversation context
        context = await get_conversation_context(user_id)

        # 3. Check if this is a usage/application question (‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ/‡∏û‡πà‡∏ô/‡∏â‡∏µ‡∏î)
        if is_usage_question(message):
            logger.info(f"üîß Detected usage question: {message[:50]}...")
            usage_answer = await answer_usage_question(user_id, message, context)
            if usage_answer:
                # Add assistant response to memory
                await add_to_memory(user_id, "assistant", usage_answer)
                return usage_answer
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô memory ‚Üí ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ flow ‡∏õ‡∏Å‡∏ï‡∏¥
            logger.info("No products in memory, falling back to normal flow")

        # 4. Analyze intent and keywords
        keywords = extract_keywords_from_question(message)

        # 5. Route based on intent
        # Priority 1: Q&A ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÇ‡∏£‡∏Ñ ‚Üí Vector Search ‡∏à‡∏≤‡∏Å 3 tables
        is_agri_q = is_agriculture_question(message) or keywords["pests"] or keywords["crops"]
        is_prod_q = is_product_question(message) or keywords["is_product_query"]
        is_fert_q = keywords.get("is_fertilizer_query", False)

        if is_agri_q or is_prod_q or is_fert_q:
            logger.info(f"üîç Routing to Q&A Vector Search (agri={is_agri_q}, product={is_prod_q}, fertilizer={is_fert_q})")
            answer = await answer_qa_with_vector_search(message, context)

            # Track analytics if product recommendation
            if is_prod_q:
                from app.services.services import analytics_tracker
                if analytics_tracker:
                    product_pattern = r'\d+\.\s+([^\n]+?)(?:\n|$)'
                    product_matches = re.findall(product_pattern, answer)
                    product_names = []
                    for match in product_matches:
                        clean_name = match.split('\n')[0].strip()
                        clean_name = clean_name.replace('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå:', '').strip()
                        if clean_name and len(clean_name) > 3:
                            product_names.append(clean_name)
                    if product_names:
                        await analytics_tracker.track_product_recommendation(
                            user_id=user_id,
                            disease_name="Q&A",
                            products=product_names[:5]
                        )
                        logger.info(f"Tracked {len(product_names)} products from Q&A")

            # Add assistant response to memory
            await add_to_memory(user_id, "assistant", answer)
            return answer
            
        else:
            logger.info("Routing to general chat")
            # General conversation with persona - Enhanced for natural conversation

            system_prompt = """‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" üåæ ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏à‡∏≤‡∏Å ICP Ladda

üé≠ **‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û:**
- ‡∏≠‡∏≤‡∏¢‡∏∏‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 25-28 ‡∏õ‡∏µ ‡∏™‡∏≤‡∏ß‡πÉ‡∏à‡∏î‡∏µ ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏á‡πà‡∏≤‡∏¢
- ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å (‡∏≠‡∏µ‡∏™‡∏≤‡∏ô) ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏°‡∏≤
- ‡∏ä‡∏≠‡∏ö‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û (‡∏Ñ‡πà‡∏∞, ‡∏Ñ‡∏∞, ‡∏ô‡∏∞‡∏Ñ‡∏∞)
- ‡∏°‡∏µ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏±‡∏ô ‡∏ä‡∏≠‡∏ö‡∏´‡∏¢‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡πÄ‡∏ö‡∏≤‡πÜ
- ‡πÉ‡∏™‡πà‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
- ‡πÉ‡∏ä‡πâ emoji ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (1-2 ‡∏ï‡∏±‡∏ß‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)

üåø **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç:**
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ ‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä,‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏∑‡∏ä 
- ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå ICP Ladda (‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÅ‡∏°‡∏•‡∏á, ‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤, ‡∏õ‡∏∏‡πã‡∏¢)
- ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢

üìù **‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏≠‡∏ö:**
- ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (1-3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ) ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏Å
- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ ‚Üí ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô
- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‚Üí ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô
- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£ ‚Üí ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏ö‡∏≤‡πÜ
- ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ä‡πà‡∏ß‡∏¢

üí¨ **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:**
- "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏≤" ‚Üí "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! üòä ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞"
- "‡∏î‡∏µ‡∏à‡πâ‡∏≤" ‚Üí "‡∏î‡∏µ‡∏Ñ‡πà‡∏∞‡∏û‡∏µ‡πà üåø ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∞"
- "‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£" ‚Üí "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡πà‡∏∞ üòä"
- "‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà" ‚Üí "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏û‡∏µ‡πà‡πÜ ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡πà‡∏∞ üåæ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞"
- "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏à‡∏±‡∏á" ‚Üí "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏û‡∏µ‡πà üíö ‡∏ó‡∏≥‡πÑ‡∏£‡πà‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞"
- "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì" ‚Üí "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! üòä ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞"

‚ö†Ô∏è **‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏°:**
- ‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢)
- ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ICP Ladda
- ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß"""

            user_prompt = f"""‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤:
{context if context else "(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà)"}

‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {message}

‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô:"""

            response = await openai_client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                max_tokens=300,
                temperature=0.7  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö
            )
            answer = post_process_answer(response.choices[0].message.content)
            
            # Add assistant response to memory
            await add_to_memory(user_id, "assistant", answer)
            return answer

    except Exception as e:
        logger.error(f"Error in natural conversation: {e}", exc_info=True)
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ üòÖ"
