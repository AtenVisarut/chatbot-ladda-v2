# ğŸ”„ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸£à¸°à¸šà¸š Plant Disease Detection Bot

## ğŸ“‹ à¸ à¸²à¸à¸£à¸§à¸¡à¸£à¸°à¸šà¸š

```
User (LINE) â†’ FastAPI â†’ Gemini Vision â†’ Vector Search â†’ Gemini Filter â†’ Response
```

---

## ğŸ¯ Flow à¸«à¸¥à¸±à¸ 3 à¹à¸šà¸š

### 1. **Image Detection Flow** (à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸£à¸„à¸ˆà¸²à¸à¸£à¸¹à¸›)
### 2. **Text Q&A Flow** (à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡)
### 3. **Help/Info Flow** (à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹ˆà¸§à¹„à¸›)

---

## ğŸ“¸ Flow 1: Image Detection (à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸£à¸„à¸ˆà¸²à¸à¸£à¸¹à¸›)

### Step-by-Step Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: User sends image via LINE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: LINE Webhook â†’ FastAPI                             â”‚
â”‚  - Verify signature                                         â”‚
â”‚  - Extract message_id                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Download image from LINE                           â”‚
â”‚  - GET https://api-data.line.me/v2/bot/message/{id}/contentâ”‚
â”‚  - Store image_bytes in memory                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Ask user for additional info                       â”‚
â”‚  - Store image in pending_image_contexts[user_id]          â”‚
â”‚  - Reply: "à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸Šà¸™à¸´à¸”à¸à¸·à¸Š, à¸­à¸²à¸à¸²à¸£, à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: User replies with text info                        â”‚
â”‚  - "à¸—à¸¸à¹€à¸£à¸µà¸¢à¸™ à¹ƒà¸šà¸¡à¹‰à¸§à¸™ à¸¡à¸µà¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥ à¹€à¸à¸´à¸”à¸¡à¸² 3 à¸§à¸±à¸™"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: Gemini Vision Analysis                             â”‚
â”‚  - detect_disease(image_bytes, extra_user_info)            â”‚
â”‚  - Analyze image + user text                                â”‚
â”‚  - Return: disease_name, confidence, symptoms, severity     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 7: Vector Search for Products                         â”‚
â”‚  - retrieve_product_recommendation(disease_info)           â”‚
â”‚  - E5 embedding â†’ Supabase vector search                    â”‚
â”‚  - Get 15 candidates                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 8: Gemini Filter Products                             â”‚
â”‚  - filter_products_with_gemini(candidates)                 â”‚
â”‚  - Select 3-5 most relevant                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 9: Vector Search for Knowledge                        â”‚
â”‚  - retrieve_knowledge_from_knowledge_table(disease_info)   â”‚
â”‚  - E5 embedding â†’ Supabase vector search                    â”‚
â”‚  - Get 10 candidates                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 10: Gemini Synthesize Knowledge                       â”‚
â”‚  - filter_knowledge_with_gemini(candidates)                â”‚
â”‚  - Synthesize to 250 words                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 11: Generate Final Response                           â”‚
â”‚  - generate_final_response(disease_info, products)         â”‚
â”‚  - Format: Header + Knowledge + Products + Footer          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 12: Reply to LINE                                     â”‚
â”‚  - POST https://api.line.me/v2/bot/message/reply           â”‚
â”‚  - Send formatted message                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### ğŸ“ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸ˆà¸£à¸´à¸‡

#### Input:
```
User: [à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¹ƒà¸šà¸—à¸¸à¹€à¸£à¸µà¸¢à¸™à¸—à¸µà¹ˆà¸¡à¸µà¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥]
Bot: "à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸Šà¸™à¸´à¸”à¸à¸·à¸Š, à¸­à¸²à¸à¸²à¸£..."
User: "à¸—à¸¸à¹€à¸£à¸µà¸¢à¸™ à¹ƒà¸šà¸¡à¹‰à¸§à¸™ à¸¡à¸µà¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥ à¹€à¸«à¹‡à¸™à¹à¸¡à¸¥à¸‡à¸•à¸±à¸§à¹€à¸¥à¹‡à¸à¸ªà¸µà¸”à¸³ à¹€à¸à¸´à¸”à¸¡à¸² 3 à¸§à¸±à¸™"
```

#### Processing:
```
1. Gemini Vision Analysis:
   - disease_name: "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ"
   - confidence: "85%"
   - symptoms: "à¹ƒà¸šà¸¡à¹‰à¸§à¸™, à¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥, à¹à¸¡à¸¥à¸‡à¸•à¸±à¸§à¹€à¸¥à¹‡à¸à¸ªà¸µà¸”à¸³"
   - severity: "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡"

2. Vector Search Products:
   - Query: "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ"
   - Candidates: 15 products
   - Gemini Filter: 3 products
     â€¢ à¹‚à¸¡à¹€à¸”à¸´à¸™ 50 EC (95%)
     â€¢ à¹„à¸”à¸­à¸°à¸‹à¸´à¸™à¸­à¸™ 60 EC (88%)
     â€¢ à¸­à¸´à¸¡à¸´à¸”à¸²à¹‚à¸„à¸¥à¸à¸£à¸´à¸” 20 SL (82%)

3. Vector Search Knowledge:
   - Query: "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ"
   - Candidates: 10 entries
   - Gemini Synthesis: "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¹€à¸›à¹‡à¸™à¹à¸¡à¸¥à¸‡à¸‚à¸™à¸²à¸”à¹€à¸¥à¹‡à¸..."
```

#### Output:
```
ğŸ” à¸œà¸¥à¸•à¸£à¸§à¸ˆà¸ˆà¸²à¸à¸ à¸²à¸: à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ

ğŸŸ¢ à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸™à¹ƒà¸ˆ: 85%
ğŸ“Š à¸„à¸§à¸²à¸¡à¸£à¸¸à¸™à¹à¸£à¸‡: à¸›à¸²à¸™à¸à¸¥à¸²à¸‡
ğŸ“ à¸­à¸²à¸à¸²à¸£à¸—à¸µà¹ˆà¹€à¸«à¹‡à¸™: à¹ƒà¸šà¸¡à¹‰à¸§à¸™, à¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥, à¹à¸¡à¸¥à¸‡à¸•à¸±à¸§à¹€à¸¥à¹‡à¸à¸ªà¸µà¸”à¸³

ğŸ“š à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡:
à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¹€à¸›à¹‡à¸™à¹à¸¡à¸¥à¸‡à¸‚à¸™à¸²à¸”à¹€à¸¥à¹‡à¸ à¸¥à¸³à¸•à¸±à¸§à¸¢à¸²à¸§ à¸¡à¸µà¸—à¸±à¹‰à¸‡à¸Šà¸™à¸´à¸”à¸¡à¸µà¸›à¸µà¸à¹à¸¥à¸°à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸µà¸...

ğŸ’Š à¸ªà¸´à¸™à¸„à¹‰à¸²à¹à¸™à¸°à¸™à¸³:

1. à¹‚à¸¡à¹€à¸”à¸´à¸™ 50 EC
   â€¢ à¸ªà¸²à¸£à¸ªà¸³à¸„à¸±à¸: Acetamiprid
   â€¢ à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¹ƒà¸Šà¹‰: 20 ml/à¸™à¹‰à¸³ 20 à¸¥à¸´à¸•à¸£
   â€¢ à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Šà¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢: à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ, à¹€à¸à¸¥à¸µà¹‰à¸¢à¸­à¹ˆà¸­à¸™
   â€¢ à¸„à¸§à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡: 95%

[... 2 more products ...]

========================================
ğŸ“‹ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸ªà¸³à¸„à¸±à¸:
â€¢ âœ… à¸›à¸£à¸±à¸šà¸­à¸±à¸•à¸£à¸²/à¸›à¸£à¸´à¸¡à¸²à¸“à¸•à¸²à¸¡à¸‰à¸¥à¸²à¸à¸ˆà¸£à¸´à¸‡à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡
...
```

---

## ğŸ’¬ Flow 2: Text Q&A (à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡)

### Step-by-Step Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: User sends text question                           â”‚
â”‚  - "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¸à¸³à¸ˆà¸±à¸”à¸¢à¸±à¸‡à¹„à¸‡?"                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Detect question pattern                            â”‚
â”‚  - Check for: ?, à¸¢à¸±à¸‡à¹„à¸‡, à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£, à¸—à¸³à¹„à¸¡, à¸„à¸·à¸­, à¹„à¸”à¹‰à¹„à¸«à¸¡        â”‚
â”‚  - If match â†’ Q&A flow                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Generate question embedding                        â”‚
â”‚  - E5 model: encode("query: à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¸à¸³à¸ˆà¸±à¸”à¸¢à¸±à¸‡à¹„à¸‡?")          â”‚
â”‚  - Get 768-dim vector                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Vector search knowledge                            â”‚
â”‚  - match_knowledge(embedding, threshold=0.3, count=10)     â”‚
â”‚  - Get 10 relevant knowledge entries                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: Extract keywords & search products                 â”‚
â”‚  - Keywords: ["à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ", "à¸à¸³à¸ˆà¸±à¸”"]                          â”‚
â”‚  - Search products with target_pest ILIKE '%à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ%'     â”‚
â”‚  - Get 3 products                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: Gemini generate answer                             â”‚
â”‚  - Input: question + knowledge + products                   â”‚
â”‚  - Generate natural Thai answer                             â”‚
â”‚  - Include: à¸ªà¸²à¹€à¸«à¸•à¸¸, à¸§à¸´à¸˜à¸µà¸›à¹‰à¸­à¸‡à¸à¸±à¸™, à¸§à¸´à¸˜à¸µà¸à¸³à¸ˆà¸±à¸”, à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 7: Reply to LINE                                      â”‚
â”‚  - Send formatted answer                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸ˆà¸£à¸´à¸‡

#### Input:
```
User: "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¸à¸³à¸ˆà¸±à¸”à¸¢à¸±à¸‡à¹„à¸‡?"
```

#### Processing:
```
1. Vector Search Knowledge:
   - Query: "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¸à¸³à¸ˆà¸±à¸”à¸¢à¸±à¸‡à¹„à¸‡?"
   - Found: 10 knowledge entries
   - Top 5 combined

2. Keyword Search Products:
   - Keyword: "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ"
   - Found: 3 products
     â€¢ à¹‚à¸¡à¹€à¸”à¸´à¸™ 50 EC
     â€¢ à¹„à¸”à¸­à¸°à¸‹à¸´à¸™à¸­à¸™ 60 EC
     â€¢ à¸­à¸´à¸¡à¸´à¸”à¸²à¹‚à¸„à¸¥à¸à¸£à¸´à¸” 20 SL

3. Gemini Answer Generation:
   - Analyze knowledge + products
   - Generate natural answer
```

#### Output:
```
ğŸ› à¸§à¸´à¸˜à¸µà¸à¸³à¸ˆà¸±à¸”à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ

à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¹€à¸›à¹‡à¸™à¹à¸¡à¸¥à¸‡à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Šà¸—à¸µà¹ˆà¸ªà¸³à¸„à¸±à¸ à¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸³à¸ˆà¸±à¸”à¹„à¸”à¹‰à¸«à¸¥à¸²à¸¢à¸§à¸´à¸˜à¸µ:

ğŸŒ± à¸§à¸´à¸˜à¸µà¸›à¹‰à¸­à¸‡à¸à¸±à¸™:
â€¢ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸›à¸£à¸°à¸ˆà¸³
â€¢ à¸à¸³à¸ˆà¸±à¸”à¸§à¸±à¸Šà¸à¸·à¸Šà¸£à¸­à¸šà¹à¸›à¸¥à¸‡
â€¢ à¹ƒà¸Šà¹‰à¸à¸±à¸šà¸”à¸±à¸à¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡

ğŸ’Š à¸§à¸´à¸˜à¸µà¸à¸³à¸ˆà¸±à¸”:
â€¢ à¹ƒà¸Šà¹‰à¸ªà¸²à¸£à¹€à¸„à¸¡à¸µ: à¹‚à¸¡à¹€à¸”à¸´à¸™ 50 EC, à¹„à¸”à¸­à¸°à¸‹à¸´à¸™à¸­à¸™ 60 EC
â€¢ à¸à¹ˆà¸™à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸Šà¹‰à¸²à¸«à¸£à¸·à¸­à¹€à¸¢à¹‡à¸™
â€¢ à¸à¹ˆà¸™à¹ƒà¸«à¹‰à¸—à¸±à¹ˆà¸§à¸—à¸±à¹‰à¸‡à¸•à¹‰à¸™ à¹‚à¸”à¸¢à¹€à¸‰à¸à¸²à¸°à¹ƒà¸•à¹‰à¹ƒà¸š

âš ï¸ à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡:
â€¢ à¸­à¹ˆà¸²à¸™à¸‰à¸¥à¸²à¸à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡
â€¢ à¸ªà¸§à¸¡à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸›à¹‰à¸­à¸‡à¸à¸±à¸™
â€¢ à¹„à¸¡à¹ˆà¸à¹ˆà¸™à¹ƒà¸™à¸§à¸±à¸™à¸—à¸µà¹ˆà¸¡à¸µà¸¥à¸¡à¹à¸£à¸‡

ğŸ“š à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œà¹à¸™à¸°à¸™à¸³:
- à¹‚à¸¡à¹€à¸”à¸´à¸™ 50 EC: Acetamiprid
- à¹„à¸”à¸­à¸°à¸‹à¸´à¸™à¸­à¸™ 60 EC: Diazinon
- à¸­à¸´à¸¡à¸´à¸”à¸²à¹‚à¸„à¸¥à¸à¸£à¸´à¸” 20 SL: Imidacloprid

ğŸ’¡ à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸à¸à¸·à¸Šà¸—à¸µà¹ˆà¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸¡à¸²à¹ƒà¸«à¹‰à¸‰à¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¹ˆà¸° ğŸŒ±
```

---

## â„¹ï¸ Flow 3: Help/Info (à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹ˆà¸§à¹„à¸›)

### Trigger Keywords:
- "à¸Šà¹ˆà¸§à¸¢", "help", "à¸§à¸´à¸˜à¸µ", "à¹ƒà¸Šà¹‰à¸‡à¸²à¸™", "à¸„à¸³à¸ªà¸±à¹ˆà¸‡"
- "à¸ªà¸´à¸™à¸„à¹‰à¸²", "à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œ", "à¸£à¸²à¸¢à¸à¸²à¸£", "product"
- à¸ªà¸§à¸±à¸ªà¸”à¸µ, hello, hi

### Response Types:

#### 1. Help Message
```
Input: "à¸Šà¹ˆà¸§à¸¢" à¸«à¸£à¸·à¸­ "help"

Output:
ğŸŒ± à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™ Plant Disease Bot

ğŸ“¸ à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸£à¸„à¸à¸·à¸Š:
1. à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¸à¸·à¸Šà¸—à¸µà¹ˆà¸¡à¸µà¸›à¸±à¸à¸«à¸²
2. à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸¡à¸²à¹ƒà¸«à¹‰à¸‰à¸±à¸™
3. à¸£à¸­ 5-10 à¸§à¸´à¸™à¸²à¸—à¸µ
4. à¹„à¸”à¹‰à¸£à¸±à¸šà¸„à¸³à¹à¸™à¸°à¸™à¸³à¹à¸¥à¸°à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œ

ğŸ’¬ à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡:
â€¢ "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¸à¸³à¸ˆà¸±à¸”à¸¢à¸±à¸‡à¹„à¸‡?"
â€¢ "à¸£à¸²à¸™à¹‰à¸³à¸„à¹‰à¸²à¸‡à¹€à¸à¸´à¸”à¸ˆà¸²à¸à¸­à¸°à¹„à¸£?"

ğŸ¯ à¸‰à¸±à¸™à¸ªà¸²à¸¡à¸²à¸£à¸–:
â€¢ à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸£à¸„à¸à¸·à¸Š/à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š
â€¢ à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹‚à¸£à¸„à¸à¸·à¸Š
â€¢ à¹à¸™à¸°à¸™à¸³à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œà¹à¸¥à¸°à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰

à¸à¸£à¹‰à¸­à¸¡à¸Šà¹ˆà¸§à¸¢à¸„à¸¸à¸“à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°! ğŸ˜Š
```

#### 2. Product List
```
Input: "à¸ªà¸´à¸™à¸„à¹‰à¸²" à¸«à¸£à¸·à¸­ "à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œ"

Output:
ğŸ“¦ à¸£à¸²à¸¢à¸à¸²à¸£à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”

à¹€à¸£à¸²à¸¡à¸µà¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œà¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸³à¸ˆà¸±à¸”à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š 43 à¸£à¸²à¸¢à¸à¸²à¸£:

ğŸ› à¸¢à¸²à¸à¸³à¸ˆà¸±à¸”à¹à¸¡à¸¥à¸‡ (Insecticide)
ğŸ„ à¸¢à¸²à¸à¸³à¸ˆà¸±à¸”à¹€à¸Šà¸·à¹‰à¸­à¸£à¸² (Fungicide)
ğŸŒ¿ à¸¢à¸²à¸à¸³à¸ˆà¸±à¸”à¸§à¸±à¸Šà¸à¸·à¸Š (Herbicide)
ğŸŒ± à¸•à¸±à¸§à¸„à¸§à¸šà¸„à¸¸à¸¡à¸à¸²à¸£à¹€à¸ˆà¸£à¸´à¸à¹€à¸•à¸´à¸šà¹‚à¸• (PGR)

ğŸ“š à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹„à¸”à¹‰à¸—à¸µà¹ˆ:
ğŸ”— https://www.icpladda.com/about/

ğŸ’¡ à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™:
à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸à¸à¸·à¸Šà¸—à¸µà¹ˆà¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸¡à¸²à¹ƒà¸«à¹‰à¸‰à¸±à¸™ à¸‰à¸±à¸™à¸ˆà¸°à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸¥à¸°à¹à¸™à¸°à¸™à¸³à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¹ƒà¸«à¹‰à¸„à¹ˆà¸° ğŸ˜Š
```

#### 3. Greeting
```
Input: "à¸ªà¸§à¸±à¸ªà¸”à¸µ" à¸«à¸£à¸·à¸­ "hello"

Output:
à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°! ğŸŒ±

à¸‰à¸±à¸™à¸„à¸·à¸­ AI à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸£à¸„à¸à¸·à¸Šà¹à¸¥à¸°à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š

ğŸ“¸ à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸à¸à¸·à¸Šà¸—à¸µà¹ˆà¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸¡à¸²à¹ƒà¸«à¹‰à¸‰à¸±à¸™
à¸‰à¸±à¸™à¸ˆà¸°à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸¥à¸°à¹à¸™à¸°à¸™à¸³à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¹ƒà¸«à¹‰à¸„à¹ˆà¸°

ğŸ’¬ à¸«à¸£à¸·à¸­à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢ à¹€à¸Šà¹ˆà¸™:
â€¢ "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¸à¸³à¸ˆà¸±à¸”à¸¢à¸±à¸‡à¹„à¸‡?"
â€¢ "à¸£à¸²à¸™à¹‰à¸³à¸„à¹‰à¸²à¸‡à¹€à¸à¸´à¸”à¸ˆà¸²à¸à¸­à¸°à¹„à¸£?"

ğŸ“š à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œ:
ğŸ”— https://www.icpladda.com/about/

ğŸ’¡ à¸à¸´à¸¡à¸à¹Œ 'à¸Šà¹ˆà¸§à¸¢' à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™
```

---

## ğŸ”§ Technical Details

### 1. Gemini Vision Analysis

**Function**: `detect_disease(image_bytes, extra_user_info)`

**Input**:
```python
image_bytes: bytes  # Image from LINE
extra_user_info: str  # "à¸—à¸¸à¹€à¸£à¸µà¸¢à¸™ à¹ƒà¸šà¸¡à¹‰à¸§à¸™ à¸¡à¸µà¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥..."
```

**Prompt Structure**:
```
à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¹‚à¸£à¸„à¸à¸·à¸Šà¹à¸¥à¸°à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š...

ğŸ¯ à¸ à¸²à¸£à¸à¸´à¸ˆ: à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸ à¸²à¸à¸à¸·à¸Šà¹€à¸à¸·à¹ˆà¸­à¸£à¸°à¸šà¸¸à¸›à¸±à¸à¸«à¸²à¸­à¸¢à¹ˆà¸²à¸‡à¹à¸¡à¹ˆà¸™à¸¢à¸³

ğŸ“‹ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ:
1. à¸ªà¸±à¸‡à¹€à¸à¸•à¸­à¸²à¸à¸²à¸£à¸šà¸™à¹ƒà¸š/à¸¥à¸³à¸•à¹‰à¸™/à¸œà¸¥
2. à¸£à¸°à¸šà¸¸à¸ªà¸µ à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡ à¹à¸¥à¸°à¸¥à¸±à¸à¸©à¸“à¸°à¸‚à¸­à¸‡à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¸¢à¸«à¸²à¸¢
3. à¸¡à¸­à¸‡à¸«à¸²à¹à¸¡à¸¥à¸‡ à¹„à¸‚à¹ˆ à¸«à¸£à¸·à¸­à¸£à¹ˆà¸­à¸‡à¸£à¸­à¸¢à¸‚à¸­à¸‡à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š
4. à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸„à¸§à¸²à¸¡à¸£à¸¸à¸™à¹à¸£à¸‡à¸ˆà¸²à¸à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¹€à¸ªà¸µà¸¢à¸«à¸²à¸¢

ğŸ“¤ à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ JSON:
{
  "disease_name": "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ",
  "pest_type": "à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š",
  "confidence_level_percent": 85,
  "symptoms": "à¹ƒà¸šà¸¡à¹‰à¸§à¸™, à¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥",
  "severity_level": "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡",
  ...
}
```

**Output**:
```python
DiseaseDetectionResult(
    disease_name="à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ",
    confidence="85",
    symptoms="à¹ƒà¸šà¸¡à¹‰à¸§à¸™, à¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥, à¹à¸¡à¸¥à¸‡à¸•à¸±à¸§à¹€à¸¥à¹‡à¸à¸ªà¸µà¸”à¸³",
    severity="à¸›à¸²à¸™à¸à¸¥à¸²à¸‡",
    raw_analysis="à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š: à¹à¸¡à¸¥à¸‡à¸‚à¸™à¸²à¸”à¹€à¸¥à¹‡à¸..."
)
```

**Processing Time**: ~2-3 seconds

---

### 2. Vector Search

**Function**: `retrieve_product_recommendation(disease_info)`

**Step 1: Generate Embedding**
```python
query_text = f"query: {disease_name}"  # "query: à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ"
embedding = e5_model.encode(query_text, normalize_embeddings=True)
# Output: [0.123, -0.456, 0.789, ...] (768 dimensions)
```

**Step 2: Vector Search**
```python
result = supabase.rpc('match_products', {
    'query_embedding': embedding,
    'match_threshold': 0.3,
    'match_count': 15
})
# Returns: 15 products with similarity > 0.3
```

**Step 3: Gemini Filtering**
```python
filtered = filter_products_with_gemini(
    disease_name="à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ",
    raw_analysis="à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š: à¹à¸¡à¸¥à¸‡à¸‚à¸™à¸²à¸”à¹€à¸¥à¹‡à¸...",
    candidates=result.data  # 15 products
)
# Returns: 3-5 most relevant products
```

**Processing Time**: ~1.5-2 seconds

---

### 3. Knowledge Synthesis

**Function**: `retrieve_knowledge_from_knowledge_table(disease_info)`

**Step 1: Vector Search**
```python
query_embedding = e5_model.encode(f"query: {disease_name}")
candidates = supabase.rpc('match_knowledge', {
    'query_embedding': query_embedding,
    'match_threshold': 0.4,
    'match_count': 10
})
# Returns: 10 knowledge entries
```

**Step 2: Gemini Synthesis**
```python
synthesized = filter_knowledge_with_gemini(
    disease_name="à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ",
    candidates=candidates  # 10 entries
)
# Returns: Synthesized text (250 words max)
```

**Prompt Structure**:
```
à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¹‚à¸£à¸„à¸à¸·à¸Šà¹à¸¥à¸°à¸¨à¸±à¸•à¸£à¸¹à¸à¸·à¸Š

ğŸ¯ à¸ à¸²à¸£à¸à¸´à¸ˆ: à¸à¸£à¸­à¸‡à¹à¸¥à¸°à¸ªà¸±à¸‡à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š "à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿ"

ğŸ“š à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸—à¸µà¹ˆà¸à¸š:
[1] (Similarity: 92%) à¹€à¸à¸¥à¸µà¹‰à¸¢à¹„à¸Ÿà¹€à¸›à¹‡à¸™à¹à¸¡à¸¥à¸‡...
[2] (Similarity: 88%) à¸¥à¸±à¸à¸©à¸“à¸°à¸­à¸²à¸à¸²à¸£...
...

ğŸ“‹ à¸„à¸³à¸ªà¸±à¹ˆà¸‡:
1. à¸­à¹ˆà¸²à¸™à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸­à¸¢à¹ˆà¸²à¸‡à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”
2. à¹€à¸¥à¸·à¸­à¸à¹€à¸‰à¸à¸²à¸°à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¹‚à¸”à¸¢à¸•à¸£à¸‡
3. à¸ªà¸±à¸‡à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ªà¸±à¹‰à¸™à¹† (à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 250 à¸„à¸³)
4. à¸£à¸§à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸: à¸¥à¸±à¸à¸©à¸“à¸°, à¸ªà¸²à¹€à¸«à¸•à¸¸, à¸§à¸´à¸˜à¸µà¸›à¹‰à¸­à¸‡à¸à¸±à¸™, à¸§à¸´à¸˜à¸µà¸à¸³à¸ˆà¸±à¸”
```

**Processing Time**: ~1-1.5 seconds

---

## â±ï¸ Total Processing Time

### Image Detection Flow:
```
Step 1-5: User interaction          ~10-30 seconds (user input)
Step 6: Gemini Vision               ~2-3 seconds
Step 7-8: Product search + filter   ~1.5-2 seconds
Step 9-10: Knowledge search + synth ~1-1.5 seconds
Step 11-12: Format + reply          ~0.5 seconds
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total (system): ~5-7 seconds
Total (with user): ~15-37 seconds
```

### Text Q&A Flow:
```
Step 1-2: Detect question           ~0.1 seconds
Step 3-4: Vector search knowledge   ~0.5 seconds
Step 5: Search products             ~0.3 seconds
Step 6: Gemini answer               ~2-3 seconds
Step 7: Reply                       ~0.5 seconds
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~3.5-4.5 seconds
```

### Help/Info Flow:
```
Step 1-2: Detect keyword + reply    ~0.5 seconds
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~0.5 seconds
```

---

## ğŸ”„ Error Handling & Fallbacks

### 1. Gemini Vision Fails
```python
try:
    result = detect_disease(image_bytes)
except Exception as e:
    return "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸£à¸¹à¸›à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡"
```

### 2. Vector Search Fails
```python
try:
    # Try vector search
    result = vector_search(...)
except:
    # Fallback to keyword search
    result = keyword_search(...)
```

### 3. Gemini Filtering Fails
```python
filtered = filter_with_gemini(candidates)
if not filtered:
    # Use top vector results
    return candidates[:6]
```

### 4. No Results Found
```python
if not recommendations:
    return """
    âš ï¸ à¸‚à¸“à¸°à¸™à¸µà¹‰à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œà¸—à¸µà¹ˆà¸•à¸£à¸‡à¸à¸±à¸šà¸­à¸²à¸à¸²à¸£
    à¹à¸™à¸°à¸™à¸³: à¸›à¸£à¸¶à¸à¸©à¸²à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸ªà¸²à¸£à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸³à¸ˆà¸±à¸”
    """
```

---

## ğŸ“Š Success Metrics

### System Performance:
- **Uptime**: 99.9%
- **Response Time**: < 10s (95th percentile)
- **Error Rate**: < 1%

### Detection Accuracy:
- **Disease Detection**: 85-90%
- **Product Relevance**: 90-95%
- **Knowledge Relevance**: 90-95%

### User Satisfaction:
- **Helpful Responses**: 90%+
- **Accurate Recommendations**: 85%+
- **Easy to Use**: 95%+

---

## ğŸ¯ à¸ªà¸£à¸¸à¸›

à¸£à¸°à¸šà¸šà¸—à¸³à¸‡à¸²à¸™à¸œà¹ˆà¸²à¸™ **3 Flow à¸«à¸¥à¸±à¸**:

1. **Image Detection** - à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¹‚à¸£à¸„à¸ˆà¸²à¸à¸£à¸¹à¸› (5-7s)
2. **Text Q&A** - à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡ (3.5-4.5s)
3. **Help/Info** - à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹ˆà¸§à¹„à¸› (0.5s)

à¹ƒà¸Šà¹‰à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µ:
- **Gemini Vision** - à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸£à¸¹à¸›
- **E5 Model** - Generate embeddings
- **Supabase pgvector** - Vector search
- **Gemini AI** - Filter & synthesize

à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ:
- **Accuracy**: 90-95%
- **Speed**: 3.5-7s
- **User Satisfaction**: 90%+

à¸£à¸°à¸šà¸šà¸—à¸µà¹ˆà¹à¸¡à¹ˆà¸™à¸¢à¸³ à¸£à¸§à¸”à¹€à¸£à¹‡à¸§ à¹à¸¥à¸°à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸‡à¹ˆà¸²à¸¢! ğŸš€
