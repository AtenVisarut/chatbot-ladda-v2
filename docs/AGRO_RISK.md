# Agro-Risk API Integration

## Overview
LINE Bot (Chatbot Ladda) ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Agro-Risk API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£

## Base URL
```
https://thai-water.vercel.app
```

---

## Endpoints

### 1. Weather Check (‡∏î‡∏π‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® + ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡∏ä)

**Endpoint:** `POST /api/v1/weather/check`

**Request Body:**
```json
{
  "location": {
    "latitude": 14.0583,
    "longitude": 100.4765
  },
  "address": "‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏≠‡∏¥‡∏ô ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏≠‡∏¥‡∏ô ‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤",
  "crops": [
    {
      "type": "rice",
      "name": "‡∏Ç‡πâ‡∏≤‡∏ß",
      "growthStage": "vegetative"
    },
    {
      "type": "fruit",
      "name": "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
      "growthStage": "vegetative"
    }
  ]
}
```

**Response:**
```json
{
  "flexMessage": {
    "type": "bubble",
    "body": { "..." }
  }
}
```

---

### 2. Crop Risk Analysis (‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏∑‡∏ä)

**Endpoint:** `POST /api/v1/risk/analyze`

**Request Body:**
```json
{
  "location": {
    "latitude": 14.0583,
    "longitude": 100.4765
  },
  "crop": {
    "type": "rice",
    "growthStage": "vegetative"
  }
}
```

**Response:**
```json
{
  "flexMessage": {
    "type": "bubble",
    "body": { "..." }
  }
}
```

---

## Crop Type Mapping

LINE Bot ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô API crop type:

| ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ | API Type |
|---------|----------|
| ‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏ô‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß | rice |
| ‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î | corn |
| ‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á | cassava |
| ‡∏≠‡πâ‡∏≠‡∏¢ | sugarcane |
| ‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤ | rubber |
| ‡∏õ‡∏≤‡∏•‡πå‡∏°, ‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô | palm |
| ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á, ‡∏•‡∏≥‡πÑ‡∏¢, ‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î, ‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà, ‡πÄ‡∏á‡∏≤‡∏∞, ‡∏™‡πâ‡∏°, ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß | fruit |
| ‡∏ú‡∏±‡∏Å, ‡∏û‡∏∑‡∏ä‡∏ú‡∏±‡∏Å | vegetable |

---

## Growth Stages

| Stage | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ |
|-------|----------|
| seedling | ‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤ |
| vegetative | ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï (default) |
| flowering | ‡∏£‡∏∞‡∏¢‡∏∞‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å |
| harvest | ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß |

---

## Flow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

```
User ‡∏™‡πà‡∏á Location (LINE)
    ‚îÇ
    ‚ñº
LINE Bot ‡∏£‡∏±‡∏ö location message
    ‚îÇ
    ‚ñº
‡∏î‡∏∂‡∏á crops_grown ‡∏à‡∏≤‡∏Å Supabase (users table)
    ‚îÇ
    ‚ñº
‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä‡πÑ‡∏ó‡∏¢ ‚Üí English (CROP_TYPE_MAP)
    ‚îÇ
    ‚ñº
POST /api/v1/weather/check
{
  location: { lat, lng },
  address: "...",
  crops: [{ type, name, growthStage }, ...]
}
    ‚îÇ
    ‚ñº
Agro-Risk API ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:
- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å TMD/OpenWeather
- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏∑‡∏ä
- ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message
    ‚îÇ
    ‚ñº
Response: { flexMessage: {...} }
    ‚îÇ
    ‚ñº
LINE Bot ‡∏™‡πà‡∏á Flex Message ‡∏Å‡∏•‡∏±‡∏ö User
```

---

## ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (LINE Bot)

| ‡πÑ‡∏ü‡∏•‡πå | ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà |
|------|--------|
| `app/config.py` | ‡πÄ‡∏Å‡πá‡∏ö AGRO_RISK_API_URL |
| `app/services/agro_risk.py` | ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API, ‡πÅ‡∏õ‡∏•‡∏á crop type |
| `app/main.py` | Location handler, ‡∏î‡∏∂‡∏á crops_grown |

---

## Expected Flex Message Response

API ‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á Flex Message ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á:

1. **‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ**
   - ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥
   - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
   - ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å
   - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°

2. **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏∑‡∏ä** (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ crops)
   ```
   üåæ ‡∏Ç‡πâ‡∏≤‡∏ß - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ ‚úÖ
   ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©

   üå≥ ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‚ö†Ô∏è
   ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á 87% ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏î‡∏≥
   üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô
   ```

3. **‡∏õ‡∏∏‡πà‡∏° Action**
   - ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
   - ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

---

## ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Flex Message Structure

```json
{
  "flexMessage": {
    "type": "bubble",
    "size": "giga",
    "header": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "text",
          "text": "üå§Ô∏è ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
          "weight": "bold",
          "size": "lg",
          "color": "#ffffff"
        }
      ],
      "backgroundColor": "#27AE60"
    },
    "body": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "text",
          "text": "üìç ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏≠‡∏¥‡∏ô",
          "size": "sm"
        },
        {
          "type": "text",
          "text": "üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: 32¬∞C"
        },
        {
          "type": "text",
          "text": "üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: 78%"
        },
        {
          "type": "separator",
          "margin": "md"
        },
        {
          "type": "text",
          "text": "üåæ ‡∏Ç‡πâ‡∏≤‡∏ß - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ ‚úÖ",
          "weight": "bold",
          "margin": "md"
        },
        {
          "type": "text",
          "text": "‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô",
          "size": "sm",
          "color": "#666666",
          "wrap": true
        },
        {
          "type": "separator",
          "margin": "md"
        },
        {
          "type": "text",
          "text": "üå≥ ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‚ö†Ô∏è",
          "weight": "bold",
          "margin": "md",
          "color": "#E67E22"
        },
        {
          "type": "text",
          "text": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏£‡∏Ñ‡∏£‡∏≤‡∏î‡∏≥\nüí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô",
          "size": "sm",
          "color": "#666666",
          "wrap": true
        }
      ]
    }
  }
}
```

---

## Error Handling

‡∏ñ‡πâ‡∏≤ API error, LINE Bot ‡∏à‡∏∞‡∏™‡πà‡∏á error Flex Message:

```json
{
  "type": "bubble",
  "header": {
    "type": "box",
    "contents": [{ "type": "text", "text": "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î" }],
    "backgroundColor": "#E74C3C"
  },
  "body": {
    "contents": [{ "type": "text", "text": "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ" }]
  },
  "footer": {
    "contents": [{
      "type": "button",
      "action": { "type": "message", "label": "üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "text": "‡∏î‡∏π‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®" }
    }]
  }
}
```

---

## Timeout Configuration

```python
TIMEOUT = httpx.Timeout(30.0, connect=10.0)
```
- Total timeout: 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
- Connect timeout: 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
