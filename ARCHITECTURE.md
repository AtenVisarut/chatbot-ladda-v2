# System Architecture

Visual architecture and data flow documentation.

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LINE Platform                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   User   â”‚ â†â”€â”€â”€â”€â”€â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ LINE Bot â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                          Webhook    â”‚
                                          (HTTPS)    â”‚
                                                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI Backend Server                    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Webhook Handler (/webhook)             â”‚    â”‚
â”‚  â”‚  â€¢ Signature verification                           â”‚    â”‚
â”‚  â”‚  â€¢ Event parsing                                    â”‚    â”‚
â”‚  â”‚  â€¢ Request routing                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â†“                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           Image Processing Pipeline                 â”‚    â”‚
â”‚  â”‚                                                      â”‚    â”‚
â”‚  â”‚  1. Download Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚     â†“                                     â”‚          â”‚    â”‚
â”‚  â”‚  2. Disease Detection (Gemini Vision) â”€â”€â”€â”¤          â”‚    â”‚
â”‚  â”‚     â†“                                     â”‚          â”‚    â”‚
â”‚  â”‚  3. Product Retrieval (Pinecone RAG) â”€â”€â”€â”€â”¤          â”‚    â”‚
â”‚  â”‚     â†“                                     â”‚          â”‚    â”‚
â”‚  â”‚  4. Response Generation (Gemini LLM) â”€â”€â”€â”€â”¤          â”‚    â”‚
â”‚  â”‚     â†“                                     â”‚          â”‚    â”‚
â”‚  â”‚  5. Send Reply to LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚               â”‚               â”‚
                â†“               â†“               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Gemini    â”‚  â”‚   Pinecone   â”‚  â”‚  LINE API    â”‚
    â”‚   Vision AI  â”‚  â”‚ Vector Store â”‚  â”‚   Servers    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Detailed Component Architecture

### 1. API Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FastAPI Application             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  GET  /          â†’ Health check         â”‚
â”‚  GET  /health    â†’ Service status       â”‚
â”‚  POST /webhook   â†’ LINE events          â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Business Logic Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Core Business Functions                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  detect_disease()                                     â”‚
â”‚  â”œâ”€ Input: image_bytes                               â”‚
â”‚  â”œâ”€ Process: Gemini Vision API call                  â”‚
â”‚  â””â”€ Output: DiseaseDetectionResult                   â”‚
â”‚                                                       â”‚
â”‚  retrieve_product_recommendation()                    â”‚
â”‚  â”œâ”€ Input: DiseaseDetectionResult                    â”‚
â”‚  â”œâ”€ Process: Pinecone semantic search                â”‚
â”‚  â””â”€ Output: List[ProductRecommendation]              â”‚
â”‚                                                       â”‚
â”‚  generate_final_response()                            â”‚
â”‚  â”œâ”€ Input: Disease + Recommendations                 â”‚
â”‚  â”œâ”€ Process: Gemini LLM generation                   â”‚
â”‚  â””â”€ Output: Thai language text                       â”‚
â”‚                                                       â”‚
â”‚  reply_line()                                         â”‚
â”‚  â”œâ”€ Input: reply_token + message                     â”‚
â”‚  â”œâ”€ Process: LINE Messaging API call                 â”‚
â”‚  â””â”€ Output: None (sends to LINE)                     â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Data Models

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Pydantic Data Models            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  DiseaseDetectionResult                 â”‚
â”‚  â”œâ”€ disease_name: str                   â”‚
â”‚  â”œâ”€ confidence: str                     â”‚
â”‚  â”œâ”€ symptoms: str                       â”‚
â”‚  â”œâ”€ severity: str                       â”‚
â”‚  â””â”€ raw_analysis: str                   â”‚
â”‚                                         â”‚
â”‚  ProductRecommendation                  â”‚
â”‚  â”œâ”€ product_name: str                   â”‚
â”‚  â”œâ”€ description: str                    â”‚
â”‚  â”œâ”€ usage: str                          â”‚
â”‚  â””â”€ score: float                        â”‚
â”‚                                         â”‚
â”‚  LineWebhookEvent                       â”‚
â”‚  â”œâ”€ type: str                           â”‚
â”‚  â”œâ”€ message: Dict                       â”‚
â”‚  â”œâ”€ replyToken: str                     â”‚
â”‚  â”œâ”€ source: Dict                        â”‚
â”‚  â””â”€ timestamp: int                      â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagram

### Complete Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚ Sends plant image
â””â”€â”€â”€â”¬â”€â”€â”˜
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LINE Platform  â”‚ Receives image, creates webhook event
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ POST /webhook
    â”‚ {
    â”‚   "events": [{
    â”‚     "type": "message",
    â”‚     "message": {"type": "image", "id": "12345"},
    â”‚     "replyToken": "abc..."
    â”‚   }]
    â”‚ }
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastAPI Server                                      â”‚
â”‚                                                     â”‚
â”‚ 1. Verify Signature                                 â”‚
â”‚    â”œâ”€ HMAC-SHA256 with LINE_CHANNEL_SECRET         â”‚
â”‚    â””â”€ Compare with X-Line-Signature header         â”‚
â”‚                                                     â”‚
â”‚ 2. Parse Event                                      â”‚
â”‚    â”œâ”€ Extract message type                         â”‚
â”‚    â”œâ”€ Extract message ID                           â”‚
â”‚    â””â”€ Extract reply token                          â”‚
â”‚                                                     â”‚
â”‚ 3. Download Image                                   â”‚
â”‚    â”œâ”€ GET https://api-data.line.me/.../content     â”‚
â”‚    â”œâ”€ Authorization: Bearer {token}                â”‚
â”‚    â””â”€ Returns: binary image data                   â”‚
â”‚                                                     â”‚
â”‚ 4. Detect Disease                                   â”‚
â”‚    â”œâ”€ Convert bytes to PIL Image                   â”‚
â”‚    â”œâ”€ Call Gemini Vision API                       â”‚
â”‚    â”œâ”€ Parse JSON response                          â”‚
â”‚    â””â”€ Returns: DiseaseDetectionResult              â”‚
â”‚       {                                             â”‚
â”‚         "disease_name": "à¹‚à¸£à¸„à¹ƒà¸šà¸ˆà¸¸à¸”",                â”‚
â”‚         "confidence": "à¸ªà¸¹à¸‡",                        â”‚
â”‚         "symptoms": "...",                          â”‚
â”‚         "severity": "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡"                       â”‚
â”‚       }                                             â”‚
â”‚                                                     â”‚
â”‚ 5. Retrieve Products                                â”‚
â”‚    â”œâ”€ Create query from disease info               â”‚
â”‚    â”œâ”€ Query Pinecone index                         â”‚
â”‚    â”œâ”€ Get top_k=5 results                          â”‚
â”‚    â””â”€ Returns: List[ProductRecommendation]         â”‚
â”‚       [                                             â”‚
â”‚         {                                           â”‚
â”‚           "product_name": "à¸›à¸¸à¹‹à¸¢...",               â”‚
â”‚           "description": "...",                     â”‚
â”‚           "usage": "...",                           â”‚
â”‚           "score": 0.95                             â”‚
â”‚         },                                          â”‚
â”‚         ...                                         â”‚
â”‚       ]                                             â”‚
â”‚                                                     â”‚
â”‚ 6. Generate Response                                â”‚
â”‚    â”œâ”€ Combine disease + products                   â”‚
â”‚    â”œâ”€ Call Gemini LLM                              â”‚
â”‚    â”œâ”€ Format in Thai                               â”‚
â”‚    â””â”€ Returns: formatted text                      â”‚
â”‚       "ğŸ” à¸œà¸¥à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹‚à¸£à¸„à¸à¸·à¸Š..."                  â”‚
â”‚                                                     â”‚
â”‚ 7. Reply to LINE                                    â”‚
â”‚    â”œâ”€ POST https://api.line.me/.../reply           â”‚
â”‚    â”œâ”€ Authorization: Bearer {token}                â”‚
â”‚    â”œâ”€ Body: {replyToken, messages}                 â”‚
â”‚    â””â”€ Returns: 200 OK                              â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LINE Platform  â”‚ Delivers message to user
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚ Receives analysis
â””â”€â”€â”€â”€â”€â”€â”˜
```

## External Service Integration

### 1. LINE Messaging API

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        LINE Messaging API               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Webhook Events (Incoming)              â”‚
â”‚  â”œâ”€ POST to your server                 â”‚
â”‚  â”œâ”€ Signature: X-Line-Signature         â”‚
â”‚  â””â”€ Body: Event JSON                    â”‚
â”‚                                         â”‚
â”‚  Content API (Download)                 â”‚
â”‚  â”œâ”€ GET /message/{id}/content           â”‚
â”‚  â”œâ”€ Auth: Bearer token                  â”‚
â”‚  â””â”€ Returns: Binary data                â”‚
â”‚                                         â”‚
â”‚  Reply API (Outgoing)                   â”‚
â”‚  â”œâ”€ POST /message/reply                 â”‚
â”‚  â”œâ”€ Auth: Bearer token                  â”‚
â”‚  â””â”€ Body: {replyToken, messages}        â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Google Gemini AI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Google Gemini AI               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Vision API (Image Analysis)            â”‚
â”‚  â”œâ”€ Model: gemini-1.5-flash            â”‚
â”‚  â”œâ”€ Input: Image + Prompt               â”‚
â”‚  â””â”€ Output: JSON disease info           â”‚
â”‚                                         â”‚
â”‚  LLM API (Text Generation)              â”‚
â”‚  â”œâ”€ Model: gemini-1.5-flash            â”‚
â”‚  â”œâ”€ Input: Context + Prompt             â”‚
â”‚  â””â”€ Output: Thai response text          â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Pinecone Vector Database

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Pinecone Vector Store            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Index: plant-products                  â”‚
â”‚  â”œâ”€ Dimension: 768                      â”‚
â”‚  â”œâ”€ Metric: cosine                      â”‚
â”‚  â””â”€ Namespace: default                  â”‚
â”‚                                         â”‚
â”‚  Operations                             â”‚
â”‚  â”œâ”€ upsert(): Add/update vectors        â”‚
â”‚  â”œâ”€ query(): Semantic search            â”‚
â”‚  â””â”€ fetch(): Get by ID                  â”‚
â”‚                                         â”‚
â”‚  Metadata Schema                        â”‚
â”‚  â”œâ”€ product_name: str                   â”‚
â”‚  â”œâ”€ description: str                    â”‚
â”‚  â”œâ”€ usage: str                          â”‚
â”‚  â”œâ”€ category: str                       â”‚
â”‚  â”œâ”€ disease_targets: str                â”‚
â”‚  â””â”€ price: str                          â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Security Layers                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  1. Transport Security                               â”‚
â”‚     â””â”€ HTTPS/TLS encryption                         â”‚
â”‚                                                      â”‚
â”‚  2. Authentication                                   â”‚
â”‚     â”œâ”€ LINE webhook signature verification          â”‚
â”‚     â”œâ”€ API key authentication (Gemini, Pinecone)    â”‚
â”‚     â””â”€ Bearer token (LINE API)                      â”‚
â”‚                                                      â”‚
â”‚  3. Authorization                                    â”‚
â”‚     â””â”€ Environment variable secrets                 â”‚
â”‚                                                      â”‚
â”‚  4. Input Validation                                 â”‚
â”‚     â”œâ”€ Pydantic models                              â”‚
â”‚     â”œâ”€ Type checking                                â”‚
â”‚     â””â”€ Data sanitization                            â”‚
â”‚                                                      â”‚
â”‚  5. Error Handling                                   â”‚
â”‚     â”œâ”€ Try-catch blocks                             â”‚
â”‚     â”œâ”€ Graceful degradation                         â”‚
â”‚     â””â”€ User-friendly error messages                 â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Deployment Architecture

### Cloud Deployment (Example: Google Cloud Run)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Internet / LINE Platform              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Google Cloud Load Balancer                 â”‚
â”‚         (Auto SSL/TLS)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Google Cloud Run Service                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Container Instance 1                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ FastAPI App                              â”‚ â”‚
â”‚  â”‚  â”œâ”€ Python 3.11                              â”‚ â”‚
â”‚  â”‚  â””â”€ Port 8000                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Container Instance 2 (Auto-scaled)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Container Instance N (Auto-scaled)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚
         â†“                â†“                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Gemini â”‚      â”‚Pinecone â”‚     â”‚LINE API  â”‚
    â”‚   AI   â”‚      â”‚  Cloud  â”‚     â”‚ Servers  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance Characteristics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Performance Metrics                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Latency Breakdown (Average)                         â”‚
â”‚  â”œâ”€ Webhook receive:           ~50ms                â”‚
â”‚  â”œâ”€ Image download:            ~200ms               â”‚
â”‚  â”œâ”€ Gemini Vision analysis:    ~2000ms              â”‚
â”‚  â”œâ”€ Pinecone query:            ~500ms               â”‚
â”‚  â”œâ”€ Gemini LLM generation:     ~1500ms              â”‚
â”‚  â”œâ”€ LINE reply:                ~200ms               â”‚
â”‚  â””â”€ Total:                     ~4450ms (4.5s)       â”‚
â”‚                                                      â”‚
â”‚  Throughput                                          â”‚
â”‚  â”œâ”€ Single instance:           ~10 req/min          â”‚
â”‚  â”œâ”€ With auto-scaling:         ~100+ req/min        â”‚
â”‚  â””â”€ Bottleneck:                Gemini API calls     â”‚
â”‚                                                      â”‚
â”‚  Resource Usage (per instance)                       â”‚
â”‚  â”œâ”€ Memory:                    ~256MB               â”‚
â”‚  â”œâ”€ CPU:                       ~0.5 vCPU            â”‚
â”‚  â””â”€ Network:                   ~2MB per request     â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Error Handling Strategy                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Level 1: Input Validation                           â”‚
â”‚  â”œâ”€ Invalid webhook signature â†’ 403 Forbidden       â”‚
â”‚  â”œâ”€ Malformed JSON â†’ 400 Bad Request                â”‚
â”‚  â””â”€ Missing required fields â†’ 400 Bad Request       â”‚
â”‚                                                      â”‚
â”‚  Level 2: External Service Errors                    â”‚
â”‚  â”œâ”€ LINE API error â†’ Retry + Log                    â”‚
â”‚  â”œâ”€ Gemini API error â†’ Fallback response            â”‚
â”‚  â””â”€ Pinecone error â†’ Mock recommendations           â”‚
â”‚                                                      â”‚
â”‚  Level 3: Business Logic Errors                      â”‚
â”‚  â”œâ”€ Invalid image â†’ User-friendly message           â”‚
â”‚  â”œâ”€ No disease found â†’ Positive message             â”‚
â”‚  â””â”€ Processing timeout â†’ Retry prompt               â”‚
â”‚                                                      â”‚
â”‚  Level 4: System Errors                              â”‚
â”‚  â”œâ”€ Uncaught exception â†’ 500 + Generic message      â”‚
â”‚  â”œâ”€ Log full stack trace                            â”‚
â”‚  â””â”€ Alert monitoring system                         â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This architecture is designed for:
- âœ… Scalability (horizontal scaling)
- âœ… Reliability (error handling, fallbacks)
- âœ… Maintainability (clean separation of concerns)
- âœ… Security (authentication, validation)
- âœ… Performance (async operations, caching-ready)
