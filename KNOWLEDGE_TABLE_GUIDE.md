# üìö ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å Knowledge Table

## ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°

‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ **Vector Search** ‡∏Å‡∏±‡∏ö table `knowledge` ‡∏ó‡∏µ‡πà‡∏°‡∏µ embeddings 1536 ‡∏°‡∏¥‡∏ï‡∏¥ (OpenAI)

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:
1. ‚úÖ Detect ‡πÇ‡∏£‡∏Ñ/‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä (Gemini Vision)
2. üÜï **‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å `knowledge` table** (Vector Search)
3. ‚úÖ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Product ‡∏à‡∏≤‡∏Å `products` table (Keyword Search)

---

## ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: Setup RPC Function

1. ‡πÄ‡∏õ‡∏¥‡∏î **Supabase SQL Editor**
2. Copy SQL ‡∏à‡∏≤‡∏Å: `scripts/setup_knowledge_search.sql`
3. Run SQL
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:
   ```
   status: Knowledge search ready!
   total_knowledge: XX
   knowledge_with_embeddings: XX
   embedding_type: vector
   ```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö

```bash
python scripts/test_knowledge_search.py
```

‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô:
- ‚úì ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô knowledge entries
- ‚úì Embedding dimensions: 1536
- ‚úì ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å keyword search
- ‚úì ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å vector search

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: Restart Server

```bash
python app/main.py
```

---

## ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

### ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (2 ‡∏ß‡∏¥‡∏ò‡∏µ):

#### 1. Vector Search (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥, ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô)
```python
# Generate embedding ‡∏î‡πâ‡∏ß‡∏¢ OpenAI
embedding = openai.embeddings.create(
    model="text-embedding-3-small",
    input=query
)

# ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ RPC function
result = supabase.rpc('match_knowledge', {
    'query_embedding': embedding,
    'match_threshold': 0.6,
    'match_count': 3
})
```

#### 2. Keyword Search (‡πÄ‡∏£‡πá‡∏ß, fallback)
```python
# ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå content
result = supabase.table('knowledge')\
    .select('content')\
    .ilike('content', '%‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü%')\
    .limit(2)\
    .execute()
```

---

## ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

### ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° Knowledge:
```
üîç ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û: ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü

üü¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: 95
üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á: ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
üìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô: ‡∏°‡∏µ‡πÅ‡∏°‡∏•‡∏á‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÅ‡∏î‡∏á‡∏ö‡∏ô‡πÉ‡∏ö

üíä ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
1. ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50
```

### ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Knowledge:
```
üîç ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û: ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü

üü¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: 95
üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á: ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
üìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô: ‡∏°‡∏µ‡πÅ‡∏°‡∏•‡∏á‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÅ‡∏î‡∏á‡∏ö‡∏ô‡πÉ‡∏ö

üìö ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:
[85%] ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á
‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‡πÅ‡∏´‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏≤‡∏´‡∏∞‡∏ô‡∏≥‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ß‡∏£‡∏±‡∏™ ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå...

[78%] ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏§‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏á ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
‡πÉ‡∏ö‡∏û‡∏∑‡∏ä‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á...

üíä ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
1. ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50
```

---

## ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Knowledge Table

```sql
CREATE TABLE knowledge (
    id BIGINT PRIMARY KEY,
    content TEXT,              -- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ
    embedding VECTOR(1536)     -- OpenAI embeddings
);
```

---

## ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ Vector Search

### ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Keyword Search:

| Feature | Keyword Search | Vector Search |
|---------|---------------|---------------|
| ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ | ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥ | ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ |
| ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß | ‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å | ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á |
| ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ | ‡∏ü‡∏£‡∏µ | ~$0.0001/query |
| ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á | "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü" ‚Üí "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü" | "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü" ‚Üí "‡πÅ‡∏°‡∏•‡∏á‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á" |

---

## ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á

### ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á

‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô `app/main.py`:

```python
# ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡πÅ‡∏™‡∏î‡∏á 2 entries
if knowledge_parts:
    return "\n\n".join(knowledge_parts[:2])

# ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 3 entries
if knowledge_parts:
    return "\n\n".join(knowledge_parts[:3])
```

### ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

```python
# ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡πÅ‡∏™‡∏î‡∏á 250 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
preview = content[:250]

# ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 300 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
preview = content[:300]
```

### ‡∏õ‡∏£‡∏±‡∏ö Similarity Threshold

```python
# ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: 0.6 (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)
'match_threshold': 0.6

# ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0.5 (‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
'match_threshold': 0.5

# ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0.7 (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
'match_threshold': 0.7
```

---

## Troubleshooting

### ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏™‡∏î‡∏á

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:**
- Knowledge table ‡∏ß‡πà‡∏≤‡∏á
- Embeddings ‡πÄ‡∏õ‡πá‡∏ô NULL
- Threshold ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
```bash
# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
python scripts/test_knowledge_search.py

# ‡∏•‡∏î threshold
'match_threshold': 0.3
```

### ‚ùå Vector Search ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:**
- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà run SQL setup
- Embeddings ‡πÄ‡∏õ‡πá‡∏ô string ‡πÅ‡∏ó‡∏ô vector

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. Run `scripts/setup_knowledge_search.sql`
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö embedding type:
   ```sql
   SELECT pg_typeof(embedding) FROM knowledge LIMIT 1;
   ```
3. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô text ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô vector:
   ```sql
   ALTER TABLE knowledge 
   ALTER COLUMN embedding TYPE vector(1536) 
   USING embedding::vector;
   ```

### ‚ùå OpenAI API Error

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:**
- OPENAI_API_KEY ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
- ‡πÄ‡∏Å‡∏¥‡∏ô rate limit

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API key ‡πÉ‡∏ô `.env`
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ fallback ‡πÄ‡∏õ‡πá‡∏ô keyword search ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

---

## ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢

### OpenAI Embeddings:
- Model: `text-embedding-3-small`
- ‡∏£‡∏≤‡∏Ñ‡∏≤: $0.00002 / 1K tokens
- ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ~$0.0001 per query
- 1,000 queries = ~$0.10

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:**
- 100 queries/‡∏ß‡∏±‡∏ô = $0.01/‡∏ß‡∏±‡∏ô = $0.30/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- 1,000 queries/‡∏ß‡∏±‡∏ô = $0.10/‡∏ß‡∏±‡∏ô = $3/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô

**‡∏ñ‡∏π‡∏Å‡∏°‡∏≤‡∏Å!** üí∞

---

## ‡∏™‡∏£‡∏∏‡∏õ

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ **3 ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å**:

1. üîç **Detection** - Gemini 2.0 Flash (‡∏ü‡∏£‡∏µ)
2. üìö **Knowledge Base** - Vector Search (OpenAI embeddings)
3. üíä **Product Recommendation** - Keyword Search (‡∏ü‡∏£‡∏µ)

### ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ:
- ‚úÖ ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏°‡∏≤‡∏Å (Vector Search)
- ‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ (Semantic Search)
- ‚úÖ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å (~$3/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
- ‚úÖ Fallback ‡πÄ‡∏õ‡πá‡∏ô keyword search ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

üéâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!
