================================================================================
CHANGELOG — 2026-02-05
Product Data Update: อัปเดตข้อมูลสินค้า "อาร์เทมีส" ให้ครบทุก field
================================================================================

สรุป:
  อัปเดตข้อมูลสินค้า "อาร์เทมีส" (Artemis) ใน Supabase products table
  จากเดิมที่มีข้อมูลเฉพาะนาข้าว → เพิ่มข้อมูลครบทุกพืช (ทุเรียน, ข้าวโพด,
  หอม, กระเทียม) พร้อม regenerate embedding ใหม่

================================================================================
1. ข้อมูลที่อัปเดต (อาร์เทมีส id=263)
================================================================================

  target_pest (เดิม → ใหม่):
    เดิม: "โรคใบจุดสีน้ำตาล โรคใบขีดสีน้ำตาล โรคเมล็ดด่าง ในนาข้าว"
    ใหม่: แยกตามพืช 4 กลุ่ม:
      (นาข้าว)       โรคกาบใบแห้ง ใบขีดสีน้ำตาล เมล็ดด่าง เน่าคอรวง
      (ข้าวโพด)      โรคใบไหม้แผลใหญ่
      (หอม กระเทียม) โรคหอมเลื้อย ใบจุดสีม่วง
      (ทุเรียน)       แอนแทรคโนส ใบจุด ราสนิม ผลเน่า ใบติด ราสีชมพู

  applicable_crops (เดิม → ใหม่):
    เดิม: "นาข้าว ไม้ผล"
    ใหม่: "นาข้าว ทุเรียน ข้าวโพด หอม กระเทียม ผัก ผลไม้"

  usage_rate (เดิม → ใหม่):
    เดิม: "ในไม้ผล(ทุเรียน) ใช้ 200 ซีซีต่อ 200 ลิตร ในนาข้าว ใช้ 50 ซีซีต่อไร่"
    ใหม่: แยกตามพืช:
      (นาข้าว)  50 ซีซี/ไร่ (1 ขวด ใช้ได้ถึง 20 ไร่)
      (ทุเรียน) 10 ซีซี/น้ำ 20 ลิตร ฉีดพ่นทุก 7-10 วัน

  usage_period (เดิม → ใหม่):
    เดิม: "" (ว่างเปล่า)
    ใหม่:
      (นาข้าว)  พ่นช่วงข้าวแตกกอ-ออกรวง ในข้าวระยะตั้งท้อง
      (ทุเรียน) ฉีดพ่นทุก 7-10 วัน หรือตามการระบาดของโรค

  how_to_use (เดิม → ใหม่):
    เดิม: "ผสมน้ำตามอัตราที่แนะนำ แล้วทำการฉีดพ่นที่ต้น ให้ทั่วบริเวณทรงพุ่ม"
    ใหม่: แยกตามพืช + เพิ่มรายละเอียดโดรน:
      (นาข้าว)  ใช้ 50 ซีซี/ไร่ พ่นช่วงข้าวแตกกอ-ออกรวง ใช้ได้กับโดรน
      (ทุเรียน) ใช้ 10 ซีซี/น้ำ 20 ลิตร ฉีดพ่นทุก 7-10 วัน ทั่วทรงพุ่ม

  selling_point (ใหม่ — เดิมไม่มี):
    "สารป้องกันกำจัดเชื้อราออกฤทธิ์ดูดซึม ผสม 2 พลังบวก
    (ไดฟีโนโคนาโซล+อะซอกซีสโตรบิน) | ป้องกันและรักษากว้างขวาง |
    ปลอดภัยต่อดอกและผลอ่อน | แก้ปัญหาโรคใบติด ราสีชมพู
    และแอนแทรคโนสได้อย่างมีประสิทธิภาพสูง | ดูดซึมเร็ว ออกฤทธิ์ไว |
    ใช้แล้วใบเขียว ผิวนวล ผลสะอาด | สูตรเย็นปลอดภัยต่อดอกและผลอ่อน"

  action_characteristics (ใหม่ — เดิมไม่มี):
    "ออกฤทธิ์แบบดูดซึม (Systemic) ดูดซึมเร็ว ออกฤทธิ์ไว
    ป้องกันกำจัดเชื้อราได้กว้าง"

  package_size (ใหม่ — เดิมไม่มี):
    "1 ลิตร"

================================================================================
2. Embedding regenerated
================================================================================

  embedding_text อัปเดตให้ครอบคลุม:
    - ชื่อโรคทุกพืช (ข้าว, ข้าวโพด, หอม/กระเทียม, ทุเรียน)
    - ชื่อพืชทั้งหมด 7 กลุ่ม
    - จุดเด่น: ดูดซึม, สูตรเย็น, ใช้กับโดรน
    - English keywords: Difenoconazole, Azoxystrobin, Fungicide

  ผลกระทบ: vector/semantic search จะหาเจอสินค้าอาร์เทมีส
  เมื่อถามเกี่ยวกับโรคทุเรียน (ใบติด, ราสีชมพู, แอนแทรคโนส)
  ซึ่งเดิม search ไม่เจอ

================================================================================
3. ไฟล์ที่แก้ไข
================================================================================

  scripts/update_artemis.py
    - สร้างใหม่ (ไฟล์เดิมถูกลบ)
    - อัปเดต product_data ครบ 13 fields
    - อัปเดต embedding_text ครอบคลุมทุกพืช+โรค
    - เพิ่ม UTF-8 encoding fix สำหรับ Windows console
    - เพิ่ม Verify section แสดง 12 fields หลังอัปเดต

================================================================================
4. หมายเหตุ: Embedding vs Keyword Search
================================================================================

  ระบบ search ใน products table มี 2 ส่วน:

  1) search_vector (Keyword/Full-Text Search)
     - มี Postgres trigger อัปเดตอัตโนมัติเมื่อ INSERT/UPDATE
     - ดึงจาก: product_name, target_pest, common_name_th,
       active_ingredient, applicable_crops, how_to_use
     - ไม่ต้องทำอะไรเพิ่ม — อัปเดตทันทีเมื่อแก้ field

  2) embedding (Vector/Semantic Search)
     - ไม่มี trigger อัตโนมัติ
     - ต้อง regenerate ด้วย script (เรียก OpenAI text-embedding-3-small)
     - ถ้าแก้ field โดยไม่รัน script → vector search ยังใช้ embedding เก่า

  Workflow แนะนำ:
     แก้ข้อมูลใน script → รัน script → field + embedding อัปเดตพร้อมกัน

================================================================================
5. ทดสอบ (ก่อนอัปเดต)
================================================================================

  Query: "ใชติดทุเรียนใช้ยาอะไร"
    - Intent: PRODUCT_RECOMMENDATION, plant_type=ทุเรียน
    - อาร์เทมีสไม่ปรากฏในผลลัพธ์ (เดิม target_pest มีแค่โรคข้าว)
    - Bot แนะนำ พรีดิคท์ 25 แทน (ไม่ตรงคำถาม)

  หลังอัปเดต: คาดว่าอาร์เทมีสจะปรากฏในผลลัพธ์เมื่อถามเกี่ยวกับ
  โรคทุเรียน (ใบติด, ราสีชมพู, แอนแทรคโนส) เพราะทั้ง keyword search
  และ vector search มีข้อมูลใหม่แล้ว

================================================================================
6. Fix: เรียงลำดับสินค้าตาม Strategy Group + แนะนำ 2-3 ตัว
================================================================================

  ปัญหา:
    ถาม "เพลี้ยไฟบุกแปลง มีสินค้าแนะนำไหม" →
    บางครั้งแนะนำ อิมิดาโกลด์ 70 (Natural) บางครั้งแนะนำ โมเดิน 50 (Expand)
    ไม่สม่ำเสมอ และแนะนำแค่ 1 ตัว แทนที่จะ 2-3 ตัว

  สาเหตุ:
    - อิมิดาโกลด์ (Natural, boost 0.0) ได้คะแนน LLM rerank สูงกว่า
      โมเดิน (Expand, boost +0.10) เพราะ IMIDACLOPRID ตรงกับเพลี้ยไฟมาก
    - response_generator_agent.py กรอง Standard ออก แต่ไม่ได้ sort
      ตาม strategy_group → สินค้าเรียงตาม rerank score เดิม
    - LLM ไม่ enforce ลำดับ strategy_group เสมอ

  แก้ไข 2 ไฟล์:

    app/services/agents/response_generator_agent.py
      - เพิ่ม: explicit sort by strategy_group priority หลัง filter
        Skyrocket(0) > Expand(1) > Natural(2) > Standard(3)
        ทำให้สินค้า Skyrocket/Expand ปรากฏก่อนใน product context เสมอ

    app/prompts.py (PRODUCT_QA_PROMPT)
      - แก้ ข้อ 2: "ไม่เกิน 1-3 ตัว" → "แนะนำ 2-3 ตัว (ถ้ามี)"
      - แก้ ข้อ 11: เน้นลำดับชัดเจนขึ้น
        ลำดับ 1: Skyrocket | ลำดับ 2: Expand | ลำดับ 3: Natural
        เพิ่ม: "สินค้าลำดับ [สินค้า 1] คือตัวที่ควรแนะนำก่อน"

  ผลที่คาด:
    - สินค้า Expand (โมเดิน) จะถูกแนะนำก่อน Natural (อิมิดาโกลด์) เสมอ
    - Bot จะแนะนำ 2-3 ตัวแทน 1 ตัว

================================================================================
7. Fix: อนุญาตให้แนะนำ Standard ได้ (ไม่ลบออกจาก list)
================================================================================

  ปัญหา:
    โค้ดเดิม (section 6) ลบสินค้า Standard ออกจาก list ทั้งหมด
    ถ้ามี Skyrocket/Expand อยู่ → Standard หายไปเลย
    แต่จริงๆ Standard ควรแนะนำได้ ถ้า Skyrocket/Expand ไม่ตรงกับโรค/แมลงที่ถาม

  แก้ไข:

    app/services/agents/response_generator_agent.py
      - ลบ: filter ที่ exclude Standard ออก (priority_docs + if block)
      - คง: sort by strategy_group priority (Skyrocket > Expand > Natural > Standard)
      - ผล: Standard ยังอยู่ใน list แต่เรียงท้ายสุดเสมอ

    app/prompts.py (PRODUCT_QA_PROMPT ข้อ 11)
      - เดิม: "ห้ามแนะนำกลุ่ม Standard ในรอบแรก"
      - ใหม่: "กลุ่ม Standard แนะนำได้ แต่ไม่ใช่ตัวเลือกแรก
               ถ้า Skyrocket/Expand/Natural ไม่ตรงกับโรค/แมลงที่ถาม
               ให้แนะนำ Standard ได้เลย"

  ผลที่คาด:
    - Standard ไม่ถูกลบจาก context → LLM เห็นข้อมูลครบ
    - LLM จะเลือก Standard ได้ถ้าตรงกับโรค/แมลงมากกว่า Skyrocket/Expand
    - ลำดับยังคง Skyrocket > Expand > Natural > Standard

================================================================================
