# Work Log — 2026-02-13 (วันพฤหัสบดี)

## สรุปภาพรวม

วันนี้ทำ 4 งานหลัก: แก้ปัญหา hallucination จาก general chat, แก้ bug follow-up ข้อมูลสินค้า, เพิ่มฟิลด์ phytotoxicity, และ integrate Facebook Messenger

**ไฟล์ที่แก้ไข**: 13 ไฟล์ | **เพิ่ม**: +584 บรรทัด | **ลบ**: -52 บรรทัด | **Commits**: 4

---

## 1. RAG-First Routing — แก้ Hallucination จาก General Chat

**เวลา**: 10:38 | **Commit**: `96cef64` | **ประเภท**: Bug Fix

### ปัญหา
ข้อความที่ไม่ตรงกับ keyword list (เช่น "ฟิวซาเรี่ยม" ที่สะกดต่างจากในระบบ) จะถูกส่งไป general chat แทน RAG pipeline ทำให้ LLM ตอบมัว่ — hallucination

### สิ่งที่แก้ไข
- **พลิก routing default**: ข้อความที่ไม่แน่ใจ → ส่ง RAG (เดิมส่ง general chat)
- เพิ่ม `_is_clearly_non_agriculture()` — ตรวจจับข้อความสั้นที่ไม่เกี่ยวกับเกษตร (≤20 ตัวอักษร)
- ย้าย greeting fast path ขึ้นมาก่อน routing + เพิ่ม short-keyword guard (คำ ≤2 ตัว → ข้อความ ≤8 ตัว)
- **Neuter `GENERAL_CHAT_PROMPT`**: ลบความเชี่ยวชาญเกษตร, เพิ่ม anti-hallucination constraints
- General chat: ลบ context injection, temp 0.7→0.3, max_tokens 300→150

### ไฟล์ที่แก้ไข
| ไฟล์ | การเปลี่ยนแปลง |
|---|---|
| `app/services/chat/handler.py` | +93 -28 — routing logic ใหม่, `_is_clearly_non_agriculture()` |
| `app/prompts.py` | +17 -17 — neuter GENERAL_CHAT_PROMPT |
| `tests/test_rag_first_routing.py` | +223 (ใหม่) — 61 test cases ครอบคลุม greeting/non-agri/disease/product/ambiguous |

### บทเรียน
> RAG-first ปลอดภัยกว่า keyword-gating — ส่งทุกอย่างเข้า RAG แล้ว fast-path เฉพาะ greeting/non-agri ที่ชัดเจน

---

## 2. Enrich Product Metadata from DB — แก้ Follow-up ข้อมูลสินค้า

**เวลา**: 13:30 | **Commit**: `6d0af63` | **ประเภท**: Bug Fix

### ปัญหา
- **Bug A**: RAG path บันทึกแค่ `product_name` ลง memory — follow-up ถามเรื่อง package_size, how_to_use ไม่มีข้อมูล
- **Bug B**: คำถาม follow-up ที่ไม่พูดชื่อสินค้า (เช่น "กี่กระสอบ") ดึงข้อมูลไม่ได้เพราะไม่รู้ว่าถามสินค้าไหน

### สิ่งที่แก้ไข
- **Bug A**: RAG path บันทึก full product data (package_size, how_to_use, phytotoxicity ฯลฯ) ลง memory แทนที่จะบันทึกแค่ชื่อ
- **Bug B**: เมื่อ follow-up ไม่มีชื่อสินค้า → auto-enrich สินค้าทั้งหมดใน memory จาก DB เพื่อเติมฟิลด์ที่ขาด

### ไฟล์ที่แก้ไข
| ไฟล์ | การเปลี่ยนแปลง |
|---|---|
| `app/services/chat/handler.py` | +37 -7 — DB enrichment logic |

### บทเรียน
> Memory metadata ต้องเก็บข้อมูลสินค้าครบถ้วน — ถ้าเก็บแค่ชื่อ follow-up จะพัง

---

## 3. Phytotoxicity Field — เพิ่มข้อมูลพิษต่อพืช

**เวลา**: 14:13 | **Commit**: `82bd1a6` | **ประเภท**: Feature

### สิ่งที่ทำ
เพิ่มฟิลด์ `phytotoxicity` (ความเป็นพิษต่อพืชประธาน) ตลอดทั้ง pipeline:

### ไฟล์ที่แก้ไข
| ไฟล์ | การเปลี่ยนแปลง |
|---|---|
| `app/services/rag/retrieval_agent.py` | +1 — เพิ่มใน doc metadata |
| `app/services/rag/response_generator_agent.py` | +4 — แสดงใน LLM context (2 จุด) |
| `app/services/chat/handler.py` | +4 -2 — DB select, enrich keys, usage prompt |
| `app/services/memory.py` | +1 — เพิ่มใน product recommendation metadata |
| `app/routers/admin.py` | +1 — เพิ่มใน embedding text |
| `scripts/regenerate_all_embeddings.py` | +1 — เพิ่มใน embedding text |

### หมายเหตุ
- Regenerate embeddings สินค้าทั้ง 46 รายการเรียบร้อย
- ข้อมูลจะแสดงเมื่อ user ถามเรื่องวิธีใช้สินค้า

---

## 4. Facebook Messenger Integration — Phase 1: Text Only

**เวลา**: 16:53 | **Commit**: `2188a09` | **ประเภท**: Feature

### สิ่งที่ทำ
เพิ่ม Facebook Messenger webhook เป็น channel ที่สอง (ต่อจาก LINE) — Phase 1 รองรับแค่ข้อความ text

### ไฟล์ที่แก้ไข
| ไฟล์ | การเปลี่ยนแปลง |
|---|---|
| `app/config.py` | +5 — FB_PAGE_ACCESS_TOKEN, FB_VERIFY_TOKEN, FB_APP_SECRET |
| `app/utils/facebook/__init__.py` | +1 (ใหม่) |
| `app/utils/facebook/helpers.py` | +98 (ใหม่) — send_message, verify_signature, send_typing, split_message |
| `app/routers/facebook_webhook.py` | +121 (ใหม่) — GET verify + POST message handler |
| `app/main.py` | +4 -1 — wire FB router + startup log |

### รายละเอียดสำคัญ
- **User ID**: namespaced เป็น `fb:{psid}` เพื่อแยก memory จาก LINE users
- **Message splitting**: FB มี limit 2000 ตัวอักษร → split ที่ขอบประโยค
- **Signature verification**: HMAC-SHA256 ด้วย FB_APP_SECRET
- **Typing indicator**: ส่ง typing_on ก่อนเริ่มประมวลผล

### สิ่งที่ยังไม่ทำ (Phase 2)
- Flex message → FB Generic Template / Button Template
- รูปภาพสินค้า
- Quick replies
- Postback handling

---

## สรุปไฟล์ที่เปลี่ยนแปลงทั้งหมด

```
 app/config.py                                |   5 +
 app/main.py                                  |   5 +-
 app/prompts.py                               |  34 ++--
 app/routers/admin.py                         |   1 +
 app/routers/facebook_webhook.py              | 121 +++ (ใหม่)
 app/services/chat/handler.py                 | 141 ++++---
 app/services/memory.py                       |   1 +
 app/services/rag/response_generator_agent.py |   4 +
 app/services/rag/retrieval_agent.py          |   1 +
 app/utils/facebook/__init__.py               |   1 + (ใหม่)
 app/utils/facebook/helpers.py                |  98 +++ (ใหม่)
 scripts/regenerate_all_embeddings.py         |   1 +
 tests/test_rag_first_routing.py              | 223 +++ (ใหม่)
 13 files changed, 584 insertions(+), 52 deletions(-)
```
