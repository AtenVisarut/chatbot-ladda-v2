# üîÑ ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö: ‡∏à‡∏≤‡∏Å Detect ‡∏ñ‡∏∂‡∏á ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö

## üìã ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç
1. [‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î](#‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
2. [Step-by-Step ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î](#step-by-step-‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
3. [‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢](#‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)
4. [‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á](#‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)

---

## üéØ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FLOW ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ (LINE App)
        ‚Üì
2. LINE Server ‡∏™‡πà‡∏á Webhook ‚Üí FastAPI
        ‚Üì
3. ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å LINE
        ‚Üì
4. ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        ‚Üì
5. ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ä‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä, ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£)
        ‚Üì
6. ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ + ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí OpenAI Vision
        ‚Üì
7. OpenAI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‚Üí ‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
        ‚Üì
8. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏ô Supabase
        ‚Üì
9. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        ‚Üì
10. ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE
        ‚Üì
11. ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‚úÖ
```

---

## üìù Step-by-Step ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î

### **STEP 1: ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ**

```
‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£: [‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤]
         [‡∏Å‡∏î‡∏™‡πà‡∏á‡πÉ‡∏ô LINE Chat]
```

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô**:
- LINE App ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ
- ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE Server
- LINE Server ‡∏™‡∏£‡πâ‡∏≤‡∏á `message_id` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ

---

### **STEP 2: LINE ‡∏™‡πà‡∏á Webhook**

LINE Server ‡∏™‡πà‡∏á HTTP POST ‡∏°‡∏≤‡∏ó‡∏µ‡πà:
```
POST https://your-server.com/webhook
```

**Payload ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤**:
```json
{
  "events": [
    {
      "type": "message",
      "replyToken": "abc123...",
      "source": {
        "userId": "U1234567890",
        "type": "user"
      },
      "timestamp": 1699612345678,
      "message": {
        "type": "image",
        "id": "456789012345"
      }
    }
  ]
}
```

**‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö**:
```python
@app.post("/webhook")
async def webhook(request: Request, x_line_signature: str = Header(None)):
    # 1. ‡∏£‡∏±‡∏ö body
    body = await request.body()
    
    # 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö signature (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏•‡∏≠‡∏°)
    if not verify_line_signature(body, x_line_signature):
        raise HTTPException(403, "Invalid signature")
    
    # 3. ‡πÅ‡∏õ‡∏•‡∏á JSON
    webhook_data = json.loads(body.decode("utf-8"))
    events = webhook_data.get("events", [])
    
    # 4. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞ event
    for event in events:
        await process_event(event)
```

---

### **STEP 3: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å LINE**

**‡πÇ‡∏Ñ‡πâ‡∏î**:
```python
async def get_image_content_from_line(message_id: str) -> bytes:
    """‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å LINE"""
    
    # 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á URL
    url = f"https://api-data.line.me/v2/bot/message/{message_id}/content"
    
    # 2. ‡πÉ‡∏™‡πà Access Token
    headers = {
        "Authorization": f"Bearer {LINE_CHANNEL_ACCESS_TOKEN}"
    }
    
    # 3. ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.get(url, headers=headers)
        response.raise_for_status()
        return response.content  # ‡πÑ‡∏î‡πâ bytes ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**: 
- ‡πÑ‡∏î‡πâ `image_bytes` (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö binary)
- ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 500KB - 2MB

---

### **STEP 4: ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°**

**‡πÇ‡∏Ñ‡πâ‡∏î**:
```python
if message_type == "image":
    # ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
    image_bytes = await get_image_content_from_line(message_id)
    
    # ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô memory
    user_id = event["source"]["userId"]
    pending_image_contexts[user_id] = {
        "image_bytes": image_bytes,
        "reply_token": reply_token
    }
    
    # ‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    ask_message = """
    ‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞
    
    üìù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:
    
    1Ô∏è‚É£ ‡∏ä‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä: ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á/‡∏Ç‡πâ‡∏≤‡∏ß?
    2Ô∏è‚É£ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ö/‡∏•‡∏≥‡∏ï‡πâ‡∏ô/‡∏ú‡∏•?
    3Ô∏è‚É£ ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: ‡∏™‡∏µ, ‡∏Ç‡∏ô‡∏≤‡∏î, ‡∏°‡∏µ‡πÅ‡∏°‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
    4Ô∏è‚É£ ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?
    """
    
    await reply_line(reply_token, ask_message)
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**:
- ‡∏£‡∏π‡∏õ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô `pending_image_contexts[user_id]`
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

---

### **STEP 5: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**

```
‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£: "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• 
          ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏°‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏µ‡∏î‡∏≥ ‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤ 3 ‡∏ß‡∏±‡∏ô"
```

**‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö**:
```python
elif message_type == "text":
    text = message.get("text", "").strip()
    user_id = event["source"]["userId"]
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if user_id in pending_image_contexts:
        # ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
        ctx = pending_image_contexts.pop(user_id)
        image_bytes = ctx["image_bytes"]
        
        # ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡πà‡∏≠
        await process_detection(image_bytes, text, reply_token)
```

---

### **STEP 6: ‡∏™‡πà‡∏á‡πÑ‡∏õ OpenAI Vision**

**‡πÇ‡∏Ñ‡πâ‡∏î**:
```python
async def detect_disease(image_bytes: bytes, extra_user_info: str = None):
    """‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢ OpenAI Vision"""
    
    # 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô base64
    image_base64 = base64.b64encode(image_bytes).decode('utf-8')
    
    # 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á prompt
    prompt = """
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä
    
    ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏:
    - ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ/‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä
    - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤/‡πÑ‡∏ß‡∏£‡∏±‡∏™/‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä)
    - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (0-100%)
    - ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô
    - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
    
    ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    """
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    if extra_user_info:
        prompt += f"\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {extra_user_info}"
    
    # 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OpenAI API
    response = openai_client.chat.completions.create(
        model="gpt-4o",  # Model ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{image_base64}"
                        }
                    }
                ]
            }
        ],
        max_tokens=800
    )
    
    # 4. ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    raw_text = response.choices[0].message.content
    
    return raw_text
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å OpenAI**:
```json
{
  "disease_name": "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü",
  "pest_type": "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä",
  "confidence_level_percent": 85,
  "confidence": "‡∏™‡∏π‡∏á",
  "symptoms_in_image": "‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏°‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å",
  "symptoms": "‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô‡∏á‡∏≠ ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏ô‡πÉ‡∏ö ‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏µ‡∏î‡∏≥ ‡∏Ç‡∏ô‡∏≤‡∏î 1-2 ‡∏°‡∏°.",
  "possible_cause": "‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏´‡πâ‡∏á",
  "severity_level": "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á",
  "severity": "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á - ‡∏Ñ‡∏ß‡∏£‡∏£‡∏µ‡∏ö‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏û‡∏£‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢",
  "description": "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡∏•‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å ‡∏î‡∏π‡∏î‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ö ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß"
}
```

---

### **STEP 7: ‡πÅ‡∏õ‡∏•‡∏á JSON ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Object**

**‡πÇ‡∏Ñ‡πâ‡∏î**:
```python
# ‡πÅ‡∏õ‡∏•‡∏á JSON string ‚Üí Python dict
data = json.loads(raw_text)

# ‡∏™‡∏£‡πâ‡∏≤‡∏á object
result = DiseaseDetectionResult(
    disease_name="‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü",
    confidence="85",
    symptoms="‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô‡∏á‡∏≠ ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏ô‡πÉ‡∏ö...",
    severity="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á",
    raw_analysis="‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä: ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡∏•‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å..."
)
```

---

### **STEP 8: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏ô Supabase**

**‡πÇ‡∏Ñ‡πâ‡∏î**:
```python
async def retrieve_product_recommendation(disease_info):
    """‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"""
    
    # 1. ‡∏î‡∏∂‡∏á keywords ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ
    keywords = ["‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü", "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä", "‡πÅ‡∏°‡∏•‡∏á"]
    
    # 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Supabase
    all_matches = []
    
    for keyword in keywords[:3]:
        response = supabase_client.table('products').select('*').or_(
            f'target_pest.ilike.%{keyword}%,product_name.ilike.%{keyword}%'
        ).limit(10).execute()
        
        if response.data:
            for item in response.data:
                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
                score = 0.5
                if keyword in item.get('target_pest', '').lower():
                    score += 0.3
                if keyword in item.get('product_name', '').lower():
                    score += 0.2
                
                all_matches.append({
                    'similarity': score,
                    **item
                })
    
    # 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    matches = sorted(all_matches, key=lambda x: x['similarity'], reverse=True)[:5]
    
    # 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á recommendations
    recommendations = []
    for match in matches:
        rec = ProductRecommendation(
            product_name=match['product_name'],
            active_ingredient=match['active_ingredient'],
            target_pest=match['target_pest'],
            applicable_crops=match['applicable_crops'],
            how_to_use=match['how_to_use'],
            score=match['similarity']
        )
        recommendations.append(rec)
    
    return recommendations
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå**:
```python
[
    ProductRecommendation(
        product_name="‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50",
        active_ingredient="OMETHOATE 50% W/V SL",
        target_pest="‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏à‡∏±‡∏Å‡∏à‡∏±‡πà‡∏ô‡∏ù‡∏≠‡∏¢",
        applicable_crops="‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡∏ä ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
        how_to_use="‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô 300cc/200L",
        score=0.85
    ),
    ProductRecommendation(
        product_name="‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•‡∏î‡πå 70",
        active_ingredient="IMIDACLOPRID 70% WG",
        target_pest="‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î",
        applicable_crops="‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡∏ä",
        how_to_use="‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô 50-100g/200L",
        score=0.80
    )
]
```

---

### **STEP 9: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö**

**‡πÇ‡∏Ñ‡πâ‡∏î**:
```python
async def generate_final_response(disease_info, recommendations):
    """‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£"""
    
    # Header
    message = f"üîç ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û: {disease_info.disease_name}\n\n"
    
    # Confidence indicator
    confidence_emoji = "üü¢" if "‡∏™‡∏π‡∏á" in disease_info.confidence else "üü°"
    message += f"{confidence_emoji} ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: {disease_info.confidence}\n"
    message += f"üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á: {disease_info.severity}\n\n"
    message += f"üìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô: {disease_info.symptoms}\n\n"
    
    # Products
    if recommendations:
        message += "üíä ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n\n"
        
        for idx, rec in enumerate(recommendations, 1):
            message += f"{idx}. {rec.product_name}\n"
            message += f"   ‚Ä¢ ‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: {rec.active_ingredient}\n"
            message += f"   ‚Ä¢ ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä: {rec.target_pest[:80]}...\n"
            message += f"   ‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä: {rec.applicable_crops[:60]}...\n"
            message += f"   ‚Ä¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: {rec.how_to_use[:80]}...\n"
            message += f"   ‚Ä¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á: {int(rec.score * 100)}%\n\n"
    
    # Footer
    message += "="*40 + "\n"
    message += "üìã ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:\n"
    message += "‚Ä¢ ‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏≤‡∏°‡∏â‡∏•‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ\n"
    message += "‚Ä¢ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç\n\n"
    message += "üìö ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: https://www.icpladda.com/about/\n"
    
    return message
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ**:
```
üîç ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û: ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü

üü¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: 85
üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á: ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á

üìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô: ‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô‡∏á‡∏≠ ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏ô‡πÉ‡∏ö ‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏µ‡∏î‡∏≥

üíä ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:

1. ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50
   ‚Ä¢ ‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: OMETHOATE 50% W/V SL
   ‚Ä¢ ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä: ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏à‡∏±‡∏Å‡∏à‡∏±‡πà‡∏ô‡∏ù‡∏≠‡∏¢
   ‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä: ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡∏ä ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
   ‚Ä¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô 300cc/200L
   ‚Ä¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á: 85%

2. ‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•‡∏î‡πå 70
   ‚Ä¢ ‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: IMIDACLOPRID 70% WG
   ‚Ä¢ ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä: ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î
   ‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä: ‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡∏ä
   ‚Ä¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô 50-100g/200L
   ‚Ä¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á: 80%

========================================
üìã ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:
‚Ä¢ ‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏≤‡∏°‡∏â‡∏•‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ
‚Ä¢ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç

üìö ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: https://www.icpladda.com/about/
```

---

### **STEP 10: ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE**

**‡πÇ‡∏Ñ‡πâ‡∏î**:
```python
async def reply_line(reply_token: str, message: str):
    """‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE"""
    
    # 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á URL
    url = "https://api.line.me/v2/bot/message/reply"
    
    # 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á headers
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {LINE_CHANNEL_ACCESS_TOKEN}"
    }
    
    # 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á payload
    payload = {
        "replyToken": reply_token,
        "messages": [
            {
                "type": "text",
                "text": message
            }
        ]
    }
    
    # 4. ‡∏™‡πà‡∏á HTTP POST
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.post(url, headers=headers, json=payload)
        response.raise_for_status()
    
    logger.info("Reply sent to LINE successfully")
```

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô**:
1. ‡∏™‡πà‡∏á HTTP POST ‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE API
2. LINE Server ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
3. LINE Server ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE App ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
4. ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Chat

---

### **STEP 11: ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö** ‚úÖ

```
[LINE Chat]

Bot: üîç ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û: ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü

     üü¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: 85
     üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á: ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
     
     üìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô: ‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô‡∏á‡∏≠...
     
     üíä ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
     
     1. ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50
        ‚Ä¢ ‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: OMETHOATE 50%
        ...
```

---

## ‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô

| Step | ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ | ‡πÄ‡∏ß‡∏•‡∏≤ |
|------|-----------|------|
| 1-2 | ‡∏£‡∏±‡∏ö Webhook ‡∏à‡∏≤‡∏Å LINE | < 0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| 3 | ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ | 0.5-1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| 4 | ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏° | < 0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| 5 | ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ö | 10-60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| 6 | OpenAI Vision ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå | 3-8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| 7 | ‡πÅ‡∏õ‡∏•‡∏á JSON | < 0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| 8 | ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Supabase | 0.2-0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| 9 | ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° | < 0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| 10 | ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö LINE | 0.2-0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ |
| **‡∏£‡∏ß‡∏°** | **(‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)** | **4-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ** |

---

## üîç ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (Timeline)

```
00:00.000 - ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ
00:00.050 - LINE ‡∏™‡πà‡∏á webhook ‡∏°‡∏≤
00:00.100 - Server ‡∏£‡∏±‡∏ö webhook
00:00.150 - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö signature ‚úì
00:00.200 - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
00:00.800 - ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (500KB)
00:00.850 - ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô memory
00:00.900 - ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
00:01.000 - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

[‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ö 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ]

00:31.000 - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ö "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô..."
00:31.050 - Server ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
00:31.100 - ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å memory
00:31.150 - ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô base64
00:31.500 - ‡∏™‡πà‡∏á‡πÑ‡∏õ OpenAI Vision
00:36.000 - OpenAI ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (4.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
00:36.050 - ‡πÅ‡∏õ‡∏•‡∏á JSON
00:36.100 - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Supabase
00:36.400 - ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
00:36.450 - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
00:36.500 - ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE API
00:36.700 - LINE ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
00:36.800 - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‚úÖ

‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ): 5.8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
```

---

## üíæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ

### 1. In-Memory (RAM)
```python
pending_image_contexts = {
    "U1234567890": {
        "image_bytes": b'\xff\xd8\xff\xe0...',  # ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        "reply_token": "abc123..."
    }
}
```

### 2. Supabase Database
```sql
-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á products
id | product_name | active_ingredient | target_pest | ...
1  | ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50    | OMETHOATE 50%    | ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü    | ...
```

### 3. Logs
```
2025-11-10 15:23:58 - INFO - OpenAI initialized
2025-11-10 15:24:05 - INFO - Pest detected: ‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü (85%)
2025-11-10 15:24:06 - INFO - Found 5 products
2025-11-10 15:24:07 - INFO - Reply sent to LINE
```

---

## üéì ‡∏™‡∏£‡∏∏‡∏õ

### ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å:

1. **Input Processing** (Steps 1-5)
   - ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å LINE
   - ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

2. **AI Analysis** (Steps 6-8)
   - OpenAI Vision ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ
   - ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏ô Supabase

3. **Output Generation** (Steps 9-11)
   - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
   - ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà LINE

### ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
- ‚úÖ ‡πÉ‡∏ä‡πâ **async/await** ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
- ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô **memory** ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
- ‚úÖ ‡πÉ‡∏ä‡πâ **OpenAI Vision** ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
- ‚úÖ ‡πÉ‡∏ä‡πâ **Supabase** ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå
- ‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô **5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ**

---

**‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? üòä**
