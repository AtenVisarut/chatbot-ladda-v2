import logging
import re
import asyncio
from difflib import SequenceMatcher
from typing import List, Dict, Optional, Tuple
from app.services.services import openai_client, supabase_client
from app.services.memory import add_to_memory, get_conversation_context, get_recommended_products, get_enhanced_context
from app.utils.text_processing import extract_keywords_from_question, post_process_answer
from app.services.product_recommendation import recommend_products_by_intent, hybrid_search_products, filter_products_by_category
from app.services.disease_search import search_diseases_by_text, build_context_from_diseases
from app.config import USE_AGENTIC_RAG
from app.prompts import GENERAL_CHAT_PROMPT, ERROR_GENERIC, ERROR_AI_UNAVAILABLE, GREETINGS, GREETING_KEYWORDS

logger = logging.getLogger(__name__)

# Import AgenticRAG (lazy import to avoid circular dependencies)
_agentic_rag = None
_agentic_rag_lock = asyncio.Lock()

async def _get_agentic_rag():
    """Lazy import and get AgenticRAG instance (async-safe with lock)"""
    global _agentic_rag
    if _agentic_rag is not None:
        return _agentic_rag
    if not USE_AGENTIC_RAG:
        return None
    async with _agentic_rag_lock:
        # Double-check after acquiring lock
        if _agentic_rag is None:
            from app.services.agentic_rag import get_agentic_rag
            _agentic_rag = get_agentic_rag()
    return _agentic_rag

# =============================================================================
# ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏∑‡∏ä/‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä/‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£
# =============================================================================
AGRICULTURE_KEYWORDS = [
    # ‡∏û‡∏∑‡∏ä
    "‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏≠‡πâ‡∏≠‡∏¢", "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", "‡∏°‡∏±‡∏ô‡∏™‡∏±‡∏°‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", "‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤", "‡∏õ‡∏≤‡∏•‡πå‡∏°",
    "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á", "‡∏•‡∏≥‡πÑ‡∏¢", "‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà", "‡πÄ‡∏á‡∏≤‡∏∞", "‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î", "‡∏û‡∏£‡∏¥‡∏Å", "‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®", "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î",
    "‡∏ñ‡∏±‡πà‡∏ß", "‡∏ú‡∏±‡∏Å", "‡∏ú‡∏•‡πÑ‡∏°‡πâ", "‡∏Å‡∏•‡πâ‡∏ß‡∏¢", "‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß", "‡∏™‡πâ‡∏°", "‡∏°‡∏∞‡∏ô‡∏≤‡∏ß", "‡∏ù‡∏£‡∏±‡πà‡∏á", "‡∏ä‡∏°‡∏û‡∏π‡πà",
    # ‡πÇ‡∏£‡∏Ñ/‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    "‡πÇ‡∏£‡∏Ñ", "‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä", "‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ", "‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", "‡πÉ‡∏ö‡∏à‡∏∏‡∏î", "‡∏£‡∏≤‡∏Å‡πÄ‡∏ô‡πà‡∏≤", "‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏ô‡πà‡∏≤", "‡∏ú‡∏•‡πÄ‡∏ô‡πà‡∏≤",
    "‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤", "‡πÅ‡∏ö‡∏Ñ‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢", "‡πÑ‡∏ß‡∏£‡∏±‡∏™", "‡πÅ‡∏°‡∏•‡∏á", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢", "‡∏´‡∏ô‡∏≠‡∏ô", "‡∏î‡πâ‡∏ß‡∏á", "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä",
    "‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏£‡∏≤‡πÅ‡∏õ‡πâ‡∏á", "‡∏£‡∏≤‡∏™‡∏ô‡∏¥‡∏°", "‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™", "‡∏Å‡∏¥‡πà‡∏á‡πÅ‡∏´‡πâ‡∏á", "‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡πÄ‡∏ô‡πà‡∏≤",
    # ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "‡∏£‡∏∞‡∏¢‡∏∞", "‡∏ä‡πà‡∏ß‡∏á", "‡∏õ‡∏•‡∏π‡∏Å", "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß", "‡∏î‡∏π‡πÅ‡∏•", "‡∏ö‡∏≥‡∏£‡∏∏‡∏á", "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á", "‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
    "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏", "‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤", "‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô"
]


def is_agriculture_question(message: str) -> bool:
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡∏û‡∏∑‡∏ä/‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    message_lower = message.lower()
    for keyword in AGRICULTURE_KEYWORDS:
        if keyword in message_lower:
            return True
    return False


# =============================================================================
# Keywords ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå
# =============================================================================
PRODUCT_KEYWORDS = [
    "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡∏¢‡∏≤", "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤", "‡∏¢‡∏≤‡∏Å‡∏≥‡∏à‡∏±‡∏î", "‡∏¢‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
    "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÅ‡∏°‡∏•‡∏á", "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡∏´‡∏ç‡πâ‡∏≤", "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤", "‡∏õ‡∏∏‡πã‡∏¢", "‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô",
    "‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ", "‡∏™‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î", "‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô", "‡∏¢‡∏≤‡∏û‡πà‡∏ô", "‡∏¢‡∏≤‡∏â‡∏µ‡∏î",
    "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≤", "‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£", "‡∏¢‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô", "‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ",
    "icp", "ladda", "‡πÑ‡∏≠‡∏ã‡∏µ‡∏û‡∏µ", "‡∏•‡∏±‡∏î‡∏î‡∏≤"
]

# =============================================================================
# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ICP Ladda (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)
# =============================================================================
ICP_PRODUCT_NAMES = {
    # ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏° -> ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î/‡∏¢‡πà‡∏≠)
    "‡∏Å‡∏∞‡∏£‡∏±‡∏ï": ["‡∏Å‡∏∞‡∏£‡∏±‡∏ï", "‡∏Å‡∏∞‡∏£‡∏±‡∏ï 35"],
    "‡∏Å‡πá‡∏≠‡∏õ‡∏Å‡∏±‡∏ô": ["‡∏Å‡πá‡∏≠‡∏õ‡∏Å‡∏±‡∏ô", "‡∏Å‡∏≠‡∏õ‡∏Å‡∏±‡∏ô", "‡∏ó‡πá‡∏≠‡∏õ‡∏Å‡∏±‡∏ô", "‡∏ó‡∏≠‡∏õ‡∏Å‡∏±‡∏ô"],
    "‡∏Ñ‡∏≤‡∏£‡∏¥‡∏™‡∏°‡∏≤": ["‡∏Ñ‡∏≤‡∏£‡∏¥‡∏™‡∏°‡∏≤", "‡∏Ñ‡∏≤‡∏£‡∏¥‡∏™‡∏°‡πà‡∏≤", "‡∏Ñ‡∏≤‡∏£‡∏¥‡∏™"],
    "‡∏ã‡∏¥‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå": ["‡∏ã‡∏¥‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå", "‡∏ã‡∏¥‡∏°‡πÄ‡∏°‡∏≠"],
    "‡∏ã‡∏µ‡πÄ‡∏≠‡πá‡∏°‡∏à‡∏µ": ["‡∏ã‡∏µ‡πÄ‡∏≠‡πá‡∏°‡∏à‡∏µ", "cmg", "‡∏ã‡∏µ‡πÄ‡∏≠‡∏°‡∏à‡∏µ"],
    "‡∏ó‡∏π‡πÇ‡∏ü‡∏ü‡∏≠‡∏™": ["‡∏ó‡∏π‡πÇ‡∏ü‡∏ü‡∏≠‡∏™", "‡∏ó‡∏π‡πÇ‡∏ü", "‡∏ó‡∏π‡πÇ‡∏ü‡πÇ‡∏ü‡∏™"],
    "‡∏ô‡∏≤‡πÅ‡∏î‡∏ô": ["‡∏ô‡∏≤‡πÅ‡∏î‡∏ô", "‡∏ô‡∏≤‡πÅ‡∏î‡∏ô 6 ‡∏à‡∏µ", "‡∏ô‡∏≤‡πÅ‡∏î‡∏ô-‡∏à‡∏µ"],
    "‡∏ö‡∏•‡∏π‡πÑ‡∏ß‡∏ó‡πå": ["‡∏ö‡∏•‡∏π‡πÑ‡∏ß‡∏ó‡πå", "‡∏ö‡∏•‡∏π‡πÑ‡∏ß‡∏ï‡πå"],
    "‡∏û‡∏£‡∏µ‡∏î‡∏¥‡∏Ñ‡∏ó‡πå": ["‡∏û‡∏£‡∏µ‡∏î‡∏¥‡∏Ñ‡∏ó‡πå", "‡∏û‡∏£‡∏µ‡∏î‡∏¥‡∏Ñ", "predict"],
    "‡∏û‡∏≤‡∏™‡∏ô‡∏≤‡∏ß": ["‡∏û‡∏≤‡∏™‡∏ô‡∏≤‡∏ß", "‡∏û‡∏≤‡∏™‡∏ô‡∏≤‡∏ß‡πå"],
    "‡∏û‡∏≤‡∏ô‡∏≤‡∏™": ["‡∏û‡∏≤‡∏ô‡∏≤‡∏™", "‡πÄ‡∏•‡∏Å‡∏≤‡∏ã‡∏µ 20 + ‡∏û‡∏≤‡∏ô‡∏≤‡∏™"],
    "‡∏£‡∏≤‡πÄ‡∏ã‡∏≠‡∏£‡πå": ["‡∏£‡∏≤‡πÄ‡∏ã‡∏≠‡∏£‡πå", "‡πÄ‡∏£‡πÄ‡∏ã‡∏≠‡∏£‡πå"],
    "‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó": ["‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó", "‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ï", "renovate"],
    "‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏£‡∏ô‡∏ï‡πå": ["‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏£‡∏ô‡∏ï‡πå", "‡∏ß‡∏≠‡πÅ‡∏£‡∏ô‡∏ï‡πå", "warrant"],
    "‡∏≠‡∏∞‡∏ô‡∏¥‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î": ["‡∏≠‡∏∞‡∏ô‡∏¥‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î", "‡∏≠‡∏ô‡∏¥‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î"],
    "‡∏≠‡∏±‡∏û‡∏î‡∏≤‡∏ß": ["‡∏≠‡∏±‡∏û‡∏î‡∏≤‡∏ß", "‡∏≠‡∏±‡∏õ‡∏î‡∏≤‡∏ß"],
    "‡∏≠‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏ô": ["‡∏≠‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏ô", "‡∏≠‡∏≤‡∏î‡∏≠‡∏ô"],
    "‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏°‡∏µ‡∏™": ["‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏°‡∏µ‡∏™", "‡∏≠‡∏≤‡πÄ‡∏ó‡∏°‡∏¥‡∏™", "‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏°‡∏¥‡∏™", "artemis"],
    "‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•‡∏î‡πå": ["‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•‡∏î‡πå", "‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤", "‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•", "imidagold", "‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•‡∏î‡πå70", "‡∏≠‡∏¥‡∏°‡∏¥‡∏î‡∏≤‡πÇ‡∏Å‡∏•‡∏î‡πå 70"],
    "‡πÄ‡∏Å‡∏£‡∏Ñ": ["‡πÄ‡∏Å‡∏£‡∏Ñ", "‡πÄ‡∏Å‡∏£‡∏Ñ 5 ‡πÄ‡∏≠‡∏™‡∏ã‡∏µ", "‡πÄ‡∏Å‡∏£‡∏î", "‡πÄ‡∏Å‡∏£‡∏î5", "‡πÄ‡∏Å‡∏£‡∏Ñ5", "‡πÄ‡∏Å‡∏£‡∏î 5"],
    "‡πÄ‡∏Ñ‡πÄ‡∏ã‡∏µ‡∏¢": ["‡πÄ‡∏Ñ‡πÄ‡∏ã‡∏µ‡∏¢", "‡πÄ‡∏Ñ‡πÄ‡∏ã‡∏µ‡∏¢‡πå"],
    "‡πÄ‡∏ó‡∏≠‡∏£‡∏≤‡πÇ‡∏ô‡πà": ["‡πÄ‡∏ó‡∏≠‡∏£‡∏≤‡πÇ‡∏ô‡πà", "‡πÄ‡∏ó‡∏≠‡∏£‡∏≤‡πÇ‡∏ô", "terano"],
    "‡πÄ‡∏ö‡∏ô‡∏ã‡∏≤‡∏ô‡πà‡∏≤": ["‡πÄ‡∏ö‡∏ô‡∏ã‡∏≤‡∏ô‡πà‡∏≤", "‡πÄ‡∏ö‡∏ô‡∏ã‡∏≤‡∏ô‡πà‡∏≤ ‡πÄ‡∏≠‡∏ü"],
    "‡πÄ‡∏°‡∏•‡∏™‡∏±‡∏ô": ["‡πÄ‡∏°‡∏•‡∏™‡∏±‡∏ô", "‡πÄ‡∏°‡∏•‡∏ã‡∏±‡∏ô"],
    "‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå": ["‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠", "‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠‡∏£"],
    "‡πÅ‡∏à‡πä‡∏™": ["‡πÅ‡∏à‡πä‡∏™", "‡πÅ‡∏à‡∏™", "jazz"],
    "‡πÅ‡∏°‡∏™‡∏ü‡∏≠‡∏£‡πå‡∏î": ["‡πÅ‡∏°‡∏™‡∏ü‡∏≠‡∏£‡πå‡∏î", "‡πÅ‡∏°‡∏™‡∏ü‡∏≠‡∏î"],
    "‡πÅ‡∏≠‡∏ô‡∏î‡∏≤‡πÅ‡∏°‡πá‡∏Å‡∏ã‡πå": ["‡πÅ‡∏≠‡∏ô‡∏î‡∏≤‡πÅ‡∏°‡πá‡∏Å‡∏ã‡πå", "‡πÅ‡∏≠‡∏ô‡∏î‡∏≤‡πÅ‡∏°‡∏Å‡∏ã‡πå", "‡πÅ‡∏≠‡∏ô‡∏î‡∏≤‡πÅ‡∏°‡πá‡∏Å", "andamax"],
    "‡πÅ‡∏≠‡∏™‡πÑ‡∏õ‡∏£‡πå": ["‡πÅ‡∏≠‡∏™‡πÑ‡∏õ‡∏£‡πå", "‡πÅ‡∏≠‡∏™‡πÑ‡∏õ‡∏£", "aspire"],
    "‡πÇ‡∏Ñ-‡∏£‡∏≤‡∏ã": ["‡πÇ‡∏Ñ-‡∏£‡∏≤‡∏ã", "‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ã"],
    "‡πÇ‡∏Ñ‡πÄ‡∏ö‡∏¥‡∏•": ["‡πÇ‡∏Ñ‡πÄ‡∏ö‡∏¥‡∏•", "‡πÇ‡∏Ñ‡πÄ‡∏ö‡∏¥‡πâ‡∏•"],
    "‡πÇ‡∏ã‡∏ô‡∏¥‡∏Å": ["‡πÇ‡∏ã‡∏ô‡∏¥‡∏Å", "sonic"],
    "‡πÇ‡∏ó‡∏°‡∏≤‡∏Æ‡∏≠‡∏Ñ": ["‡πÇ‡∏ó‡∏°‡∏≤‡∏Æ‡∏≠‡∏Ñ", "‡πÇ‡∏ó‡∏°‡∏≤‡∏Æ‡∏≠‡∏Å", "tomahawk"],
    "‡πÇ‡∏°-‡πÄ‡∏ã‡πà": ["‡πÇ‡∏°-‡πÄ‡∏ã‡πà", "‡πÇ‡∏°‡πÄ‡∏ã‡πà", "‡πÇ‡∏°‡πÄ‡∏ã"],
    "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô": ["‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô", "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50", "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô50"],
    "‡πÇ‡∏Æ‡∏õ": ["‡πÇ‡∏Æ‡∏õ", "hope"],
    "‡πÑ‡∏ã‡∏°‡πä‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏°‡∏ó": ["‡πÑ‡∏ã‡∏°‡πä‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏°‡∏ó", "‡πÑ‡∏ã‡∏°‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏°‡∏ó", "cymoximate"],
    "‡πÑ‡∏î‡πÅ‡∏û‡πä‡∏Å‡∏ã‡πå": ["‡πÑ‡∏î‡πÅ‡∏û‡πä‡∏Å‡∏ã‡πå", "‡πÑ‡∏î‡πÅ‡∏û‡∏Å‡∏ã‡πå"],
    "‡πÑ‡∏û‡∏£‡∏ã‡∏µ‡∏ô": ["‡πÑ‡∏û‡∏£‡∏ã‡∏µ‡∏ô", "‡πÑ‡∏û‡∏£‡∏ã‡∏¥‡∏ô"],
    "‡πÑ‡∏Æ‡∏ã‡∏µ‡∏™": ["‡πÑ‡∏Æ‡∏ã‡∏µ‡∏™", "‡πÑ‡∏Æ‡∏ã‡∏¥‡∏™", "hysis"],
    "‡∏ä‡∏∏‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á": ["‡∏ä‡∏∏‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á", "‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á"],
    "‡πÄ‡∏•‡∏Å‡∏≤‡∏ã‡∏µ": ["‡πÄ‡∏•‡∏Å‡∏≤‡∏ã‡∏µ", "legacy"],
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å knowledge table
    "‡πÇ‡∏ï‡πÇ‡∏£‡πà": ["‡πÇ‡∏ï‡πÇ‡∏£‡πà", "‡πÇ‡∏ï‡πÇ‡∏£"],
    "‡πÇ‡∏ö‡∏£‡πå‡πÅ‡∏•‡∏ô": ["‡πÇ‡∏ö‡∏£‡πå‡πÅ‡∏•‡∏ô", "‡πÇ‡∏ö‡∏£‡πÅ‡∏•‡∏ô"],
    "‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä": ["‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä"],
    "‡∏ò‡∏≤‡∏ô‡∏≠‡∏™": ["‡∏ò‡∏≤‡∏ô‡∏≠‡∏™", "thanos"],
    "‡πÑ‡∏Å‡∏•‡πÇ‡∏ü‡πÄ‡∏™‡∏ó": ["‡πÑ‡∏Å‡∏•‡πÇ‡∏ü‡πÄ‡∏™‡∏ó", "glyphosate"],
    "‡πÑ‡∏î‡∏û‡∏¥‡∏°": ["‡πÑ‡∏î‡∏û‡∏¥‡∏°", "‡πÑ‡∏î‡∏û‡∏¥‡∏° 90", "‡πÑ‡∏î‡∏û‡∏¥‡∏°90"],
    "‡∏≠‡∏≤‡∏ó‡∏£‡∏≤‡∏ã‡∏µ‡∏ô": ["‡∏≠‡∏≤‡∏ó‡∏£‡∏≤‡∏ã‡∏µ‡∏ô", "‡∏≠‡∏≤‡∏ó‡∏£‡∏≤‡∏ã‡∏µ‡∏ô80", "atrazine"],
    "‡πÄ‡∏ß‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå": ["‡πÄ‡∏ß‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå", "vector"],
}


def extract_product_name_from_question(question: str) -> Optional[str]:
    """
    ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    Returns: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    """
    question_lower = question.lower()

    # Step 1: Exact substring match (‡πÄ‡∏£‡πá‡∏ß)
    for product_name, aliases in ICP_PRODUCT_NAMES.items():
        for alias in aliases:
            if alias.lower() in question_lower:
                return product_name

    # Step 2: Fuzzy match (fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î)
    return fuzzy_match_product_name(question)


def fuzzy_match_product_name(text: str, threshold: float = 0.65) -> Optional[str]:
    """
    Fuzzy matching ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î
    ‡πÄ‡∏ä‡πà‡∏ô "‡πÅ‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠" ‚Üí "‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡πâ‡∏ô" ‚Üí "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô"
    """
    # ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥: ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥ English
    tokens = re.findall(r'[\u0E00-\u0E7F]+|[a-zA-Z]+', text)

    best_match = None
    best_score = 0.0

    for token in tokens:
        if len(token) < 3:  # ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
            continue
        token_lower = token.lower()
        for product_name, aliases in ICP_PRODUCT_NAMES.items():
            for alias in aliases:
                alias_lower = alias.lower()
                # Direct comparison
                score = SequenceMatcher(None, token_lower, alias_lower).ratio()
                if score > best_score and score >= threshold:
                    best_score = score
                    best_match = product_name

                # Sliding window: ‡∏ñ‡πâ‡∏≤ token ‡∏¢‡∏≤‡∏ß‡∏Å‡∏ß‡πà‡∏≤ alias ‡∏°‡∏≤‡∏Å ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö substring
                alias_len = len(alias_lower)
                if len(token_lower) > alias_len + 1 and alias_len >= 3:
                    for i in range(len(token_lower) - alias_len + 2):
                        end = min(i + alias_len + 1, len(token_lower))
                        sub = token_lower[i:end]
                        score = SequenceMatcher(None, sub, alias_lower).ratio()
                        if score > best_score and score >= threshold:
                            best_score = score
                            best_match = product_name

    return best_match


def detect_unknown_product_in_question(question: str) -> Optional[str]:
    """
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô ICP_PRODUCT_NAMES ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    Returns: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ None

    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà user ‡∏ñ‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÄ‡∏ä‡πà‡∏ô "‡πÇ‡∏ï‡πÇ‡∏£‡πà ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á"
    ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô"
    """
    # ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Üí return None
    if extract_product_name_from_question(question):
        return None

    # ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏° (‡∏Ñ‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ, ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°, ‡∏Ñ‡∏≥‡∏Å‡∏£‡∏¥‡∏¢‡∏≤)
    skip_words = [
        '‡∏≠‡∏∞‡πÑ‡∏£', '‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£', '‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà', '‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô', '‡∏Å‡∏µ‡πà', '‡∏ó‡∏≥‡πÑ‡∏°', '‡πÑ‡∏´‡∏°',
        '‡πÉ‡∏ä‡πâ', '‡∏û‡πà‡∏ô', '‡∏â‡∏µ‡∏î', '‡∏ú‡∏™‡∏°', '‡∏Å‡∏≥‡∏à‡∏±‡∏î', '‡∏£‡∏±‡∏Å‡∏©‡∏≤', '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', '‡∏î‡∏µ', '‡πÑ‡∏î‡πâ',
        '‡∏¢‡∏≤', '‡∏™‡∏≤‡∏£', '‡πÇ‡∏£‡∏Ñ', '‡πÅ‡∏°‡∏•‡∏á', '‡∏´‡∏ç‡πâ‡∏≤', '‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä', '‡∏ò‡∏≤‡∏ï‡∏∏', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
        '‡∏Ç‡πâ‡∏≤‡∏ß', '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', '‡∏™‡πâ‡∏°', '‡∏û‡∏£‡∏¥‡∏Å', '‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î', '‡∏≠‡πâ‡∏≠‡∏¢',
        '‡∏ô‡∏≤', '‡πÑ‡∏£‡πà', '‡∏™‡∏ß‡∏ô', '‡∏ï‡πâ‡∏ô', '‡πÉ‡∏ö', '‡∏ú‡∏•', '‡∏î‡∏≠‡∏Å',
        '‡∏Ü‡πà‡∏≤', '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô', '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°', '‡∏Ç‡∏≤‡∏î', '‡∏£‡πà‡∏ß‡∏á', '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡∏à‡∏∏‡∏î',
        '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', '‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î', '‡∏ö‡∏≥‡∏£‡∏∏‡∏á', '‡∏ï‡∏¥‡∏î', '‡∏Å‡∏≤‡∏£'
    ]

    # pattern ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å
    # ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ "XXX ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á" ‡∏ó‡∏µ‡πà XXX ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    import re

    # Pattern 1: "XXX ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á" - XXX ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
    match = re.match(r'^([‡∏Å-‡πôa-zA-Z]+)\s+(?:‡πÉ‡∏ä‡πâ|‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡∏ú‡∏™‡∏°)', question.strip())
    if match:
        potential_product = match.group(1)
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        if potential_product.lower() not in [w.lower() for w in skip_words]:
            if 2 < len(potential_product) < 20:
                return potential_product

    return None


def extract_plant_type_from_question(question: str) -> Optional[str]:
    """
    ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    Returns: ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    """
    # ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
    plants = [
        "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î", "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", "‡∏≠‡πâ‡∏≠‡∏¢", "‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤", "‡∏õ‡∏≤‡∏•‡πå‡∏°",
        "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á", "‡∏•‡∏≥‡πÑ‡∏¢", "‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà", "‡πÄ‡∏á‡∏≤‡∏∞", "‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î", "‡∏û‡∏£‡∏¥‡∏Å", "‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®",
        "‡∏ñ‡∏±‡πà‡∏ß", "‡∏Å‡∏•‡πâ‡∏ß‡∏¢", "‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß", "‡∏™‡πâ‡∏°", "‡∏°‡∏∞‡∏ô‡∏≤‡∏ß", "‡∏ù‡∏£‡∏±‡πà‡∏á", "‡∏ä‡∏°‡∏û‡∏π‡πà",
        "‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î", "‡∏´‡∏≠‡∏°‡πÅ‡∏î‡∏á", "‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", "‡∏ú‡∏±‡∏Å", "‡πÑ‡∏°‡πâ‡∏ú‡∏•"
    ]

    question_lower = question.lower()
    for plant in plants:
        if plant in question_lower:
            return plant
    return None


def is_product_question(message: str) -> bool:
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    message_lower = message.lower()
    for keyword in PRODUCT_KEYWORDS:
        if keyword in message_lower:
            return True
    return False


# =============================================================================
# ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ‡πÇ‡∏£‡∏Ñ vs ‡πÅ‡∏°‡∏•‡∏á vs ‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£ vs ‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä
# =============================================================================
DISEASE_KEYWORDS = [
    # ‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    "‡πÇ‡∏£‡∏Ñ", "‡πÉ‡∏ö‡∏à‡∏∏‡∏î", "‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ", "‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏£‡∏≤‡πÅ‡∏õ‡πâ‡∏á", "‡∏£‡∏≤‡∏™‡∏ô‡∏¥‡∏°", "‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤",
    "‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™", "‡∏ú‡∏•‡πÄ‡∏ô‡πà‡∏≤", "‡∏£‡∏≤‡∏Å‡πÄ‡∏ô‡πà‡∏≤", "‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏ô‡πà‡∏≤", "‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡πÄ‡∏ô‡πà‡∏≤", "‡∏Å‡∏¥‡πà‡∏á‡πÅ‡∏´‡πâ‡∏á",
    "‡∏£‡∏≤‡∏î‡∏≥", "‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•", "‡πÉ‡∏ö‡πÅ‡∏´‡πâ‡∏á", "‡πÑ‡∏ü‡∏ó‡πá‡∏≠‡∏õ", "‡πÉ‡∏ö‡∏ï‡∏¥‡∏î", "‡∏î‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ñ‡∏¥‡∏ô", "‡πÄ‡∏°‡∏•‡πá‡∏î‡∏î‡πà‡∏≤‡∏á",
    # English
    "disease", "fungus", "fungal", "rot", "blight", "mildew", "rust", "anthracnose"
]

INSECT_KEYWORDS = [
    # ‡πÅ‡∏°‡∏•‡∏á (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á "‡πÑ‡∏£" ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞ match ‡∏Å‡∏±‡∏ö "‡∏≠‡∏∞‡πÑ‡∏£")
    "‡πÅ‡∏°‡∏•‡∏á", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢", "‡∏´‡∏ô‡∏≠‡∏ô", "‡∏î‡πâ‡∏ß‡∏á", "‡∏°‡∏î", "‡∏õ‡∏•‡∏ß‡∏Å", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü",
    "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏≠‡πà‡∏≠‡∏ô", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÅ‡∏õ‡πâ‡∏á", "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î", "‡∏´‡∏ô‡∏≠‡∏ô‡∏Å‡∏≠", "‡∏´‡∏ô‡∏≠‡∏ô‡πÄ‡∏à‡∏≤‡∏∞",
    "‡∏´‡∏ô‡∏≠‡∏ô‡πÉ‡∏¢", "‡πÅ‡∏°‡∏•‡∏á‡∏ß‡∏±‡∏ô", "‡∏à‡∏±‡∏Å‡∏à‡∏±‡πà‡∏ô", "‡∏ó‡∏£‡∏¥‡∏õ‡∏™‡πå", "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä",
    "‡πÑ‡∏£‡πÅ‡∏î‡∏á", "‡πÑ‡∏£‡∏Ç‡∏≤‡∏ß", "‡πÑ‡∏£‡πÅ‡∏°‡∏á", "‡∏ï‡∏±‡∏ß‡πÑ‡∏£",
    # English
    "insect", "pest", "aphid", "thrips", "mite", "worm", "caterpillar", "beetle"
]

# ‡πÄ‡∏û‡∏¥‡πà‡∏°: Keywords ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á
NUTRIENT_KEYWORDS = [
    # ‡∏Ç‡∏≤‡∏î‡∏ò‡∏≤‡∏ï‡∏∏/‡∏ö‡∏≥‡∏£‡∏∏‡∏á
    "‡∏Ç‡∏≤‡∏î‡∏ò‡∏≤‡∏ï‡∏∏", "‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏ö‡∏≥‡∏£‡∏∏‡∏á", "‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ò‡∏≤‡∏ï‡∏∏", "‡∏õ‡∏∏‡πã‡∏¢",
    # ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£
    "‡∏î‡∏≠‡∏Å‡∏£‡πà‡∏ß‡∏á", "‡∏ú‡∏•‡∏£‡πà‡∏ß‡∏á", "‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", "‡πÉ‡∏ö‡∏£‡πà‡∏ß‡∏á", "‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏î‡∏≠‡∏Å", "‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ú‡∏•",
    "‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î", "‡∏ú‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î", "‡∏ï‡πâ‡∏ô‡πÇ‡∏ó‡∏£‡∏°", "‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå",
    # ‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á
    "‡∏ï‡∏¥‡∏î‡∏î‡∏≠‡∏Å", "‡∏ï‡∏¥‡∏î‡∏ú‡∏•", "‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏•", "‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏î‡∏≠‡∏Å", "‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ú‡∏•", "‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ï‡πâ‡∏ô",
    "‡πÄ‡∏£‡πà‡∏á‡∏î‡∏≠‡∏Å", "‡πÄ‡∏£‡πà‡∏á‡∏ú‡∏•", "‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï",
    # ‡∏ò‡∏≤‡∏ï‡∏∏‡πÄ‡∏â‡∏û‡∏≤‡∏∞
    "‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°", "‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™", "‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô", "‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°", "‡πÇ‡∏ö‡∏£‡∏≠‡∏ô", "‡∏™‡∏±‡∏á‡∏Å‡∏∞‡∏™‡∏µ", "‡∏ã‡∏¥‡∏á‡∏Ñ‡πå"
]

# ‡πÄ‡∏û‡∏¥‡πà‡∏°: Keywords ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä
WEED_KEYWORDS = [
    "‡∏´‡∏ç‡πâ‡∏≤", "‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä", "‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏´‡∏ç‡πâ‡∏≤", "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡∏´‡∏ç‡πâ‡∏≤", "‡∏´‡∏ç‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô", "‡∏´‡∏ç‡πâ‡∏≤‡∏á‡∏≠‡∏Å",
    "‡πÉ‡∏ö‡πÅ‡∏Ñ‡∏ö", "‡πÉ‡∏ö‡∏Å‡∏ß‡πâ‡∏≤‡∏á", "‡∏Å‡∏Å"
]


# =============================================================================
# Farmer Slang ‚Üí Technical Terms Mapping
# =============================================================================
FARMER_SLANG_MAP = {
    "‡∏¢‡∏≤‡∏î‡∏π‡∏î": {"hint": "‡∏™‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏° (systemic insecticide/fungicide) ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï", "search_terms": ["‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°", "‡∏™‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á", "‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ"]},
    "‡∏¢‡∏≤‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™": {"hint": "‡∏™‡∏≤‡∏£‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ (contact)", "search_terms": ["‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™", "contact"]},
    "‡∏¢‡∏≤‡πÄ‡∏ú‡∏≤‡πÑ‡∏´‡∏°‡πâ": {"hint": "‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡∏´‡∏ç‡πâ‡∏≤‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™", "category": "Herbicide", "search_terms": ["‡πÄ‡∏ú‡∏≤‡πÑ‡∏´‡∏°‡πâ"]},
    "‡∏¢‡∏≤‡∏Ñ‡∏•‡∏∏‡∏°": {"hint": "‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏á‡∏≠‡∏Å (pre-emergent)", "search_terms": ["‡∏Å‡πà‡∏≠‡∏ô‡∏á‡∏≠‡∏Å"]},
    "‡∏ï‡πâ‡∏ô‡πÇ‡∏ó‡∏£‡∏°": {"hint": "‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå/‡∏Ç‡∏≤‡∏î‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "problem_type": "nutrient"},
    "‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô": {"hint": "‡πÉ‡∏ö‡∏°‡πâ‡∏ß‡∏ô‡∏á‡∏≠ ‡∏≠‡∏≤‡∏à‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™", "problem_type": "insect"},
    "‡∏ï‡πâ‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á": {"hint": "‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á/‡∏Ç‡∏≤‡∏î‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "problem_type": "nutrient"},
    "‡∏£‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô": {"hint": "‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏•‡∏≤‡∏¢", "problem_type": "disease"},
    "‡πÅ‡∏°‡∏•‡∏á‡∏Å‡∏±‡∏î": {"hint": "‡πÅ‡∏°‡∏•‡∏á‡∏Å‡∏±‡∏î‡∏Å‡∏¥‡∏ô/‡πÄ‡∏à‡∏≤‡∏∞", "problem_type": "insect"},
    "‡∏´‡∏ô‡∏≠‡∏ô‡πÄ‡∏à‡∏≤‡∏∞": {"hint": "‡∏´‡∏ô‡∏≠‡∏ô‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏≥‡∏ï‡πâ‡∏ô/‡∏ú‡∏•", "problem_type": "insect"},
    "‡∏Ç‡πâ‡∏≤‡∏ß‡∏î‡∏∑‡πâ‡∏≠‡∏¢‡∏≤": {"hint": "‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏î‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£", "problem_type": "weed"},
    "‡∏´‡∏ç‡πâ‡∏≤‡∏î‡∏∑‡πâ‡∏≠": {"hint": "‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏î‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ", "problem_type": "weed"},
    "‡∏î‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ñ‡∏¥‡∏ô": {"hint": "‡πÇ‡∏£‡∏Ñ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏î‡πà‡∏≤‡∏á/‡∏î‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ñ‡∏¥‡∏ô (false smut) ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß", "problem_type": "disease", "search_terms": ["‡πÄ‡∏°‡∏•‡πá‡∏î‡∏î‡πà‡∏≤‡∏á", "‡∏î‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ñ‡∏¥‡∏ô", "false smut"]},
}


def resolve_farmer_slang(query: str) -> dict:
    """
    ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ

    Returns:
        {
            "matched_slangs": [str],
            "hints": str,           # ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° hint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö inject ‡πÄ‡∏Ç‡πâ‡∏≤ LLM prompt
            "search_terms": [str],  # ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö retrieval
            "problem_type": str|None
        }
    """
    result = {
        "matched_slangs": [],
        "hints": "",
        "search_terms": [],
        "problem_type": None,
    }

    query_lower = query.lower()
    hint_parts = []

    for slang, info in FARMER_SLANG_MAP.items():
        if slang in query_lower:
            result["matched_slangs"].append(slang)
            hint_parts.append(f'"{slang}" ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á {info["hint"]}')
            if info.get("search_terms"):
                result["search_terms"].extend(info["search_terms"])
            if info.get("problem_type") and not result["problem_type"]:
                result["problem_type"] = info["problem_type"]

    if hint_parts:
        result["hints"] = "; ".join(hint_parts)

    return result


def detect_problem_type(message: str) -> str:
    """
    ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    Returns: 'disease', 'insect', 'nutrient', 'weed', ‡∏´‡∏£‡∏∑‡∏≠ 'unknown'

    Priority: nutrient > disease > insect > weed > unknown
    (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á" ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö disease)
    """
    message_lower = message.lower()

    # ‡∏ô‡∏±‡∏ö keywords ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    nutrient_count = sum(1 for kw in NUTRIENT_KEYWORDS if kw in message_lower)
    disease_count = sum(1 for kw in DISEASE_KEYWORDS if kw in message_lower)
    insect_count = sum(1 for kw in INSECT_KEYWORDS if kw in message_lower)
    weed_count = sum(1 for kw in WEED_KEYWORDS if kw in message_lower)

    # ‡∏´‡∏≤ max count
    counts = {
        'nutrient': nutrient_count,
        'disease': disease_count,
        'insect': insect_count,
        'weed': weed_count
    }

    max_count = max(counts.values())
    if max_count == 0:
        return 'unknown'

    # Return ‡∏ï‡∏≤‡∏° priority: nutrient > disease > insect > weed
    if counts['nutrient'] == max_count:
        return 'nutrient'
    elif counts['disease'] == max_count:
        return 'disease'
    elif counts['insect'] == max_count:
        return 'insect'
    elif counts['weed'] == max_count:
        return 'weed'
    else:
        return 'unknown'


# =============================================================================
# Vector Search Functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Q&A
# =============================================================================
async def generate_embedding(text: str) -> List[float]:
    """Generate embedding for search query using OpenAI"""
    if not openai_client:
        logger.error("OpenAI client not available")
        return []

    try:
        response = await openai_client.embeddings.create(
            model="text-embedding-3-small",
            input=text,
            encoding_format="float"
        )
        return response.data[0].embedding
    except Exception as e:
        logger.error(f"Failed to generate embedding: {e}")
        return []


async def vector_search_products(query: str, top_k: int = 5) -> List[Dict]:
    """Vector search ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á products"""
    try:
        # ‡πÉ‡∏ä‡πâ hybrid_search_products ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        products = await hybrid_search_products(
            query=query,
            match_count=top_k,
            vector_weight=0.6,
            keyword_weight=0.4
        )
        if products:
            logger.info(f"‚úì Found {len(products)} products via vector search")
        return products or []
    except Exception as e:
        logger.error(f"Product vector search failed: {e}")
        return []


# =============================================================================
# Mapping: problem_type ‚Üí product_category ‡πÉ‡∏ô products table
# =============================================================================
PROBLEM_TYPE_TO_PRODUCT_CATEGORY = {
    'disease': 'Fungicide',
    'insect': 'Insecticide',
    'nutrient': 'Fertilizer',
    'weed': 'Herbicide'
}


async def vector_search_products_for_qa(
    query: str,
    top_k: int = 5,
    validate_product: bool = True,
    problem_type: str = None
) -> Tuple[List[Dict], Optional[str]]:
    """
    Vector search ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á products ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° category/product/plant

    Args:
        query: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
        top_k: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
        validate_product: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        problem_type: 'disease', 'insect', 'nutrient', 'weed' ‡∏´‡∏£‡∏∑‡∏≠ None

    Returns:
        Tuple[results, product_not_found_message]
    """
    if not supabase_client or not openai_client:
        return [], None

    try:
        product_in_question = extract_product_name_from_question(query)
        plant_in_question = extract_plant_type_from_question(query)

        if problem_type is None:
            problem_type = detect_problem_type(query)

        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å products table (hybrid search)
        all_products = await vector_search_products(query, top_k=top_k * 10)

        if not all_products:
            if product_in_question:
                return [], f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö \"{product_in_question}\" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
            return [], None

        logger.info(f"‚úì Found {len(all_products)} products via hybrid search (problem_type={problem_type})")

        filtered_results = all_products

        # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° product_category ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤
        if problem_type in PROBLEM_TYPE_TO_PRODUCT_CATEGORY:
            required_category = PROBLEM_TYPE_TO_PRODUCT_CATEGORY[problem_type]
            category_filtered = filter_products_by_category(filtered_results, required_category)

            if category_filtered:
                filtered_results = category_filtered
                logger.info(f"‚úì Filtered to {len(filtered_results)} {problem_type}-related products")
            else:
                logger.info(f"‚ö†Ô∏è No {problem_type} category found, using all results")

        # ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Üí ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠
        if product_in_question:
            product_lower = product_in_question.lower()
            aliases = ICP_PRODUCT_NAMES.get(product_in_question, [product_in_question])

            matched = []
            for p in filtered_results:
                pname = (p.get('product_name') or '').lower()
                target = (p.get('target_pest') or '').lower()
                for alias in aliases:
                    if alias.lower() in pname or alias.lower() in target:
                        matched.append(p)
                        break

            if matched:
                logger.info(f"‚úì Validated: {len(matched)} results match product '{product_in_question}'")
                return matched[:top_k], None
            else:
                if validate_product:
                    logger.warning(f"‚ö†Ô∏è ‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö '{product_in_question}' ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á")
                    return [], f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö \"{product_in_question}\" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
                else:
                    logger.info(f"‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö '{product_in_question}' ‡∏ï‡∏£‡∏á‡πÜ ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å vector search")
                    return filtered_results[:top_k], None

        # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° plant_type ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡πÉ‡∏ä‡πâ applicable_crops)
        if plant_in_question:
            plant_lower = plant_in_question.lower()
            plant_filtered = []
            for p in filtered_results:
                applicable = (p.get('applicable_crops') or '').lower()
                pname = (p.get('product_name') or '').lower()
                target = (p.get('target_pest') or '').lower()
                if plant_lower in applicable or plant_lower in pname or plant_lower in target:
                    plant_filtered.append(p)

            if plant_filtered:
                filtered_results = plant_filtered
                logger.info(f"‚úì Filtered to {len(filtered_results)} products for plant '{plant_in_question}'")

        return filtered_results[:top_k], None

    except Exception as e:
        logger.error(f"Products vector search for QA failed: {e}")
        return [], None


async def answer_qa_with_vector_search(question: str, context: str = "") -> str:
    """
    ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Q&A ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Vector Search ‡∏à‡∏≤‡∏Å products table ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° category (‡πÇ‡∏£‡∏Ñ vs ‡πÅ‡∏°‡∏•‡∏á)

    Flow ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
    1. ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å user
    2. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    3. ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏°‡∏•‡∏á ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡∏ä ‚Üí ‡∏ñ‡∏≤‡∏°‡∏û‡∏∑‡∏ä‡∏Å‡πà‡∏≠‡∏ô
    4. ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡∏ä ‚Üí ‡∏ñ‡∏≤‡∏°‡∏û‡∏∑‡∏ä‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
    5. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å products table
    6. ‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô DB - ‡∏´‡πâ‡∏≤‡∏° hallucinate
    """
    try:
        logger.info(f"Q&A Vector Search: {question[:50]}...")

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô
        is_product_q = is_product_question(question)
        is_agri_q = is_agriculture_question(question)

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡πÇ‡∏£‡∏Ñ vs ‡πÅ‡∏°‡∏•‡∏á)
        problem_type = detect_problem_type(question)
        plant_in_question = extract_plant_type_from_question(question)
        product_in_question = extract_product_name_from_question(question)

        logger.info(f"Detected: problem_type={problem_type}, plant={plant_in_question}, product={product_in_question}")

        # =================================================================
        # STEP 2: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ") ‚Üí ‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        # =================================================================
        short_questions = ['‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ', '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ', '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏™‡∏°', '‡∏ú‡∏™‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡∏≠‡∏±‡∏ï‡∏£‡∏≤']
        is_very_short = question.strip() in short_questions or (len(question.strip()) < 12 and not product_in_question and not plant_in_question)

        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á
        tank_keywords = ['‡∏ñ‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å', '‡∏ñ‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà', '‡∏ñ‡∏±‡∏á 20', '‡∏ñ‡∏±‡∏á 100', '‡∏ñ‡∏±‡∏á 200', '‡∏ñ‡∏±‡∏á‡∏û‡πà‡∏ô', '‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£']
        is_tank_question = any(kw in question.lower() for kw in tank_keywords)

        if is_tank_question:
            # Extract tank size from question
            tank_size_match = re.search(r'(\d+)\s*‡∏•‡∏¥‡∏ï‡∏£', question)
            if tank_size_match:
         
                tank_size = int(tank_size_match.group(1))
                logger.info(f"‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏á‡∏Ç‡∏ô‡∏≤‡∏î {tank_size} ‡∏•‡∏¥‡∏ï‡∏£")
                # ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠ (‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô response)
            elif '‡∏ñ‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å' in question.lower():
                logger.info(f"‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô")
                return "‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πä‡∏∞‡∏ô‡∏∞‡∏Ñ‡∏∞\n\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏±‡∏á 20 ‡∏•‡∏¥‡∏ï‡∏£: ‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞"
            elif '‡∏ñ‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà' in question.lower():
                logger.info(f"‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô")
                return "‡∏ñ‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£‡∏Ñ‡∏∞ ‡∏ö‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ô‡∏¥‡∏î ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡πà‡∏∞\n\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞\n- ‡∏ñ‡∏±‡∏á 200 ‡∏•‡∏¥‡∏ï‡∏£: ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏≤‡∏°‡∏â‡∏•‡∏≤‡∏Å\n- ‡∏ñ‡∏±‡∏á 100 ‡∏•‡∏¥‡∏ï‡∏£: ‡∏•‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"

        if is_very_short and problem_type == 'unknown' and not is_tank_question:
            logger.info(f"‚ö†Ô∏è ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {question}")
            return "‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏∞\n- ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?\n- ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?\n\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πà‡∏∞"

        # =================================================================
        # STEP 2.5: ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô ICP ‚Üí ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
        # =================================================================
        unknown_product = detect_unknown_product_in_question(question)
        if unknown_product and not product_in_question:
            logger.info(f"‚ö†Ô∏è ‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å: {unknown_product}")
            return f"‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ \"{unknown_product}\" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ICP Ladda ‡∏Ñ‡πà‡∏∞\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞"

        # =================================================================
        # STEP 3: ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏°‡∏•‡∏á ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡∏ä ‚Üí ‡∏ñ‡∏≤‡∏°‡∏û‡∏∑‡∏ä‡∏Å‡πà‡∏≠‡∏ô
        # =================================================================
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° "‡∏£‡∏±‡∏Å‡∏©‡∏≤/‡∏Å‡∏≥‡∏à‡∏±‡∏î" ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        is_treatment_question = any(kw in question.lower() for kw in [
            '‡∏£‡∏±‡∏Å‡∏©‡∏≤', '‡∏Å‡∏≥‡∏à‡∏±‡∏î', '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', '‡πÉ‡∏ä‡πâ‡∏¢‡∏≤', '‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£', '‡∏™‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£',
            '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô', '‡∏Ü‡πà‡∏≤', '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°', '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'
        ])

        # ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏°‡∏•‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡∏ä ‚Üí ‡∏ñ‡∏≤‡∏°‡∏û‡∏∑‡∏ä‡∏Å‡πà‡∏≠‡∏ô
        if problem_type in ['insect', 'disease'] and is_treatment_question and not plant_in_question and not product_in_question:
            logger.info(f"‚ö†Ô∏è ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á {problem_type} ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡∏ä ‚Üí ‡∏ñ‡∏≤‡∏°‡∏û‡∏∑‡∏ä‡∏Å‡πà‡∏≠‡∏ô")
            # Extract ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡πÅ‡∏°‡∏•‡∏á/‡πÇ‡∏£‡∏Ñ ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
            problem_name = ""
            for kw in INSECT_KEYWORDS + DISEASE_KEYWORDS:
                if kw in question.lower() and len(kw) > 2:
                    problem_name = kw
                    break

            if problem_type == 'insect':
                return f"‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Ç‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö \"{problem_name}\" ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Ñ‡πà‡∏∞\n\n‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ö‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡∏ä‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô (‡πÅ‡∏ï‡∏Å‡πÉ‡∏ö‡∏≠‡πà‡∏≠‡∏ô/‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å/‡∏ï‡∏¥‡∏î‡∏ú‡∏•) ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞"
            else:  # disease
                return f"‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Ç‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö \"{problem_name}\" ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Ñ‡πà‡∏∞\n\n‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ö‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡∏ä‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô (‡πÅ‡∏ï‡∏Å‡πÉ‡∏ö‡∏≠‡πà‡∏≠‡∏ô/‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å/‡∏ï‡∏¥‡∏î‡∏ú‡∏•) ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞"

        # ‡πÄ‡∏Å‡πá‡∏ö context ‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ source
        all_context_parts = []

        # 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å products table ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏ó‡∏ô knowledge table)
        product_docs, product_not_found_msg = await vector_search_products_for_qa(
            question,
            top_k=5,
            validate_product=False,
            problem_type=problem_type
        )

        if product_docs:
            products_context = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:\n"
            for idx, doc in enumerate(product_docs[:5], 1):
                product_name = doc.get('product_name', '')
                active_ingredient = doc.get('active_ingredient', '')
                usage_rate = doc.get('usage_rate', '')
                target_pest = doc.get('target_pest', '')
                product_category = doc.get('product_category', '')
                applicable_crops = doc.get('applicable_crops', '')
                how_to_use = doc.get('how_to_use', '')
                usage_period = doc.get('usage_period', '')

                # ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)"
                if active_ingredient:
                    products_context += f"\n[{idx}] {product_name} (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: {active_ingredient})"
                else:
                    products_context += f"\n[{idx}] {product_name}"
                if product_category:
                    products_context += f"\n   ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {product_category}"
                if target_pest:
                    products_context += f"\n   ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏à‡∏±‡∏î: {target_pest[:150]}"
                if applicable_crops:
                    products_context += f"\n   ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: {applicable_crops[:150]}"
                if usage_rate:
                    products_context += f"\n   ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: {usage_rate}"
                if how_to_use:
                    products_context += f"\n   ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: {how_to_use[:200]}"
                if usage_period:
                    products_context += f"\n   ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ: {usage_period[:100]}"

            all_context_parts.append(products_context)
            logger.info(f"Added {len(product_docs)} products to context")

        elif product_not_found_msg:
            logger.warning(f"Product not found: {product_not_found_msg}")
            all_context_parts.append(f"‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: {product_not_found_msg}")

        # 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å diseases (‡πÄ‡∏™‡∏£‡∏¥‡∏° - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ)
        if is_agri_q and problem_type == 'disease':
            diseases = await search_diseases_by_text(question, top_k=2)
            if diseases:
                disease_context = build_context_from_diseases(diseases)
                all_context_parts.append(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ:\n{disease_context}")
                logger.info(f"Added {len(diseases)} diseases to context")

        # ‡∏£‡∏ß‡∏° context ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        combined_context = "\n\n".join(all_context_parts) if all_context_parts else "(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)"

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
        is_what_question = any(kw in question.lower() for kw in ['‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£', '‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£', '‡πÉ‡∏ä‡πâ‡∏≠‡∏∞‡πÑ‡∏£', '‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£', '‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£'])
        is_how_question = any(kw in question.lower() for kw in ['‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£', '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ', '‡∏ú‡∏™‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏á'])
        is_rate_question = any(kw in question.lower() for kw in ['‡∏≠‡∏±‡∏ï‡∏£‡∏≤', '‡∏ú‡∏™‡∏°‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà', '‡∏Å‡∏µ‡πà‡∏ã‡∏µ‡∏ã‡∏µ', '‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£'])
        # ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡∏≤‡∏£
        is_recommend_question = any(kw in question.lower() for kw in ['‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', '‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£', '‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£', '‡∏¢‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô', '‡∏™‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô', '‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô'])

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á prompt ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
        if is_recommend_question and product_docs:
            # ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏°‡∏µ product_docs ‡πÅ‡∏•‡πâ‡∏ß) ‚Üí ‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ
            prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
{combined_context}

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):
1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" + ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ
2. ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ‡πÄ‡∏ä‡πà‡∏ô "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50 (‡πÇ‡∏õ‡∏£‡∏ü‡∏µ‡πÇ‡∏ô‡∏ü‡∏≠‡∏™)"
3. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä ‚Üí ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á:
   - ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏á‡∏≠‡∏Å: ‡πÉ‡∏ä‡πâ "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£)" ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ XX ‡∏°‡∏•./‡πÑ‡∏£‡πà ‡∏û‡πà‡∏ô...
   - ‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏á‡∏≠‡∏Å:
     - ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1: "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£)" XX ‡∏°‡∏•./‡πÑ‡∏£‡πà ...
     - ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2: "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£)" XX ‡∏°‡∏•./‡πÑ‡∏£‡πà ...

4. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡∏•‡∏á/‡πÇ‡∏£‡∏Ñ ‚Üí ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ:
   ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏à‡∏±‡∏î XX ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: XX ‡∏Å‡∏£‡∏±‡∏° ‡∏ï‡πà‡∏≠‡∏ô‡πâ‡∏≥ XX ‡∏•‡∏¥‡∏ï‡∏£
   - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏£‡∏á‡∏û‡∏∏‡πà‡∏°
   - ‡∏ä‡πà‡∏ß‡∏á‡πÉ‡∏ä‡πâ: ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏¢‡∏∞

5. ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢:
   - ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥
   - ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å ‚Üí ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤ "‡∏ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡∏û‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞"

6. ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
7. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ##
8. ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ü¶† üåø üíä üìã ‚öñÔ∏è üìÖ ‚ö†Ô∏è üí°
9. ‡πÉ‡∏ä‡πâ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÜ

‡∏ï‡∏≠‡∏ö:"""
        elif product_in_question and is_what_question:
            # ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö "X ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£" ‚Üí ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ + ‡∏ñ‡∏≤‡∏° follow-up
            prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
{combined_context}

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):
1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ "‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" + ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ
2. ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ‡πÄ‡∏ä‡πà‡∏ô "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50 (‡πÇ‡∏õ‡∏£‡∏ü‡∏µ‡πÇ‡∏ô‡∏ü‡∏≠‡∏™)"
3. ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ (2-3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ)
4. ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
5. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ##
6. ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô üíä üåø üí°
7. ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50 (‡πÇ‡∏õ‡∏£‡∏ü‡∏µ‡πÇ‡∏ô‡∏ü‡∏≠‡∏™)" ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÅ‡∏õ‡πâ‡∏á ‡∏´‡∏ô‡∏≠‡∏ô ‡πÉ‡∏ô‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡πà‡∏∞

‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ, ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏™‡∏°, ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?

‡∏ï‡∏≠‡∏ö:"""
        elif product_in_question and (is_how_question or is_rate_question):
            # ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á ‚Üí ‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏°
            prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
{combined_context}

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ "‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
2. ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ‡πÄ‡∏ä‡πà‡∏ô "‡πÅ‡∏Å‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡πÑ‡∏ã‡∏Æ‡∏≤‡πÇ‡∏•‡∏ü‡∏≠‡∏õ-‡∏ö‡∏¥‡∏ß‡∏ó‡∏¥‡∏•)"
3. ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ:
   ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ... ‡∏Ñ‡πà‡∏∞
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: XX ‡∏Å‡∏£‡∏±‡∏°/‡∏°‡∏•. ‡∏ï‡πà‡∏≠‡∏ô‡πâ‡∏≥ XX ‡∏•‡∏¥‡∏ï‡∏£
   - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô...
   - ‡∏ä‡πà‡∏ß‡∏á‡πÉ‡∏ä‡πâ: ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏¢‡∏∞ / ‡∏ä‡πà‡∏ß‡∏á...

   ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥
   ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å ‚Üí ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤ "‡∏ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡∏û‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞"

4. ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
5. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ##
6. ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô üíä üìã ‚öñÔ∏è ‚ö†Ô∏è üí°
7. ‡πÉ‡∏ä‡πâ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÜ

‡∏ï‡∏≠‡∏ö:"""
        else:
            # ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‚Üí ‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
            prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}

‡∏ö‡∏£‡∏¥‡∏ö‡∏ó: {context if context else "(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà)"}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
{combined_context}

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):
1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ "‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" + ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ
2. ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ‡πÄ‡∏ä‡πà‡∏ô "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50 (‡πÇ‡∏õ‡∏£‡∏ü‡∏µ‡πÇ‡∏ô‡∏ü‡∏≠‡∏™)"

3. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä ‚Üí ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á:
   ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ "‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä" ‡πÉ‡∏ô... ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞
   - ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏á‡∏≠‡∏Å: ‡πÉ‡∏ä‡πâ "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ XX ‡∏°‡∏•./‡πÑ‡∏£‡πà ‡∏û‡πà‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ß‡πà‡∏≤‡∏ô X ‡∏ß‡∏±‡∏ô...
   - ‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏á‡∏≠‡∏Å:
     - ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1: "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" XX ‡∏°‡∏•./‡πÑ‡∏£‡πà ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" XX ‡∏°‡∏•./‡πÑ‡∏£‡πà ‡∏û‡πà‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ß‡πà‡∏≤‡∏ô X ‡∏ß‡∏±‡∏ô...
     - ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2: "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" XX ‡∏°‡∏•./‡πÑ‡∏£‡πà ‡∏û‡πà‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ß‡πà‡∏≤‡∏ô X ‡∏ß‡∏±‡∏ô...

4. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡∏•‡∏á/‡πÇ‡∏£‡∏Ñ ‚Üí ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ:
   ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏à‡∏±‡∏î XX ‡πÉ‡∏ô YY ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: XX ‡∏Å‡∏£‡∏±‡∏° ‡∏ï‡πà‡∏≠‡∏ô‡πâ‡∏≥ XX ‡∏•‡∏¥‡∏ï‡∏£
   - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏£‡∏á‡∏û‡∏∏‡πà‡∏°
   - ‡∏ä‡πà‡∏ß‡∏á‡πÉ‡∏ä‡πâ: ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏¢‡∏∞ ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ï‡∏Å‡πÉ‡∏ö‡∏≠‡πà‡∏≠‡∏ô ‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ú‡∏•

5. ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢:
   - ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥
   - ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å ‚Üí ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤ "‡∏ö‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÉ‡∏ä‡πâ‡∏ñ‡∏±‡∏á‡∏û‡πà‡∏ô‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£ ‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡πà‡∏≠‡∏ñ‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞"

6. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞?"
7. ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
8. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ##
9. ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ü¶† üåø üíä üìã ‚öñÔ∏è üìÖ ‚ö†Ô∏è üí°
10. ‡πÉ‡∏ä‡πâ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÜ

‡∏ï‡∏≠‡∏ö:"""

        if not openai_client:
            return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ"

        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏ö‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡πÜ
        if not product_docs:
            return f"‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Ç‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Ñ‡πà‡∏∞\n\n‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ö‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤:\n- ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡∏ä‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á)\n- ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏Ñ, ‡πÅ‡∏°‡∏•‡∏á, ‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä)\n\n‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞"

        # =================================================================
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏à‡∏≤‡∏Å product_docs ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        # =================================================================
        allowed_products = []
        for doc in product_docs:
            pname = doc.get('product_name', '')
            if pname and pname not in allowed_products:
                allowed_products.append(pname)

        allowed_products_str = ", ".join(allowed_products[:10]) if allowed_products else "(‡πÑ‡∏°‡πà‡∏°‡∏µ)"

        response = await openai_client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤ ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‚õî ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î:

1. ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏°‡∏±‡πà‡∏ß ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
   - ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏´‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏ï‡∏≠‡∏ö‡∏ï‡∏£‡∏á‡πÜ ‡∏ß‡πà‡∏≤:
     "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Ñ‡πà‡∏∞"
   - ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏°‡∏°‡∏ï‡∏¥ ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ

2. ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô):
   [{allowed_products_str}]

3. ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‚Üí ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤:
   "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞"

4. ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î:
   - ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)
   - ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)
   - ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)
   - ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏°‡∏•‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)

5. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ##
   ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ü¶† üåø üíä üìã ‚öñÔ∏è üìÖ ‚ö†Ô∏è üí°
   ‡πÉ‡∏ä‡πâ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÜ

6. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
   - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ "‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" + ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
   - ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)" ‡πÄ‡∏ä‡πà‡∏ô "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50 (‡πÇ‡∏õ‡∏£‡∏ü‡∏µ‡πÇ‡∏ô‡∏ü‡∏≠‡∏™)"
   - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä ‚Üí ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°: ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏á‡∏≠‡∏Å, ‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏á‡∏≠‡∏Å (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1, 2)
   - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡∏•‡∏á/‡πÇ‡∏£‡∏Ñ ‚Üí ‡∏£‡∏∞‡∏ö‡∏∏: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ, ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ, ‡∏ä‡πà‡∏ß‡∏á‡πÉ‡∏ä‡πâ
   - ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢: "‡∏ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡∏û‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞"

7. ‡∏ï‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"""},
                {"role": "user", "content": prompt}
            ],
            max_tokens=600,
            temperature=0.1  # ‡∏•‡∏î temperature ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        )

        answer = post_process_answer(response.choices[0].message.content)
        return answer

    except Exception as e:
        logger.error(f"Error in Q&A vector search: {e}", exc_info=True)
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞"


async def answer_agriculture_question(question: str, context: str = "") -> str:
    """
    ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡∏û‡∏∑‡∏ä/‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä
    1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á diseases ‡∏Å‡πà‡∏≠‡∏ô (vector search)
    2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö ‚Üí ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ + ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏£‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£
    """
    try:
        logger.info(f"üåæ Agriculture question: {question[:50]}...")

        # 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á diseases
        diseases = await search_diseases_by_text(question, top_k=5)

        if diseases:
            # ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á context ‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏û‡∏ö
            disease_context = build_context_from_diseases(diseases)
            logger.info(f"‚úì Found {len(diseases)} related diseases in database")

            prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}

‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:
{context if context else "(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà)"}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
{disease_context}

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):

‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:

ü¶† ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/‡∏õ‡∏±‡∏ç‡∏´‡∏≤
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üåø ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíä ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
1. ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: XX ‡∏ã‡∏µ‡∏ã‡∏µ/‡∏ô‡πâ‡∏≥ XX ‡∏•‡∏¥‡∏ï‡∏£
   - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô/‡∏£‡∏≤‡∏î...

2. ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: ...

üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô

üí° ‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡πÜ

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:
- ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ü¶† üåø üíä üìã ‚öñÔ∏è üìÖ ‚ö†Ô∏è üí°
- ‡πÉ‡∏ä‡πâ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÜ
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡πÉ‡∏ä‡πâ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡πà‡∏≠‡∏¢
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ó‡∏∏‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ##

‡∏ï‡∏≠‡∏ö:"""
        else:
            # ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏ö‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡πÜ ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
            logger.info("‚ö†Ô∏è No diseases found in database, returning no-data message")
            return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Ñ‡πà‡∏∞\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:\n- ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á)\n- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö\n\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞"

        if not openai_client:
            return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ"

        response = await openai_client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": """‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤ ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Ç‡∏≠‡∏á ICP Ladda

‚õî ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å - ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏°‡∏±‡πà‡∏ß‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î:
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
- ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏°‡∏°‡∏ï‡∏¥ ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏≠‡∏á

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ü¶† üåø üíä üìã ‚öñÔ∏è üìÖ ‚ö†Ô∏è üí°
- ‡πÉ‡∏ä‡πâ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÜ
- ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö 1. 2. 3. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
- ‡πÉ‡∏ä‡πâ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡πà‡∏≠‡∏¢ (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ, ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ)
- ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ##
- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ"""},
                {"role": "user", "content": prompt}
            ],
            max_tokens=800,
            temperature=0.2  # ‡∏•‡∏î temperature ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        )

        answer = post_process_answer(response.choices[0].message.content)
        return answer

    except Exception as e:
        logger.error(f"Error answering agriculture question: {e}", exc_info=True)
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞"


# =============================================================================
# ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏Å‡∏≤‡∏£‡∏û‡πà‡∏ô‡∏¢‡∏≤ / ‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î
# =============================================================================
USAGE_QUESTION_PATTERNS = [
    # ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    r"‡∏ß‡∏¥‡∏ò‡∏µ(?:‡πÉ‡∏ä‡πâ|‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡∏ú‡∏™‡∏°)",
    r"‡πÉ‡∏ä‡πâ(?:‡∏¢‡∏±‡∏á|‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)",
    r"‡∏û‡πà‡∏ô(?:‡∏¢‡∏±‡∏á|‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)",
    r"‡∏â‡∏µ‡∏î(?:‡∏¢‡∏±‡∏á|‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)",
    r"‡∏ú‡∏™‡∏°(?:‡∏¢‡∏±‡∏á|‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)",
    # ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô
    r"‡∏≠‡∏±‡∏ï‡∏£‡∏≤(?:‡∏Å‡∏≤‡∏£)?(?:‡πÉ‡∏ä‡πâ|‡∏ú‡∏™‡∏°|‡∏™‡πà‡∏ß‡∏ô)",
    r"‡∏ú‡∏™‡∏°(?:‡∏Å‡∏µ‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£)",
    r"‡πÉ‡∏ä‡πâ(?:‡∏Å‡∏µ‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£)",
    # ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    r"(?:‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡πÉ‡∏ä‡πâ)(?:‡∏ï‡∏≠‡∏ô|‡πÄ‡∏°‡∏∑‡πà‡∏≠|‡∏ä‡πà‡∏ß‡∏á)",
    r"(?:‡∏ï‡∏≠‡∏ô|‡πÄ‡∏°‡∏∑‡πà‡∏≠|‡∏ä‡πà‡∏ß‡∏á)(?:‡πÑ‡∏´‡∏ô|‡πÉ‡∏î).*(?:‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡πÉ‡∏ä‡πâ)",
    # ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞
    r"(?:‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)?(?:‡∏ß‡∏¥‡∏ò‡∏µ|‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô).*(?:‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î|‡πÉ‡∏ä‡πâ|‡∏£‡∏±‡∏Å‡∏©‡∏≤)",
    r"(?:‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î).*(?:‡∏Å‡∏µ‡πà|‡∏ö‡πà‡∏≠‡∏¢|‡∏ñ‡∏µ‡πà)",
    r"(?:‡∏•‡∏∞‡∏•‡∏≤‡∏¢|‡πÄ‡∏à‡∏∑‡∏≠‡∏à‡∏≤‡∏á).*(?:‡∏ô‡πâ‡∏≥|‡∏¢‡∏±‡∏á)",
    # ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
    r"(?:‡∏ï‡∏±‡∏ß)?(?:‡∏ô‡∏µ‡πâ|‡∏ô‡∏±‡πâ‡∏ô|‡πÅ‡∏£‡∏Å|‡∏ó‡∏µ‡πà\d).*(?:‡πÉ‡∏ä‡πâ|‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î)",
    r"(?:‡πÉ‡∏ä‡πâ|‡∏û‡πà‡∏ô|‡∏â‡∏µ‡∏î).*(?:‡∏ï‡∏±‡∏ß)?(?:‡∏ô‡∏µ‡πâ|‡∏ô‡∏±‡πâ‡∏ô|‡πÅ‡∏£‡∏Å|‡∏ó‡∏µ‡πà\d)",
    # ‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏Ç‡∏ô‡∏≤‡∏î/‡∏£‡∏≤‡∏Ñ‡∏≤ (follow-up questions)
    r"(?:‡∏ö‡∏£‡∏£‡∏à‡∏∏|‡∏Ç‡∏ô‡∏≤‡∏î|‡∏£‡∏≤‡∏Ñ‡∏≤).*(?:‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£|‡∏Å‡∏µ‡πà|‡πÑ‡∏´‡∏ô)",
    r"(?:‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå|‡∏ö‡∏£‡∏£‡∏†‡∏±‡∏ì|‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏)",
    r"‡∏°‡∏µ(?:‡∏Å‡∏µ‡πà)?‡∏Ç‡∏ô‡∏≤‡∏î",
    r"(?:‡∏Å‡∏µ‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£).*(?:‡∏ö‡∏≤‡∏ó|‡∏•‡∏¥‡∏ï‡∏£|‡∏°‡∏•\.|‡∏ã‡∏µ‡∏ã‡∏µ|‡∏Å‡∏£‡∏±‡∏°|‡∏Å‡∏Å\.)",
    # ‡∏ñ‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    r"\d+\s*‡πÑ‡∏£‡πà.*(?:‡πÉ‡∏ä‡πâ|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£)",
    r"(?:‡πÉ‡∏ä‡πâ|‡∏û‡πà‡∏ô).*\d+\s*‡πÑ‡∏£‡πà",
]


def is_usage_question(message: str) -> bool:
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
    message_lower = message.lower()
    for pattern in USAGE_QUESTION_PATTERNS:
        if re.search(pattern, message_lower):
            return True
    return False


async def answer_usage_question(user_id: str, message: str, context: str = "") -> str:
    """
    ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô memory

    Flow ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
    1. ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ") ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏û‡∏∑‡∏ä ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö
    2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô memory ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡∏ä ‚Üí ‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å memory
    3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ memory ‚Üí ‡πÑ‡∏õ flow ‡∏õ‡∏Å‡∏ï‡∏¥
    """
    try:
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡∏ä‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        product_in_question = extract_product_name_from_question(message)
        plant_in_question = extract_plant_type_from_question(message)

        # ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ", "‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ") ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö
        short_questions = ['‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ', '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ', '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏™‡∏°', '‡∏ú‡∏™‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á']
        is_short_question = message.strip() in short_questions or len(message.strip()) < 15

        if is_short_question and not product_in_question and not plant_in_question:
            logger.info(f"‚ö†Ô∏è ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {message}")
            return "‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏∞:\n- ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏≤‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?\n- ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?\n\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏±‡∏î‡∏î‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πà‡∏∞"

        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        products = await get_recommended_products(user_id, limit=5)

        if not products:
            return None  # ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô memory ‚Üí ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ flow ‡∏õ‡∏Å‡∏ï‡∏¥

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI
        products_text = ""
        for idx, p in enumerate(products, 1):
            products_text += f"\n[{idx}] {p.get('product_name', 'N/A')}"
            if p.get('how_to_use'):
                products_text += f"\n   ‚Ä¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: {p.get('how_to_use')}"
            if p.get('usage_rate'):
                products_text += f"\n   ‚Ä¢ ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: {p.get('usage_rate')}"
            if p.get('usage_period'):
                products_text += f"\n   ‚Ä¢ ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ: {p.get('usage_period')}"
            if p.get('target_pest'):
                products_text += f"\n   ‚Ä¢ ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏à‡∏±‡∏î: {p.get('target_pest')[:100]}"
            if p.get('applicable_crops'):
                products_text += f"\n   ‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä: {p.get('applicable_crops')[:100]}"
            products_text += "\n"

        prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä‡∏à‡∏≤‡∏Å ICP Ladda

‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:
{products_text}

‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤:
{context if context else "(‡πÑ‡∏°‡πà‡∏°‡∏µ)"}

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {message}

‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î):
- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ "‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" + ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ emoji ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô üòä ‡∏Å‡∏±‡∏ö üå± ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1-2 ‡∏ï‡∏±‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ emoji ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/bullet point/icon ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏µ‡∏î/divider ‡πÄ‡∏ä‡πà‡∏ô ‚îÄ‚îÄ‚îÄ‚îÄ, ‚îÅ‚îÅ‚îÅ‚îÅ, ‚ïê‚ïê‚ïê, ---
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ## ‡∏´‡∏£‡∏∑‡∏≠ markdown ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
- ‡πÉ‡∏ä‡πâ bullet point ‡πÅ‡∏ö‡∏ö "‚Ä¢" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç "1. 2. 3." ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô section/‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ header ‡πÅ‡∏¢‡∏Å
- ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
- ‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡πÉ‡∏ä‡πâ "‡∏°‡∏•." ‡πÅ‡∏ó‡∏ô "cc/‡∏ã‡∏µ‡∏ã‡∏µ" ‡πÄ‡∏™‡∏°‡∏≠; ‡∏Å‡∏£‡∏±‡∏° = "‡∏Å‡∏£‡∏±‡∏°"
- ‡∏ï‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 8-10 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î

[‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏™‡∏°] (‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà)
- ‡∏î‡∏π‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ
- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ 30 ‡∏°‡∏•./‡∏ô‡πâ‡∏≥ 20 ‡∏•‡∏¥‡∏ï‡∏£ + ‡∏ñ‡∏±‡∏á 50 ‡∏•‡∏¥‡∏ï‡∏£ ‚Üí 30 x (50/20) = 75 ‡∏°‡∏•.
- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ 50 ‡∏°‡∏•./‡πÑ‡∏£‡πà + 10 ‡πÑ‡∏£‡πà ‚Üí 50 x 10 = 500 ‡∏°‡∏•.
- ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏£‡∏±‡∏°" ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢ "‡∏Å‡∏£‡∏±‡∏°"

‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢: "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üå±"

‡∏ï‡∏≠‡∏ö:"""

        if not openai_client:
            # Fallback: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
            response = "[‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥]\n"
            for idx, p in enumerate(products[:3], 1):
                response += f"\n{idx}. {p.get('product_name', 'N/A')}"
                if p.get('how_to_use'):
                    response += f"\n   - ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: {p.get('how_to_use')}"
                if p.get('usage_rate'):
                    response += f"\n   - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÉ‡∏ä‡πâ: {p.get('usage_rate')}"
            response += "\n\n[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á]\n‡∏≠‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞"
            return response

        response = await openai_client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": """‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä‡∏à‡∏≤‡∏Å ICP Ladda

‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ emoji ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô üòä ‡∏Å‡∏±‡∏ö üå± ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ emoji ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/bullet point/icon
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏µ‡∏î/divider ‡πÄ‡∏ä‡πà‡∏ô ‚îÄ‚îÄ‚îÄ‚îÄ, ‚îÅ‚îÅ‚îÅ‚îÅ
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ** ‡∏´‡∏£‡∏∑‡∏≠ ## ‡∏´‡∏£‡∏∑‡∏≠ markdown
- ‡πÉ‡∏ä‡πâ bullet point ‡πÅ‡∏ö‡∏ö ‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç 1. 2. 3.
- ‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡πÉ‡∏ä‡πâ "‡∏°‡∏•." ‡πÅ‡∏ó‡∏ô "cc/‡∏ã‡∏µ‡∏ã‡∏µ"
- ‡∏ï‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 8-10 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î"""},
                {"role": "user", "content": prompt}
            ],
            max_tokens=600,
            temperature=0.3
        )

        answer = response.choices[0].message.content.strip()
        answer = answer.replace("**", "").replace("##", "").replace("```", "")
        # ‡∏•‡∏ö emoji ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï ‡πÅ‡∏•‡∏∞ dividers
        import re
        answer = re.sub(r'[‚îÅ‚îÄ‚ïê\-]{3,}', '', answer)  # ‡∏•‡∏ö dividers
        answer = re.sub(r'[üíäüìã‚öñÔ∏èüìÖ‚ö†Ô∏èüí°üî¢üß™‚è∞üåø]', '', answer)  # ‡∏•‡∏ö emoji ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°

        logger.info(f"‚úì Answered usage question from memory products")
        return answer

    except Exception as e:
        logger.error(f"Error answering usage question: {e}", exc_info=True)
        return None

async def handle_natural_conversation(user_id: str, message: str) -> str:
    """Handle natural conversation with context and intent detection"""
    try:
        # 1. Add user message to memory
        await add_to_memory(user_id, "user", message)

        # 2. Get enhanced conversation context (includes summary + products)
        context = await get_enhanced_context(user_id)

        # 3. Check if this is a usage/application question (‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ/‡∏û‡πà‡∏ô/‡∏â‡∏µ‡∏î)
        #    For short ambiguous messages, only route if conversation context involves products
        _is_usage = is_usage_question(message)
        if _is_usage and len(message.strip()) < 20 and not extract_product_name_from_question(message):
            # Short follow-up without product name ‚Äî check if context has product history
            has_product_context = "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" in context or extract_product_name_from_question(context[-500:] if context else "") is not None
            if not has_product_context:
                _is_usage = False
                logger.info(f"Short follow-up '{message[:30]}' has no product context, skip usage flow")

        if _is_usage:
            logger.info(f"üîß Detected usage question: {message[:50]}...")
            usage_answer = await answer_usage_question(user_id, message, context)
            if usage_answer:
                # Add assistant response to memory
                await add_to_memory(user_id, "assistant", usage_answer)
                return usage_answer
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô memory ‚Üí ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ flow ‡∏õ‡∏Å‡∏ï‡∏¥
            logger.info("No products in memory, falling back to normal flow")

        # 4. Analyze intent and keywords
        keywords = extract_keywords_from_question(message)

        # 5. Route based on intent
        # Priority 1: Q&A ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÇ‡∏£‡∏Ñ ‚Üí Vector Search ‡∏à‡∏≤‡∏Å 3 tables
        is_agri_q = is_agriculture_question(message) or keywords["pests"] or keywords["crops"]
        is_prod_q = is_product_question(message) or keywords["is_product_query"]
        is_fert_q = keywords.get("is_fertilizer_query", False)

        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ICP ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏ß‡∏° fuzzy match)
        has_product_name = extract_product_name_from_question(message) is not None

        if is_agri_q or is_prod_q or is_fert_q or has_product_name:
            logger.info(f"üîç Routing to Q&A (agri={is_agri_q}, product={is_prod_q}, fertilizer={is_fert_q}, has_product_name={has_product_name})")

            # Use AgenticRAG if enabled
            if USE_AGENTIC_RAG:
                agentic_rag = await _get_agentic_rag()
                if agentic_rag:
                    logger.info("Using AgenticRAG pipeline")
                    rag_response = await agentic_rag.process(message, context, user_id)

                    # Check if AgenticRAG wants to fallback to general chat
                    if rag_response.answer is None:
                        logger.info("AgenticRAG returned None, falling back to general chat")
                        # Fall through to general chat below
                    else:
                        answer = rag_response.answer
                        logger.info(f"AgenticRAG response: confidence={rag_response.confidence:.2f}, grounded={rag_response.is_grounded}")

                        # Track analytics if product recommendation
                        if is_prod_q:
                            from app.services.services import analytics_tracker
                            if analytics_tracker:
                                product_pattern = r'\d+\.\s+([^\n]+?)(?:\n|$)'
                                product_matches = re.findall(product_pattern, answer)
                                product_names = []
                                for match in product_matches:
                                    clean_name = match.split('\n')[0].strip()
                                    clean_name = clean_name.replace('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå:', '').strip()
                                    if clean_name and len(clean_name) > 3:
                                        product_names.append(clean_name)
                                if product_names:
                                    await analytics_tracker.track_product_recommendation(
                                        user_id=user_id,
                                        disease_name="AgenticRAG",
                                        products=product_names[:5]
                                    )
                                    logger.info(f"Tracked {len(product_names)} products from AgenticRAG")

                        # Add assistant response to memory WITH product metadata
                        rag_metadata = {}
                        mentioned_products = [
                            p for p in ICP_PRODUCT_NAMES.keys() if p in answer
                        ]
                        if mentioned_products:
                            rag_metadata["type"] = "product_recommendation"
                            rag_metadata["products"] = [
                                {"product_name": p} for p in mentioned_products[:5]
                            ]
                            # Save first product as current focus for follow-up questions
                            from app.services.memory import save_current_product_focus
                            await save_current_product_focus(user_id, mentioned_products[0])
                        await add_to_memory(user_id, "assistant", answer, metadata=rag_metadata)
                        return answer

            # Fallback to legacy answer_qa_with_vector_search
            logger.info("Using legacy answer_qa_with_vector_search")
            answer = await answer_qa_with_vector_search(message, context)

            # Track analytics if product recommendation
            if is_prod_q:
                from app.services.services import analytics_tracker
                if analytics_tracker:
                    product_pattern = r'\d+\.\s+([^\n]+?)(?:\n|$)'
                    product_matches = re.findall(product_pattern, answer)
                    product_names = []
                    for match in product_matches:
                        clean_name = match.split('\n')[0].strip()
                        clean_name = clean_name.replace('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå:', '').strip()
                        if clean_name and len(clean_name) > 3:
                            product_names.append(clean_name)
                    if product_names:
                        await analytics_tracker.track_product_recommendation(
                            user_id=user_id,
                            disease_name="Q&A",
                            products=product_names[:5]
                        )
                        logger.info(f"Tracked {len(product_names)} products from Q&A")

            # Add assistant response to memory
            await add_to_memory(user_id, "assistant", answer)
            return answer
            
        else:
            # Quick greeting check ‚Äî no LLM needed
            msg_stripped = message.strip().lower()
            if len(msg_stripped) < 30 and any(kw in msg_stripped for kw in GREETING_KEYWORDS):
                import random
                greeting_answer = random.choice(GREETINGS)
                logger.info(f"Greeting detected: '{message[:30]}' ‚Üí instant reply")
                await add_to_memory(user_id, "assistant", greeting_answer)
                return greeting_answer

            logger.info("Routing to general chat")

            if not openai_client:
                logger.error("OpenAI client not available for general chat")
                return ERROR_AI_UNAVAILABLE

            user_prompt = f"""‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤:
{context if context else "(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà)"}

‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {message}

‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô:"""

            try:
                response = await openai_client.chat.completions.create(
                    model="gpt-4o",
                    messages=[
                        {"role": "system", "content": GENERAL_CHAT_PROMPT},
                        {"role": "user", "content": user_prompt}
                    ],
                    max_tokens=300,
                    temperature=0.7
                )
                answer = post_process_answer(response.choices[0].message.content)
            except Exception as llm_err:
                logger.error(f"General chat LLM call failed: {llm_err}", exc_info=True)
                return ERROR_GENERIC

            # Add assistant response to memory
            await add_to_memory(user_id, "assistant", answer)
            return answer

    except Exception as e:
        logger.error(f"Error in natural conversation: {e}", exc_info=True)
        return ERROR_GENERIC
