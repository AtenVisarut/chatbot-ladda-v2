================================================================================
CHANGELOG — 2026-02-05
================================================================================

================================================================================
14. Fix: Disease Fallback Search + Grounding Override สำหรับโรคหายาก
================================================================================

  ปัญหา:
    Bot ตอบ "ฟิวสาเรียม ใช้ยาอะไร" ไม่ได้ (ตอบว่า "ยังไม่พบตัวที่เหมาะ")
    แม้ว่าอาร์เทมีสจะมี "ฟิวซาเรียม" อยู่ใน target_pest แล้ว (จาก fix ข้อ 13)

  Root Causes (3 ชั้น):
    1. Vector similarity ต่ำเกินไป (0.187 < threshold 0.25)
       — embedding ของ Artemis มีข้อมูลเยอะ ทำให้ Fusarium ถูก "เจือจาง"
    2. Keyword search ไม่ทำงาน — tsvector tokenize ภาษาไทยผิด
       (ได้ 'ฟิวซเรียม' แทน 'ฟิวซาเรียม')
    3. Grounding Agent reject (confidence=0.0) → Response Generator
       return "ไม่พบ" แทนที่จะส่งต่อให้ LLM ตอบ

  แก้ไข (3 ไฟล์):

    app/services/agents/retrieval_agent.py
      - เพิ่ม _search_by_target_pest(): fallback ค้นหา target_pest โดยตรง
        เมื่อ vector search ไม่เจอสินค้าที่ตรงกับโรค
      - เพิ่ม _extract_disease_from_query(): ดึงชื่อโรคจาก query text
        เมื่อ Agent 1 ไม่ได้ extract disease_name entity
      - Logic: ถ้า intent=DISEASE_TREATMENT + docs ไม่มีโรคนั้นใน target_pest
        → ค้นหา target_pest ILIKE '%variant%' → merge เข้า docs

    app/services/agents/response_generator_agent.py
      - เพิ่ม disease override: เมื่อ grounding=False + confidence<0.2
        แต่ disease_name ตรงกับ target_pest ของสินค้า → bypass grounding rejection
      - คล้ายกับ crop-specific override ที่มีอยู่แล้ว

    app/utils/text_processing.py
      - เพิ่ม 2 spelling variants ใน _SPELLING_VARIANTS:
        "แอนแทคโนส" → "แอนแทรคโนส" (ขาด ร)
        "ฟิวสาเรียม" → "ฟิวซาเรียม" (ส แทน ซ)

  ทดสอบ:
    Q1: "ฟิวสาเรียม ใช้ยาอะไรรักษาครับ" → แนะนำอาร์เทมีส ✓
    Q2: "แอนแทคโนสมียารักษาไหม" → แนะนำอาร์เทมีส + โค-ราซ + ไซม๊อกซิเมท ✓
    Regression test: 16/20 passed (เท่าเดิม, ไม่มี regression)

  Commit: 5e6ac1f

================================================================================
13. Fix: เพิ่ม Fusarium ใน Artemis target_pest + embedding + variants
================================================================================

  ปัญหา:
    Bot ตอบเรื่อง "ฟิวซาเรียม" ไม่ได้ เพราะไม่มีสินค้าที่ระบุว่ารักษา
    โรค Fusarium ใน target_pest ทั้งที่อาร์เทมีส (ไดฟีโนโคนาโซล + อะซ๊อคซีสโตรบิน)
    สามารถรักษาโรคนี้ได้

  แก้ไข:

    scripts/add_fusarium_to_artemis.py (สร้างใหม่)
      - อัปเดต target_pest ของอาร์เทมีส (id=263) เพิ่ม:
        (ทุเรียน) ... ฟิวซาเรียม
        (ทั่วไป) โรคเชื้อราฟิวซาเรียม (Fusarium)
      - Regenerate embedding ด้วย Fusarium keywords:
        "โรคเชื้อรา: ฟิวซาเรียม Fusarium โรคเหี่ยว โรคเน่า wilt"
      - ผลลัพธ์: embedding 1536 dimensions, verified ใน Supabase

    app/utils/text_processing.py
      - เพิ่ม Fusarium spelling variants:
        "ฟิวซาเลี่ยม" → "ฟิวซาเรียม"
        "ฟิวเซอเรียม" → "ฟิวซาเรียม"
        "ฟูซาเรียม" → "ฟิวซาเรียม"

  Commit: 55cb368

================================================================================
12. Fix: Thai Disease Name Transliteration Variants
================================================================================

  ปัญหา:
    User พิมพ์ "แอคแทคโนส" แต่ database มี "แอนแทรคโนส"
    → exact substring match fail → Bot ตอบว่าไม่มียารักษา

  แก้ไข:

    app/utils/text_processing.py — generate_thai_disease_variants()
      - เพิ่ม _SPELLING_VARIANTS dictionary สำหรับ Thai transliteration:
        แอคแทคโนส ↔ แอนแทรคโนส
        แอนแทรกโนส → แอนแทรคโนส
        แอนเทรคโนส → แอนแทรคโนส
        ไฟท็อปโทร่า ↔ ไฟทอปธอร่า
        ดาวนี่มิลดิว → ราน้ำค้าง
        พาวเดอรี่มิลดิว → ราแป้ง
      - หมายเหตุ: ลบ n-gram fuzzy matching ออก เพราะ false positive
        (ขอบใบแห้ง matched กาบใบแห้ง ซึ่งเป็นโรคคนละตัว)

  ทดสอบ: 8/8 tests passed (test_disease_variants.py)

  Commit: 135d1ff

================================================================================
11. Fix: Disease-Target_Pest Validation — ป้องกันแนะนำยาผิดโรค
================================================================================

  ปัญหา:
    Bot แนะนำ "รีโนเวท" สำหรับ "โรคขอบใบแห้ง" (bacterial)
    ทั้งที่รีโนเวทเป็น Fungicide ไม่ได้รักษา bacterial disease
    Bot แนะนำ "อาร์เทมีส" สำหรับ "ใบเหลืองข้าว" (viral)
    ทั้งที่ไม่มียาในระบบรักษาโรคไวรัส

  สาเหตุ:
    - system hard-codes DISEASE_TREATMENT → Fungicide category
    - ไม่มีการตรวจสอบว่าโรคที่ถามอยู่ใน target_pest ของสินค้าจริงหรือไม่
    - vector search หาสินค้าจาก semantic similarity เท่านั้น

  แก้ไข:

    app/services/agents/response_generator_agent.py (lines 251-268)
      - เพิ่มการ validate: ตรวจสอบว่า disease_name จาก query_analysis
        ปรากฏใน target_pest ของสินค้าที่ดึงมาหรือไม่
      - ถ้าไม่เจอ → inject disease_mismatch_note เข้าไปใน LLM prompt:
        "ห้ามแนะนำสินค้าใดๆ สำหรับโรคนี้"
      - ใช้ generate_thai_disease_variants() เพื่อ match variants

    app/prompts.py
      - เพิ่มกฎข้อ 7: "ห้ามแนะนำสินค้าสำหรับโรคที่ไม่ปรากฏใน target_pest"

  Commit: 85abaf1

================================================================================
9. Update: product_category → กลุ่มสาร (English) จาก CSV
================================================================================

  ปัญหา:
    product_category ใน Supabase เก็บค่าเป็นภาษาไทย (ป้องกันโรค, กำจัดแมลง,
    กำจัดวัชพืช) ซึ่งไม่ตรงกับ "กลุ่มสาร" ใน CSV ต้นทาง
    พรีดิคท์ 3 ตัว (25, 15, 10%) มี product_category = NULL

  สิ่งที่ทำ:

    A. อัพเดตข้อมูล Supabase (44 products ทั้งหมด)
       ค่าเก่า (Thai)         → ค่าใหม่ (English)    จำนวน
       ป้องกันโรค             → Fungicide             11
       กำจัดแมลง              → Insecticide           16
       กำจัดวัชพืช            → Herbicide             14
       NULL (พรีดิคท์)         → PGR                   3

    B. อัพเดตโค้ด (5 ไฟล์) ให้ใช้ค่า English ใหม่

       app/services/agents/retrieval_agent.py
         - intent_cat_map (line ~260): Thai → English
         - intent_category_map (line ~456): เพิ่ม English + backward compat Thai
         - intent_category_map (line ~648): Thai → English

       app/services/product_recommendation.py
         - CATEGORY_SYNONYMS: key เปลี่ยนเป็น English, เก็บ Thai ใน synonyms
         - get_required_category(): return English (Fungicide/Insecticide/Herbicide)
         - filter_products_by_category(): wrong_categories set ใช้ English
         - normalize_category(): รองรับทั้ง English ใหม่ + Thai เก่า
         - hardcoded "กำจัดแมลง" 3 จุด → "Insecticide"

       app/services/chat.py
         - PROBLEM_TYPE_TO_PRODUCT_CATEGORY: Thai → English

       app/services/reranker.py
         - category_map: key เปลี่ยนเป็น English
         - prompt template: category_map.get() ใช้ English key

       scripts/add_pathogen_type.py
         - get_pathogen_type(): รองรับทั้ง English ใหม่ + Thai เก่า
         - เพิ่ม PGR case

  Backward Compatibility:
    CATEGORY_SYNONYMS เก็บทั้ง Thai + English ใน synonym list
    normalize_category("กำจัดแมลง") → "Insecticide" (ยังทำงานได้)

  Scripts สร้างใหม่:
    scripts/update_group_sar.py — อ่าน CSV, match product_name, update Supabase

  ทดสอบ:
    test_category_update.py — 47/48 passed
      - DB values: ไม่มี NULL, ทุกค่าเป็น English ถูกต้อง
      - Logic: normalize, filter, mapping ทำงานถูก
      - DB Query: eq, ilike, in_ ค้นหาได้ถูกต้อง
      - Pipeline: Fungicide/Herbicide 100% correct top results
                  Insecticide majority correct (4/5)

    test_accuracy_check.py — 4 คำถามจริง ถูกทั้งหมด
      Q1: หนอนกอในนาข้าว → นาแดน-จี, โฮป, ไฮซีส (Insecticide)
      Q2: พรีดิคท์ 25 ใช้กับส้มได้ไหม → พรีดิคท์ 25 (PGR)
      Q3: ราเซอร์ คุมถั่วเหลืองได้ไหม → ราเซอร์ (Herbicide)
      Q4: โฮปใช้ในข้าวช่วงอายุกี่วัน → โฮป (Insecticide)

  ผลกระทบ: ไม่กระทบความแม่นยำ ทดสอบแล้วทุกคำถามตอบถูกต้อง

================================================================================
10. Fix: ป้องกัน Hallucinated Product — แนะนำสินค้าที่ไม่มีใน database
================================================================================

  ปัญหา:
    Bot แนะนำ "คอมแพ็ค (METALAXYL + MANCOZEB)" ซึ่งไม่มีใน products table
    LLM ใช้ความรู้ทั่วไปสร้างสินค้าขึ้นมาเอง เมื่อ user ถาม "มีตัวอื่นอีกไหม"

  สาเหตุ:
    - LLM (gpt-4o-mini) รู้จักสินค้าเคมีเกษตรจากข้อมูลทั่วไป
    - เมื่อ retrieved docs มีสินค้าน้อย + user ขอเพิ่ม → LLM แต่งสินค้าขึ้นมา
    - Prompt เดิมบอกแค่ "ห้ามแต่งข้อมูล" แต่ไม่ได้ห้ามชัดเจนพอ

  แก้ไข (2 ชั้น):

    ชั้น 1: Prompt Strengthening (app/prompts.py)
      - เพิ่มกฎข้อ 2: "ห้ามแนะนำสินค้าที่ไม่ได้อยู่ในข้อมูลที่ผ่านการตรวจสอบ
        แล้วเด็ดขาด — แม้จะรู้จักสินค้าตัวอื่นก็ห้ามพูดถึง
        ถ้าไม่มีสินค้าเพิ่มเติมให้ตอบว่า 'จากข้อมูลที่มี มีเท่านี้ค่ะ'"

    ชั้น 2: Post-processing Validation (response_generator_agent.py)
      - เพิ่ม _validate_product_names() method
      - ดึงชื่อสินค้าจากเครื่องหมายคำพูด (ทั้ง straight "" และ curly "")
      - ตัด parenthetical ออก เช่น "(METALAXYL + MANCOZEB)"
      - ตรวจสอบกับ retrieved docs + ICP_PRODUCT_NAMES
      - ถ้าไม่เจอใน database → แทนที่ด้วย "(สินค้านี้ไม่อยู่ในฐานข้อมูล)"
      - Regex: r'["\u201c\u201d]([^"\u201c\u201d]+?)["\u201c\u201d]'

  ทดสอบ (6 test cases):
    Test 1: Straight quotes with parenthetical → PASS
    Test 2: Straight quotes without parenthetical → PASS
    Test 3: Multiple products → PASS
    Test 4: Curly quotes → PASS
    Test 5: Known products pass validation → PASS
    Test 6: Unknown product detected → PASS

  ผลที่คาด:
    - LLM จะไม่แนะนำสินค้านอก database (prompt ห้ามชัด)
    - ถ้า LLM ยังหลุด → post-processing จับได้และแทนที่
    - สินค้าจริงไม่ถูกกระทบ (ตรวจกับ ICP_PRODUCT_NAMES ครบ)

================================================================================
(Previous entries below)
================================================================================

================================================================================
Product Data Update: อัปเดตข้อมูลสินค้า "อาร์เทมีส" ให้ครบทุก field
================================================================================

สรุป:
  อัปเดตข้อมูลสินค้า "อาร์เทมีส" (Artemis) ใน Supabase products table
  จากเดิมที่มีข้อมูลเฉพาะนาข้าว → เพิ่มข้อมูลครบทุกพืช (ทุเรียน, ข้าวโพด,
  หอม, กระเทียม) พร้อม regenerate embedding ใหม่

================================================================================
1. ข้อมูลที่อัปเดต (อาร์เทมีส id=263)
================================================================================

  target_pest (เดิม → ใหม่):
    เดิม: "โรคใบจุดสีน้ำตาล โรคใบขีดสีน้ำตาล โรคเมล็ดด่าง ในนาข้าว"
    ใหม่: แยกตามพืช 4 กลุ่ม:
      (นาข้าว)       โรคกาบใบแห้ง ใบขีดสีน้ำตาล เมล็ดด่าง เน่าคอรวง
      (ข้าวโพด)      โรคใบไหม้แผลใหญ่
      (หอม กระเทียม) โรคหอมเลื้อย ใบจุดสีม่วง
      (ทุเรียน)       แอนแทรคโนส ใบจุด ราสนิม ผลเน่า ใบติด ราสีชมพู

  applicable_crops (เดิม → ใหม่):
    เดิม: "นาข้าว ไม้ผล"
    ใหม่: "นาข้าว ทุเรียน ข้าวโพด หอม กระเทียม ผัก ผลไม้"

  usage_rate (เดิม → ใหม่):
    เดิม: "ในไม้ผล(ทุเรียน) ใช้ 200 ซีซีต่อ 200 ลิตร ในนาข้าว ใช้ 50 ซีซีต่อไร่"
    ใหม่: แยกตามพืช:
      (นาข้าว)  50 ซีซี/ไร่ (1 ขวด ใช้ได้ถึง 20 ไร่)
      (ทุเรียน) 10 ซีซี/น้ำ 20 ลิตร ฉีดพ่นทุก 7-10 วัน

  usage_period (เดิม → ใหม่):
    เดิม: "" (ว่างเปล่า)
    ใหม่:
      (นาข้าว)  พ่นช่วงข้าวแตกกอ-ออกรวง ในข้าวระยะตั้งท้อง
      (ทุเรียน) ฉีดพ่นทุก 7-10 วัน หรือตามการระบาดของโรค

  how_to_use (เดิม → ใหม่):
    เดิม: "ผสมน้ำตามอัตราที่แนะนำ แล้วทำการฉีดพ่นที่ต้น ให้ทั่วบริเวณทรงพุ่ม"
    ใหม่: แยกตามพืช + เพิ่มรายละเอียดโดรน:
      (นาข้าว)  ใช้ 50 ซีซี/ไร่ พ่นช่วงข้าวแตกกอ-ออกรวง ใช้ได้กับโดรน
      (ทุเรียน) ใช้ 10 ซีซี/น้ำ 20 ลิตร ฉีดพ่นทุก 7-10 วัน ทั่วทรงพุ่ม

  selling_point (ใหม่ — เดิมไม่มี):
    "สารป้องกันกำจัดเชื้อราออกฤทธิ์ดูดซึม ผสม 2 พลังบวก
    (ไดฟีโนโคนาโซล+อะซอกซีสโตรบิน) | ป้องกันและรักษากว้างขวาง |
    ปลอดภัยต่อดอกและผลอ่อน | แก้ปัญหาโรคใบติด ราสีชมพู
    และแอนแทรคโนสได้อย่างมีประสิทธิภาพสูง | ดูดซึมเร็ว ออกฤทธิ์ไว |
    ใช้แล้วใบเขียว ผิวนวล ผลสะอาด | สูตรเย็นปลอดภัยต่อดอกและผลอ่อน"

  action_characteristics (ใหม่ — เดิมไม่มี):
    "ออกฤทธิ์แบบดูดซึม (Systemic) ดูดซึมเร็ว ออกฤทธิ์ไว
    ป้องกันกำจัดเชื้อราได้กว้าง"

  package_size (ใหม่ — เดิมไม่มี):
    "1 ลิตร"

================================================================================
2. Embedding regenerated
================================================================================

  embedding_text อัปเดตให้ครอบคลุม:
    - ชื่อโรคทุกพืช (ข้าว, ข้าวโพด, หอม/กระเทียม, ทุเรียน)
    - ชื่อพืชทั้งหมด 7 กลุ่ม
    - จุดเด่น: ดูดซึม, สูตรเย็น, ใช้กับโดรน
    - English keywords: Difenoconazole, Azoxystrobin, Fungicide

  ผลกระทบ: vector/semantic search จะหาเจอสินค้าอาร์เทมีส
  เมื่อถามเกี่ยวกับโรคทุเรียน (ใบติด, ราสีชมพู, แอนแทรคโนส)
  ซึ่งเดิม search ไม่เจอ

================================================================================
3. ไฟล์ที่แก้ไข
================================================================================

  scripts/update_artemis.py
    - สร้างใหม่ (ไฟล์เดิมถูกลบ)
    - อัปเดต product_data ครบ 13 fields
    - อัปเดต embedding_text ครอบคลุมทุกพืช+โรค
    - เพิ่ม UTF-8 encoding fix สำหรับ Windows console
    - เพิ่ม Verify section แสดง 12 fields หลังอัปเดต

================================================================================
4. หมายเหตุ: Embedding vs Keyword Search
================================================================================

  ระบบ search ใน products table มี 2 ส่วน:

  1) search_vector (Keyword/Full-Text Search)
     - มี Postgres trigger อัปเดตอัตโนมัติเมื่อ INSERT/UPDATE
     - ดึงจาก: product_name, target_pest, common_name_th,
       active_ingredient, applicable_crops, how_to_use
     - ไม่ต้องทำอะไรเพิ่ม — อัปเดตทันทีเมื่อแก้ field

  2) embedding (Vector/Semantic Search)
     - ไม่มี trigger อัตโนมัติ
     - ต้อง regenerate ด้วย script (เรียก OpenAI text-embedding-3-small)
     - ถ้าแก้ field โดยไม่รัน script → vector search ยังใช้ embedding เก่า

  Workflow แนะนำ:
     แก้ข้อมูลใน script → รัน script → field + embedding อัปเดตพร้อมกัน

================================================================================
5. ทดสอบ (ก่อนอัปเดต)
================================================================================

  Query: "ใชติดทุเรียนใช้ยาอะไร"
    - Intent: PRODUCT_RECOMMENDATION, plant_type=ทุเรียน
    - อาร์เทมีสไม่ปรากฏในผลลัพธ์ (เดิม target_pest มีแค่โรคข้าว)
    - Bot แนะนำ พรีดิคท์ 25 แทน (ไม่ตรงคำถาม)

  หลังอัปเดต: คาดว่าอาร์เทมีสจะปรากฏในผลลัพธ์เมื่อถามเกี่ยวกับ
  โรคทุเรียน (ใบติด, ราสีชมพู, แอนแทรคโนส) เพราะทั้ง keyword search
  และ vector search มีข้อมูลใหม่แล้ว

================================================================================
6. Fix: เรียงลำดับสินค้าตาม Strategy Group + แนะนำ 2-3 ตัว
================================================================================

  ปัญหา:
    ถาม "เพลี้ยไฟบุกแปลง มีสินค้าแนะนำไหม" →
    บางครั้งแนะนำ อิมิดาโกลด์ 70 (Natural) บางครั้งแนะนำ โมเดิน 50 (Expand)
    ไม่สม่ำเสมอ และแนะนำแค่ 1 ตัว แทนที่จะ 2-3 ตัว

  สาเหตุ:
    - อิมิดาโกลด์ (Natural, boost 0.0) ได้คะแนน LLM rerank สูงกว่า
      โมเดิน (Expand, boost +0.10) เพราะ IMIDACLOPRID ตรงกับเพลี้ยไฟมาก
    - response_generator_agent.py กรอง Standard ออก แต่ไม่ได้ sort
      ตาม strategy_group → สินค้าเรียงตาม rerank score เดิม
    - LLM ไม่ enforce ลำดับ strategy_group เสมอ

  แก้ไข 2 ไฟล์:

    app/services/agents/response_generator_agent.py
      - เพิ่ม: explicit sort by strategy_group priority หลัง filter
        Skyrocket(0) > Expand(1) > Natural(2) > Standard(3)
        ทำให้สินค้า Skyrocket/Expand ปรากฏก่อนใน product context เสมอ

    app/prompts.py (PRODUCT_QA_PROMPT)
      - แก้ ข้อ 2: "ไม่เกิน 1-3 ตัว" → "แนะนำ 2-3 ตัว (ถ้ามี)"
      - แก้ ข้อ 11: เน้นลำดับชัดเจนขึ้น
        ลำดับ 1: Skyrocket | ลำดับ 2: Expand | ลำดับ 3: Natural
        เพิ่ม: "สินค้าลำดับ [สินค้า 1] คือตัวที่ควรแนะนำก่อน"

  ผลที่คาด:
    - สินค้า Expand (โมเดิน) จะถูกแนะนำก่อน Natural (อิมิดาโกลด์) เสมอ
    - Bot จะแนะนำ 2-3 ตัวแทน 1 ตัว

================================================================================
7. Fix: อนุญาตให้แนะนำ Standard ได้ (ไม่ลบออกจาก list)
================================================================================

  ปัญหา:
    โค้ดเดิม (section 6) ลบสินค้า Standard ออกจาก list ทั้งหมด
    ถ้ามี Skyrocket/Expand อยู่ → Standard หายไปเลย
    แต่จริงๆ Standard ควรแนะนำได้ ถ้า Skyrocket/Expand ไม่ตรงกับโรค/แมลงที่ถาม

  แก้ไข:

    app/services/agents/response_generator_agent.py
      - ลบ: filter ที่ exclude Standard ออก (priority_docs + if block)
      - คง: sort by strategy_group priority (Skyrocket > Expand > Natural > Standard)
      - ผล: Standard ยังอยู่ใน list แต่เรียงท้ายสุดเสมอ

    app/prompts.py (PRODUCT_QA_PROMPT ข้อ 11)
      - เดิม: "ห้ามแนะนำกลุ่ม Standard ในรอบแรก"
      - ใหม่: "กลุ่ม Standard แนะนำได้ แต่ไม่ใช่ตัวเลือกแรก
               ถ้า Skyrocket/Expand/Natural ไม่ตรงกับโรค/แมลงที่ถาม
               ให้แนะนำ Standard ได้เลย"

  ผลที่คาด:
    - Standard ไม่ถูกลบจาก context → LLM เห็นข้อมูลครบ
    - LLM จะเลือก Standard ได้ถ้าตรงกับโรค/แมลงมากกว่า Skyrocket/Expand
    - ลำดับยังคง Skyrocket > Expand > Natural > Standard

================================================================================
8. Fix: Follow-up questions ดึง memory ผิด context
================================================================================

  ปัญหา:
    เมื่อ user ถามคำถามต่อเนื่อง (เช่น "ใช้กับทุเรียนได้ไหม")
    Agent ดึง memory จากบทสนทนาเก่ากว่า แทนที่จะใช้คำถามล่าสุด

  สาเหตุ:
    1. Context window เล็กเกินไป (30 messages)
    2. Bottom-up search ไม่มี recency boost
    3. ไม่มี marker ชัดเจนว่า "กำลังคุยสินค้าอะไร"

  Solution: เพิ่ม "Current Product Focus" Tracking

  แก้ไข (5 ไฟล์):

    app/services/memory.py
      - เพิ่ม functions: save_current_product_focus(), get_current_product_focus(), clear_product_focus()
      - เพิ่ม in-memory cache พร้อม TTL 30 นาที
      - แก้ get_enhanced_context(): เพิ่ม [สินค้าที่กำลังคุยอยู่] marker ด้านบนสุด

    app/services/agentic_rag.py (Stage 0)
      - เพิ่ม Strategy 0: ดึง product จาก [สินค้าที่กำลังคุยอยู่] marker ก่อน
      - Fallback to Strategy 1 (bottom-up search) ถ้าไม่เจอ marker

    app/services/chat.py (~line 1190)
      - เพิ่ม: บันทึก product focus หลังแนะนำสินค้า
      - เรียก save_current_product_focus(user_id, mentioned_products[0])

    app/services/agents/response_generator_agent.py (~line 241)
      - เพิ่ม instruction ให้ Agent 4 เน้น [สินค้าที่กำลังคุยอยู่]
      - ชี้แจงชัดเจน: ห้ามเปลี่ยนสินค้าเมื่อ user ถามต่อเนื่อง

  Flow ใหม่:
    1. User ถาม "โมเดินใช้กับพริกได้ไหม"
    2. Bot ตอบ + save_current_product_focus("โมเดิน")
    3. User ถาม "แล้วใช้กับมะเขือเทศล่ะ" (ไม่ระบุชื่อสินค้า)
    4. get_enhanced_context() ใส่ "[สินค้าที่กำลังคุยอยู่] โมเดิน" ไว้บนสุด
    5. agentic_rag.py Strategy 0 ดึง "โมเดิน" จาก marker
    6. Bot ตอบเกี่ยวกับโมเดิน (ไม่ใช่สินค้าอื่น)

  ผลที่คาด:
    - Follow-up questions จะอ้างอิงสินค้าล่าสุดที่แนะนำไปเสมอ
    - TTL 30 นาที — หลังจากนี้จะเริ่มบทสนทนาใหม่อัตโนมัติ
    - Backward compatible — ไม่กระทบ flow เดิม

================================================================================
