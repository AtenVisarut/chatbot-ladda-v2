# Chat Agent & Agentic RAG Architecture

## ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö

‡∏£‡∏∞‡∏ö‡∏ö Chatbot ‡∏•‡∏±‡∏î‡∏î‡∏≤ ‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏° **4-Agent Pipeline (Agentic RAG)** ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏©‡∏ï‡∏£ ICP
‡πÇ‡∏î‡∏¢‡∏°‡∏µ Agent 4 ‡∏ï‡∏±‡∏ß‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô:

### Main Workflow (n8n-style)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üü¢ START   ‚îÇ LINE Webhook receives message
‚îÇ  Trigger    ‚îÇ POST /webhook
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üì• Save Memory  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ üìã Get Context   ‚îÇ ‡∏î‡∏∂‡∏á 30 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
‚îÇ add_to_memory() ‚îÇ     ‚îÇ get_enhanced_    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ context()        ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                                 ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ üîÄ Intent Classifier ‚îÇ gpt-4o (temp=0)
                   ‚îÇ classify_message_    ‚îÇ fallback: keyword matching
                   ‚îÇ intent()             ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ           ‚îÇ           ‚îÇ
              ‚ñº           ‚ñº           ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ üëã       ‚îÇ ‚îÇ üí¨      ‚îÇ ‚îÇ üß™           ‚îÇ
        ‚îÇ greeting ‚îÇ ‚îÇ general ‚îÇ ‚îÇ product_qa   ‚îÇ
        ‚îÇ          ‚îÇ ‚îÇ _chat   ‚îÇ ‚îÇ              ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ            ‚îÇ             ‚îÇ
             ‚ñº            ‚ñº             ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢  ‚îÇ ‚îÇ LLM ‡∏≠‡∏¥‡∏™‡∏£‡∏∞‚îÇ ‚îÇ        ü§ñ AgenticRAG Pipeline              ‚îÇ
        ‚îÇ random  ‚îÇ ‚îÇ gpt-4o   ‚îÇ ‚îÇ                                             ‚îÇ
        ‚îÇ greeting‚îÇ ‚îÇ temp=0.7 ‚îÇ ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                              ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ  ‚îÇ Stage 0   ‚îÇ Pre-detect Hints             ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ (keyword) ‚îÇ ‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤+‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤    ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                              ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ        ‚ñº                                    ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ üß† Agent 1: QueryUnderstanding   ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ gpt-4o | temp=0.1 | 500 tokens   ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ                                   ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ IN:  query + context + hints      ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ OUT: intent, entities,            ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ      expanded_queries             ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ                ‚ñº                            ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ üîç Agent 2: Retrieval            ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ embedding + gpt-4o rerank        ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ                                   ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ IN:  QueryAnalysis                ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ STEP: Direct Lookup               ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ    ‚Üí Vector+Keyword Hybrid        ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ    ‚Üí Fallback ilike               ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ    ‚Üí De-dup ‚Üí LLM Rerank          ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ OUT: ranked documents[]            ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ                ‚ñº                            ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ ‚úÖ Agent 3: Grounding             ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ gpt-4o | temp=0 | 500 tokens     ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ                                   ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ IN:  query + documents            ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ OUT: is_grounded, citations,      ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ      relevant_products            ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ                ‚ñº                            ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ üí¨ Agent 4: ResponseGenerator    ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ gpt-4o | temp=0.1 | 700 tokens   ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ                                   ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ IN:  query + grounded docs +      ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ      context + citations          ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ STEP: Filter products             ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ    ‚Üí Build product context        ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ    ‚Üí Generate answer              ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ    ‚Üí Post-process                 ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îÇ OUT: answer + confidence          ‚îÇ      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
             ‚îÇ           ‚îÇ       ‚îÇ                ‚îÇ                            ‚îÇ
             ‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ           ‚îÇ                        ‚îÇ
             ‚ñº           ‚ñº                        ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ üì§ Reply to LINE                             ‚îÇ
        ‚îÇ line_bot_api.reply_message()                 ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ üíæ Save Response to Memory                   ‚îÇ
        ‚îÇ add_to_memory(role="assistant",              ‚îÇ
        ‚îÇ   metadata={products: [...]})                ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  üî¥ END     ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Agent Data Flow (n8n-style connections)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   query    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  QueryAnalysis  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  documents[]  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  grounded    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Stage 0 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Agent 1 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Agent 2 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Agent 3 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Agent 4 ‚îÇ
‚îÇ Hints    ‚îÇ  context   ‚îÇ  Query   ‚îÇ  intent         ‚îÇ Retrieve ‚îÇ  ranked      ‚îÇ Grounding‚îÇ  citations   ‚îÇ Response ‚îÇ
‚îÇ          ‚îÇ  hints     ‚îÇ  Under-  ‚îÇ  entities       ‚îÇ          ‚îÇ  scored      ‚îÇ          ‚îÇ  is_grounded ‚îÇ Generate ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ  stand   ‚îÇ  expanded_      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  queries                                                              ‚îÇ
                                                                                                           ‚ñº
                                                                                                     answer (str)
                                                                                                     confidence (0-1)
```

### Database Connections (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Agent 2)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Supabase (PostgreSQL)                  ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  products    ‚îÇ  ‚îÇ conversation_   ‚îÇ  ‚îÇ  knowledge   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  table       ‚îÇ  ‚îÇ memory table    ‚îÇ  ‚îÇ  table       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ             ‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ embedding ‚îÇ  ‚îÇ ‚Ä¢ user messages ‚îÇ  ‚îÇ ‚Ä¢ diseases   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   (vector)  ‚îÇ  ‚îÇ ‚Ä¢ bot responses ‚îÇ  ‚îÇ ‚Ä¢ crop care  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ search_   ‚îÇ  ‚îÇ ‚Ä¢ metadata      ‚îÇ  ‚îÇ ‚Ä¢ pest info  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   vector    ‚îÇ  ‚îÇ   {products}    ‚îÇ  ‚îÇ              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   (tsvector)‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ         ‚îÇ                  ‚îÇ                   ‚îÇ         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                  ‚îÇ                   ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Agent 2   ‚îÇ     ‚îÇ Memory    ‚îÇ       ‚îÇ Agent 2   ‚îÇ
    ‚îÇ Retrieval ‚îÇ     ‚îÇ System    ‚îÇ       ‚îÇ Knowledge ‚îÇ
    ‚îÇ (hybrid   ‚îÇ     ‚îÇ (context) ‚îÇ       ‚îÇ (fallback)‚îÇ
    ‚îÇ  search)  ‚îÇ     ‚îÇ           ‚îÇ       ‚îÇ           ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 1. Main Chat Flow (`app/services/chat.py`)

### `handle_natural_conversation(user_id, message)`

| ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô | ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥ |
|---------|----------|
| 1 | `add_to_memory()` ‚Äî ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° user ‡∏•‡∏á Supabase |
| 2 | `get_enhanced_context()` ‚Äî ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 30 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ |
| 3 | `classify_message_intent()` ‚Äî ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å intent ‡∏î‡πâ‡∏ß‡∏¢ gpt-4o (fallback = keyword) |
| 4 | Route ‡∏ï‡∏≤‡∏° intent: greeting -> ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢, product_qa -> AgenticRAG, general_chat -> LLM ‡∏≠‡∏¥‡∏™‡∏£‡∏∞ |
| 5 | `add_to_memory()` ‚Äî ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö bot ‡∏û‡∏£‡πâ‡∏≠‡∏° metadata ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ |

### Intent Classification

- **Model:** gpt-4o, temp=0, max_tokens=20
- **3 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:** `product_qa`, `greeting`, `general_chat`
- **Keyword fallback:** follow-up keywords ("‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á", "‡∏ú‡∏™‡∏°‡∏Å‡∏µ‡πà", "‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£") -> `product_qa`

### Helper Functions

| Function | ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà |
|----------|--------|
| `extract_product_name_from_question()` | ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ICP (exact + fuzzy 0.65) |
| `detect_problem_type()` | ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤: disease / insect / nutrient / weed |
| `is_agriculture_question()` | ‡∏ï‡∏£‡∏ß‡∏à keyword ‡πÄ‡∏Å‡∏©‡∏ï‡∏£ 45+ ‡∏Ñ‡∏≥ |
| `ICP_PRODUCT_NAMES` | Dictionary ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 42 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏° aliases |

---

## 2. AgenticRAG Orchestrator (`app/services/agentic_rag.py`)

### `process(query, context, user_id)` ‚Äî Pipeline ‡∏´‡∏•‡∏±‡∏Å

#### Stage 0: Pre-detect Hints (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ LLM)
- **Strategy 0**: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å `[‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏≠‡∏¢‡∏π‡πà]` marker (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‚Äî ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö follow-up questions
- **Strategy 1**: ‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å query -> ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏Ñ‡πâ‡∏ô‡∏à‡∏≤‡∏Å context ‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
- **Strategy 2**: Fallback to `[‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß]` section
- ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (disease/insect/weed/nutrient)
- ‡∏™‡πà‡∏á `hints = {product_name, problem_type}` ‡πÉ‡∏´‡πâ Stage 1

#### Stage 1-4: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Agent 4 ‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)

### Output: `AgenticRAGResponse`

```
answer: str              # ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
confidence: float        # 0.0-1.0
citations: List[Citation]
intent: IntentType
is_grounded: bool
sources_used: List[str]  # ["products"]
processing_time_ms: float
```

---

## 3. Agent ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 1 ‚Äî QueryUnderstandingAgent

**‡πÑ‡∏ü‡∏•‡πå:** `app/services/agents/query_understanding_agent.py`
**Model:** gpt-4o, temp=0.1, max_tokens=500

### ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° user -> ‡∏™‡∏Å‡∏±‡∏î intent, entities, ‡∏™‡∏£‡πâ‡∏≤‡∏á expanded queries ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö retrieval

### Input / Output

**Input:** query, context (max 2000 chars), hints (product_name, problem_type)

**Output: `QueryAnalysis`**
```
original_query: str
intent: IntentType          # 10 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
confidence: float           # 0.0-1.0
entities: {
    product_name,           # "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô"
    plant_type,             # "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"
    disease_name,           # "‡∏£‡∏≤‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á"
    pest_name,              # "‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢"
    weed_type,              # "‡∏´‡∏ç‡πâ‡∏≤"
    growth_stage            # "‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á"
}
expanded_queries: List[str] # ["‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ", "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏™‡∏°"]
required_sources: ["products"]
```

### IntentType (10 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)

| Intent | ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á |
|--------|---------|
| product_inquiry | "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á" |
| product_recommendation | "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≤‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á" |
| disease_treatment | "‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Å‡πÄ‡∏ô‡πà‡∏≤ ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£" |
| pest_control | "‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÉ‡∏ô‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" |
| weed_control | "‡∏´‡∏ç‡πâ‡∏≤‡πÉ‡∏ô‡∏ô‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß" |
| nutrient_supplement | "‡∏î‡∏≠‡∏Å‡∏£‡πà‡∏ß‡∏á ‡∏ï‡∏¥‡∏î‡∏î‡∏≠‡∏Å" |
| usage_instruction | "‡∏ú‡∏™‡∏°‡∏Å‡∏µ‡πà‡∏•‡∏¥‡∏ï‡∏£" |
| general_agriculture | "‡∏Ç‡πâ‡∏≤‡∏ß‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô" |
| greeting | "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ" |
| unknown | "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏á" |

### Follow-up Logic
- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô "‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô") -> ‡∏î‡∏π context ‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -> ‡πÉ‡∏™‡πà‡πÉ‡∏ô entities.product_name
- Hints ‡∏à‡∏≤‡∏Å Stage 0 ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô `[HINT]` ‡πÉ‡∏ô prompt

---

## 4. Agent ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2 ‚Äî RetrievalAgent

**‡πÑ‡∏ü‡∏•‡πå:** `app/services/agents/retrieval_agent.py`
**Model:** gpt-4o (reranking), text-embedding-3-small (embedding)

### ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Supabase ‡∏î‡πâ‡∏ß‡∏¢ multi-stage retrieval pipeline

### Pipeline 6 ‡∏Ç‡∏±‡πâ‡∏ô

| Stage | ‡∏ä‡∏∑‡πà‡∏≠ | ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£ |
|-------|------|--------|
| 0 | Direct Lookup | `ilike` ‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á -> score=1.0 |
| 1 | Multi-Source | Vector search (embedding 0.6 + keyword 0.4) x expanded queries (parallel) |
| 1.5 | Fallback | Keyword ilike search ‡∏ñ‡πâ‡∏≤ Stage 1 ‡πÑ‡∏°‡πà‡∏û‡∏ö |
| 1.9 | Supplementary | ‡∏Ñ‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Skyrocket/Expand ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° |
| 2 | De-dup | ‡∏•‡∏ö document ‡∏ã‡πâ‡∏≥‡∏ï‡∏≤‡∏° title |
| 3 | LLM Rerank | gpt-4o ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö relevance -> score 0-1.0 |

### Score Boosting (‡∏´‡∏•‡∏±‡∏á Rerank)

| Rule | Score Boost |
|------|------------|
| Direct lookup match | ‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 1 |
| Strategy: Skyrocket | +0.15 |
| Strategy: Expand | +0.10 |
| Strategy: Standard | -0.05 |
| ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏° | +0.20 |
| ‡∏û‡∏∑‡∏ä‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ "‡πÄ‡∏ô‡πâ‡∏ô") | +0.05 |

### Thresholds

```
VECTOR_THRESHOLD  = 0.25  (‡∏ï‡πà‡∏≥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠ recall)
RERANK_THRESHOLD  = 0.50  (‡∏Å‡∏•‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠ precision)
MIN_RELEVANT_DOCS = 3     (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥)
```

### Output: `RetrievalResult`
- `documents` ‚Äî List ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° rerank_score
- `total_retrieved` / `total_after_rerank`
- `avg_similarity` / `avg_rerank_score`

---

## 5. Agent ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3 ‚Äî GroundingAgent

**‡πÑ‡∏ü‡∏•‡πå:** `app/services/agents/grounding_agent.py`
**Model:** gpt-4o, temp=0, max_tokens=500

### ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ documents ‡∏ó‡∏µ‡πà retrieve ‡∏°‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
(‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ citations ‡πÅ‡∏•‡∏∞ grounding verdict)

### ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô
- **is_grounded = true** -> ‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
- **is_grounded = false** -> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠ confidence ‡∏ï‡πà‡∏≥
- ‡πÉ‡∏´‡πâ priority ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Skyrocket/Expand ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ Standard
- ‡πÉ‡∏´‡πâ priority ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏∑‡∏ä (‡∏°‡∏µ "‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö")

### Output: `GroundingResult`
- `is_grounded` ‚Äî bool
- `confidence` ‚Äî 0.0-1.0
- `citations` ‚Äî max 3 references
- `ungrounded_claims` ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
- `relevant_products` ‚Äî ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

---

## 6. Agent ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 4 ‚Äî ResponseGeneratorAgent

**‡πÑ‡∏ü‡∏•‡πå:** `app/services/agents/response_generator_agent.py`
**Model:** gpt-4o, temp=0.1, max_tokens=700

### ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£ verify ‡πÅ‡∏•‡πâ‡∏ß

### ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£

1. **‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤** ‚Äî ‡∏•‡∏ö variant ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ variant ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏∑‡∏ä (Standard ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô list)
2. **‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° Strategy Group** ‚Äî Skyrocket(0) > Expand(1) > Natural(2) > Standard(3) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å‡πÉ‡∏ô context (Standard ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)
3. **‡∏™‡∏£‡πâ‡∏≤‡∏á Product Context** ‚Äî ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡∏™‡∏≤‡∏£/‡∏≠‡∏±‡∏ï‡∏£‡∏≤/‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ/‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô/‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏) max 5 ‡∏ï‡∏±‡∏ß
4. **‡πÉ‡∏™‡πà‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤** ‚Äî context[:1500] + ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á follow-up (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
5. **‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM** ‚Äî gpt-4o ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤" ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 2-3 ‡∏ï‡∏±‡∏ß ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° strategy_group
6. **Post-process** ‚Äî ‡∏•‡∏ö markdown artifacts, ‡πÄ‡∏û‡∏¥‡πà‡∏° disclaimer ‡∏ñ‡πâ‡∏≤ confidence < 0.5

### Follow-up Protection
```
"‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°
‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞ ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡πÜ"
```

### Fallback
‡∏ñ‡πâ‡∏≤ LLM ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß -> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å raw product data ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô LLM)

---

## 7. Memory System (`app/services/memory.py`)

### Storage: Supabase table `conversation_memory`

| Column | Type | Description |
|--------|------|-------------|
| user_id | string | LINE user ID |
| role | string | "user" ‡∏´‡∏£‡∏∑‡∏≠ "assistant" |
| content | string | ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (max 2000 chars) |
| metadata | json | `{type: "product_recommendation", products: [...]}` |
| created_at | timestamp | ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö |

### Key Functions

| Function | ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà |
|----------|--------|
| `add_to_memory()` | ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + metadata ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ |
| `get_conversation_context()` | ‡∏î‡∏∂‡∏á 30 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -> format "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: .." / "‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤: .." |
| `get_enhanced_context()` | ‡∏£‡∏ß‡∏° **product focus** + context + ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ |
| `get_conversation_summary()` | ‡∏™‡∏£‡∏∏‡∏õ topics/products/plants ‡∏à‡∏≤‡∏Å metadata + text |
| `cleanup_old_memory()` | ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 50 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î |
| `save_current_product_focus()` | **NEW** ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢ (TTL 30 ‡∏ô‡∏≤‡∏ó‡∏µ) |
| `get_current_product_focus()` | **NEW** ‚Äî ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏) |
| `clear_product_focus()` | **NEW** ‚Äî ‡∏•‡πâ‡∏≤‡∏á product focus |

### Current Product Focus (NEW)

In-memory cache ‡πÄ‡∏Å‡πá‡∏ö "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏≠‡∏¢‡∏π‡πà" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö follow-up questions
- **TTL**: 30 ‡∏ô‡∏≤‡∏ó‡∏µ ‚Äî ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- **‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠**: Bot ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô chat.py
- **‡πÉ‡∏ä‡πâ‡πÉ‡∏ô**: get_enhanced_context() ‚Üí ‡πÉ‡∏™‡πà marker `[‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏≠‡∏¢‡∏π‡πà]` ‡∏ö‡∏ô‡∏™‡∏∏‡∏î

### Enhanced Context Format (‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ LLM)

```
[‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏≠‡∏¢‡∏π‡πà] ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô

[‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î]
‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
‡∏ô‡πâ‡∏≠‡∏á‡∏•‡∏±‡∏î‡∏î‡∏≤: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô ...

[‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß] ‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô

[‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢] ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ‡πÅ‡∏°‡∏•‡∏á | ‡∏û‡∏∑‡∏ä: ‡∏û‡∏£‡∏¥‡∏Å
```

### Config

```
MAX_MEMORY_MESSAGES  = 50   (‡πÄ‡∏Å‡πá‡∏ö 50 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
MEMORY_CONTEXT_WINDOW = 30  (‡∏î‡∏∂‡∏á 30 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
MEMORY_CONTENT_PREVIEW = 800 (‡πÅ‡∏™‡∏î‡∏á 800 chars ‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
```

---

## 8. LINE Webhook (`app/main.py`)

### Flow ‡∏´‡∏•‡∏±‡∏Å 2 ‡πÅ‡∏ö‡∏ö

#### Text Flow (Q&A)
```
LINE text -> verify signature -> return 200 immediately
  -> background: classify intent -> AgenticRAG -> reply LINE
```

#### Image Flow (Disease Detection ‚Äî 2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)
```
LINE image -> save message_id -> ‡∏ñ‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä (Step 1/2)
  -> user ‡∏ï‡∏≠‡∏ö‡∏û‡∏∑‡∏ä -> ‡∏ñ‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏à‡∏£‡∏¥‡∏ç (Step 2/2)
  -> user ‡∏ï‡∏≠‡∏ö‡∏£‡∏∞‡∏¢‡∏∞ -> download image -> detect disease -> recommend products
```

### Quick Commands

| Command | Action |
|---------|--------|
| "‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" | ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ |
| "‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå" | ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ |
| "‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥" | ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ |
| "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠" | ‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ |

---

## LLM Models Summary

‡∏ä‡∏∑‡πà‡∏≠ model ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ñ‡∏π‡∏Å‡∏£‡∏ß‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô `app/config.py` ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô env var ‡πÑ‡∏î‡πâ:

| Component | Config Key | Default | Temp | Max Tokens |
|-----------|-----------|---------|------|------------|
| Intent Classification | `LLM_MODEL_INTENT` | gpt-4o | 0 | 20 |
| Query Understanding | `LLM_MODEL_QUERY_UNDERSTANDING` | gpt-4o | 0.1 | 500 |
| Retrieval Reranking | `LLM_MODEL_RERANKING` | gpt-4o | 0 | 100 |
| Grounding Verification | `LLM_MODEL_GROUNDING` | gpt-4o | 0 | 500 |
| Response Generation | `LLM_MODEL_RESPONSE_GEN` | gpt-4o | 0.1 | 700 |
| General Chat | `LLM_MODEL_GENERAL_CHAT` | gpt-4o | 0.7 | 300 |
| Knowledge Base | `LLM_MODEL_KNOWLEDGE` | gpt-4o | 0.5 | - |
| Embeddings | `EMBEDDING_MODEL` | text-embedding-3-small | - | - |

---

## Design Patterns

1. **Lazy Import** ‚Äî ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á circular imports ‡∏î‡πâ‡∏ß‡∏¢ async singleton + asyncio.Lock
2. **Async Parallel** ‚Äî vector search ‡∏´‡∏•‡∏≤‡∏¢ query ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (`asyncio.gather`)
3. **Fallback Chain** ‚Äî LLM ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß -> keyword fallback -> raw data
4. **Score Boosting** ‚Äî ‡∏´‡∏•‡∏≤‡∏¢ layer ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô (direct + strategy + crop)
5. **Context Injection** ‚Äî ‡πÉ‡∏™‡πà‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏ô query understanding + response generation
6. **Product Metadata** ‚Äî ‡πÄ‡∏Å‡πá‡∏ö metadata ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô memory ‡πÄ‡∏û‡∏∑‡πà‡∏≠ follow-up questions
7. **Background Processing** ‚Äî return 200 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏´‡πâ LINE, ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ô background task (per-event error isolation)
8. **Embedding Cache** ‚Äî LRU cache 500 entries / TTL 1 ‡∏ä‡∏°. ‡∏•‡∏î API calls ‡∏ã‡πâ‡∏≥
9. **Per-user Cleanup Lock** ‚Äî asyncio.Lock ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition ‡πÉ‡∏ô memory cleanup

---

## 10. Products Table Schema

### Supabase table `products`

| Column | Type | Weight | Description |
|--------|------|--------|-------------|
| id | bigserial | PK | Primary key |
| product_name | text | Search A | ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏°‡∏µ‡∏™", "‡πÇ‡∏°‡πÄ‡∏î‡∏¥‡∏ô 50" |
| active_ingredient | text | Search B | ‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÄ‡∏ä‡πà‡∏ô "‡πÑ‡∏î‡∏ü‡∏µ‡πÇ‡∏ô‡πÇ‡∏Ñ‡∏ô‡∏≤‡πÇ‡∏ã‡∏• + ‡∏≠‡∏∞‡∏ã‡πä‡∏≠‡∏Ñ‡∏ã‡∏µ‡∏™‡πÇ‡∏ï‡∏£‡∏ö‡∏¥‡∏ô" |
| product_category | text | ‚Äî | ‡∏´‡∏°‡∏ß‡∏î (English): "Insecticide", "Fungicide", "Herbicide", "PGR", "Fertilizer" |
| target_pest | text | Search A | ‡πÇ‡∏£‡∏Ñ/‡πÅ‡∏°‡∏•‡∏á/‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÑ‡∏î‡πâ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡∏ä) |
| applicable_crops | text | Search B | ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ô‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î" |
| how_to_use | text | Search C | ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡∏ä) |
| usage_rate | text | ‚Äî | ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡∏ä) |
| usage_period | text | ‚Äî | ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡∏ä) |
| selling_point | text | ‚Äî | ‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢/‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ |
| action_characteristics | text | ‚Äî | ‡∏Å‡∏•‡πÑ‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏§‡∏ó‡∏ò‡∏¥‡πå ‡πÄ‡∏ä‡πà‡∏ô "‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏° (Systemic)" |
| package_size | text | ‚Äî | ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ö‡∏£‡∏£‡∏à‡∏∏ ‡πÄ‡∏ä‡πà‡∏ô "1 ‡∏•‡∏¥‡∏ï‡∏£" |
| pathogen_type | text | ‚Äî | ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠: "‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤", "oomycetes" |
| common_name_th | text | Search A | ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ |
| strategy_group | text | ‚Äî | ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå: "Skyrocket", "Expand", "Standard" |
| image_url | text | ‚Äî | URL ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ |
| link_product | text | ‚Äî | URL ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡πÇ‡∏ö‡∏£‡∏ä‡∏±‡∏ß‡∏£‡πå (PDF) |
| embedding | vector(1536) | ‚Äî | OpenAI text-embedding-3-small vector |
| search_vector | tsvector | ‚Äî | Full-text search vector (auto-generated by trigger) |

### ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡∏ä)

```
target_pest:
  (‡∏ô‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß) ‡πÇ‡∏£‡∏Ñ‡∏Å‡∏≤‡∏ö‡πÉ‡∏ö‡πÅ‡∏´‡πâ‡∏á ‡πÉ‡∏ö‡∏Ç‡∏µ‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏î‡πà‡∏≤‡∏á ‡πÄ‡∏ô‡πà‡∏≤‡∏Ñ‡∏≠‡∏£‡∏ß‡∏á
  (‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î) ‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ‡πÅ‡∏ú‡∏•‡πÉ‡∏´‡∏ç‡πà
  (‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) ‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™ ‡πÉ‡∏ö‡∏à‡∏∏‡∏î ‡∏£‡∏≤‡∏™‡∏ô‡∏¥‡∏° ‡∏ú‡∏•‡πÄ‡∏ô‡πà‡∏≤ ‡πÉ‡∏ö‡∏ï‡∏¥‡∏î ‡∏£‡∏≤‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π

usage_rate:
  (‡∏ô‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß) 50 ‡∏ã‡∏µ‡∏ã‡∏µ/‡πÑ‡∏£‡πà (1 ‡∏Ç‡∏ß‡∏î ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á 20 ‡πÑ‡∏£‡πà)
  (‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) 10 ‡∏ã‡∏µ‡∏ã‡∏µ/‡∏ô‡πâ‡∏≥ 20 ‡∏•‡∏¥‡∏ï‡∏£ ‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏ó‡∏∏‡∏Å 7-10 ‡∏ß‡∏±‡∏ô
```

---

## 11. Search Architecture (Keyword vs Vector)

‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ **2 ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á** ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô (Hybrid Search):

### 1) Keyword Search (`search_vector` ‚Äî tsvector)

```
Hybrid weight: 40%
Auto-update:   ‚úÖ ‡∏°‡∏µ Postgres trigger ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ INSERT/UPDATE
```

**Trigger:** `products_search_vector_trigger` (BEFORE INSERT OR UPDATE)
**Function:** `products_search_vector_update()` ‡∏™‡∏£‡πâ‡∏≤‡∏á tsvector ‡∏à‡∏≤‡∏Å:
- Weight A (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î): `product_name`, `target_pest`, `common_name_th`
- Weight B: `active_ingredient`, `applicable_crops`
- Weight C: `how_to_use`

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡πÅ‡∏Å‡πâ field ‡∏ú‡πà‡∏≤‡∏ô Supabase Dashboard ‚Üí keyword search ‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

### 2) Vector/Semantic Search (`embedding` ‚Äî vector(1536))

```
Hybrid weight: 60%
Auto-update:   ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ trigger ‚Äî ‡∏ï‡πâ‡∏≠‡∏á regenerate ‡∏î‡πâ‡∏ß‡∏¢ script
Model:         text-embedding-3-small (OpenAI)
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡πÅ‡∏Å‡πâ field ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô script ‚Üí vector search ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ embedding ‡πÄ‡∏Å‡πà‡∏≤
‚Üí semantic search ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÉ‡∏´‡∏°‡πà

### Hybrid Search Function (Supabase RPC)

```sql
hybrid_search_products(query_text, query_embedding, match_count)
  ‚Üí score = (vector_similarity * 0.6) + (keyword_rank * 0.4)
  ‚Üí ORDER BY score DESC
```

---

## 12. Product Data Update Workflow

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)

```
1. ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô script (‡πÄ‡∏ä‡πà‡∏ô scripts/update_artemis.py)
2. ‡∏£‡∏±‡∏ô: python scripts/update_artemis.py
3. Script ‡∏à‡∏∞:
   - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å field ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô product_data
   - Regenerate embedding ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å embedding_text
   - Push ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏∂‡πâ‡∏ô Supabase ‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
   - Postgres trigger ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï search_vector ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
4. ‡∏ó‡∏±‡πâ‡∏á keyword search ‡πÅ‡∏•‡∏∞ vector search ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
```

### ‚ö†Ô∏è ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á

| ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï | keyword search | vector search |
|-----------|---------------|--------------|
| ‡πÅ‡∏Å‡πâ‡∏ú‡πà‡∏≤‡∏ô Supabase Dashboard | ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (trigger) | ‚ùå ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ embedding ‡πÄ‡∏Å‡πà‡∏≤ |
| ‡∏£‡∏±‡∏ô update script | ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (trigger) | ‚úÖ embedding ‡πÉ‡∏´‡∏°‡πà |

### Script Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà

```
scripts/update_<‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤>.py
  - product_data = { ... }        # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å field
  - embedding_text = "..."         # ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á embedding
  - generate_embedding()           # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OpenAI
  - supabase.update() / insert()   # Push ‡∏Ç‡∏∂‡πâ‡∏ô DB
  - verify                         # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
```

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: `scripts/update_artemis.py`
